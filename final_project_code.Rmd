---
title: "final_project_code"
author: "Eimear Loughlin"
date: "2024-04-25"
output: html_document
---

```{r Setup}

# clear environment 
rm(list=ls())

# set working directory 
setwd("C:/Users/User/OneDrive - Imperial College London/Documents/Masters/Project")

# load packages
library(pez)
library(tidyr)
library(dplyr)
library(stringr)
library(diverse)
library(vegan)
library(adespatial)
library(ggplot2)
library(FD)
library(gridExtra)
library(ggfortify)
library(vegan)
library(tibble)
library(rtry)
library(BIEN)
library(factoextra)
library(lme4)
library(lmtest)
library(FactoMineR)
library(factoextra)
library(data.table)
library(caret)
library(car)
library(mice)
library(dunn.test)
library(MuMIn)
library(multcomp)
library(cowplot)
library(gridExtra)
library(emmeans)
library(viridis)
library(sjPlot)
library(maps)
library(mapdata)
library(ggplot2)
library(sf)

```

```{r Loading datasets}

# load tree
tree <- read.tree("ecofrac-rawdata/Vascular_Plants_rooted.dated.tre")

# knepp 2022
knepp_2022 <- read.csv("ecofrac-rawdata/knepp-plant-datasheet_csv_2022.csv", header=T)

# 2023
knepp_2023 <- read.csv("ecofrac-rawdata/Knepp_2023.csv", header=T)

# 2024
knepp_2024 <- read.csv("ecofrac-rawdata/knepp_2024.csv", header=T)
knepp_2024 <- knepp_2024 %>%
  mutate(Site = "Knepp")

# my plots knepp
unique(knepp_2024$Plot)

# boothby 2022
boothby_2022 <- read.csv("ecofrac-rawdata/boothby-plant-datasheet_csv_2022.csv", header=T)

# 2023
boothby_2023 <- read.csv("ecofrac-rawdata/Boothby_2023.csv", header=T)

# 2024
boothby_2024 <- read.csv("ecofrac-rawdata/Boothby_2024.csv", header=T)

# my plots boothby
boothby_mine <- boothby_2024 %>%
  slice(1301:n())

unique(boothby_mine$Plot)

# budworth 2021
budworth_2021 <- read.csv("ecofrac-rawdata/brearley_EcoFrac_2021_csv.csv", header = T)

# Silwood 2021
silwood_2021 <- read.csv("ecofrac-rawdata/silwood-cover-2021.csv", header = T)

# 2022
silwood_2022 <- read.csv("ecofrac-rawdata/silwood_2022.csv", header = T)

# 2023
silwood_2023 <- read.csv("ecofrac-rawdata/Silwood_2023.csv", header = T)

# Harold's Park Farm 2024
hpf_2024 <- read.csv("ecofrac-rawdata/HPF.csv")
hpf_2024$site <- "HPF"  # Set 'HPF' for all rows in the 'site' column
hpf_2024$block <- gsub("^HPF ", "", hpf_2024$Site)
hpf_2024 <- hpf_2024[, -which(names(hpf_2024) == "Site")]
hpf_2024 <- hpf_2024 %>%
  rename(Site = site)

# Hepple 2024
hep_2024 <- read.csv("ecofrac-rawdata/Hepple.csv")

# my plots hepple
hepple_mine <- hep_2024 %>%
  slice(897:n())

unique(hepple_mine$Plot)

# High Fen 2024
high_fen <- read.csv("ecofrac-rawdata/High_fen.csv")
```

```{r Cleaning Knepp 2022}

# join block and group
knepp_2022 <- knepp_2022 %>%
  mutate(Block = paste(Block, Group))

# set block names so they match that of knepp, and NA where there is no block data recorded
knepp_2022 <- knepp_2022 %>%
  mutate(Block = case_when(
    Block == "S X" ~ "SX",
    Block == "M NA" ~ "M",
    Block == "N NA" ~ "N",
    Block == "S Y" ~ "SY",
    Block == "S Z" ~ "SZ",
    Block == " " ~ NA_character_,
    TRUE ~ Block
  )) %>%
  filter(!is.na(Block))

# change latin letters to regular letters                           
knepp_2022$Species <- stringi::stri_trans_general(knepp_2022$Species, "latin-ascii")

# remove blank spaces at the start and end of species names 
knepp_2022 <- knepp_2022 %>%
 mutate(Species = str_trim(Species))

# but underscore in between genus and species name 
knepp_2022$Species <- gsub(" ", "_", knepp_2022$Species, fixed=TRUE)

# replace NA values with 0
knepp_2022[is.na(knepp_2022)] <- 0

# format and remove rows that contain * and blank spaces
knepp_2022 <- subset(knepp_2022, !grepl('^333\\*', Plot))
knepp_2022 <- subset(knepp_2022, !grepl('^122\\*', Plot))
knepp_2022 <- subset(knepp_2022, !grepl('^133\\*', Plot))
knepp_2022 <- subset(knepp_2022, !grepl('^222\\*', Plot))
knepp_2022 <- subset(knepp_2022, !grepl('^333\\*', Plot))
knepp_2022 <- knepp_2022[knepp_2022$Plot != "", ]

# make phylogenetic tree of species in knepp data using Zanne et al phylogeny
ktree2022 <- congeneric.merge(tree, unique(knepp_2022$Species))

# format for pez etc.
# rearrange so each specific block, group, plot combination is its own row, species is column, and value is mean species cover at each specific location
k.comm2022 <- with(knepp_2022, tapply(Cover, list(paste(Site,Block,Plot), Species), mean, rm.na=TRUE))

# replace NA values with 0
k.comm2022[is.na(k.comm2022)] <- 0

# create comparative community 
k.c.data2022 <- comparative.comm(ktree2022, k.comm2022)
# this still has cover of animal droppings etc 

# subset knepp to remove recorded species that are not species, like "soil", "sticks" etc., and save this 
k_wanted_spp <- species(k.c.data2022)
knepp_2022_clean <- subset(knepp_2022, Species %in% k_wanted_spp)
unique(knepp_2022_clean$Species)

# change species names that have other common names to retrieve trait data from BIEN and try 
knepp_2022_clean$Species <- gsub("Circaea_lutetiansa", "Circaea_lutetiana", knepp_2022_clean$Species)
knepp_2022_clean$Species <- gsub("Lotus_pendunculatus", "Lotus_pedunculatus", knepp_2022_clean$Species)

# save this data and load
write.csv(knepp_2022_clean, file = "clean_data/knepp_2022_clean.csv", row.names=F)
knepp_2022_clean <- read.csv("clean_data/knepp_2022_clean.csv")


# make hierarchical groupings for each site
# split site names 
raw.groups <- strsplit(sites(k.c.data2022), " ")

# extract site number
site.no <- sapply(raw.groups, function(x) x[4])

# creates a data frame with columns for block (second part of split name), fractal (third part), major (first character of site no), minor (second character of site no)
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

# R is seeing "NA" and making it NA so change to A 
env$fractal[env$fractal=="NA"] <- "A" 

# make row names the site names from k.c.data
rownames(env) <- sites(k.c.data2022)

# save as csv 
write.csv(env, file = "clean_data/knepp2022env.csv", row.names = F)

# manually tell R which sites belong to which fractal
env$X <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0)
env$Y <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,1,0)
env$Z <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,1,1,1,1)

# merge in a comparative.comm dataset and save 
k.c.data2022 <- comparative.comm(tree(k.c.data2022), comm(k.c.data2022), env=env)
saveRDS(k.c.data2022, "clean_data/k.c.data2022.RDS")
```

```{r Cleaning Knepp 2023}

# repeating all of the above for Knepp 2023 and rest of sites
knepp_2023$Species <- stringi::stri_trans_general(knepp_2023$Species, "latin-ascii")
knepp_2023 <- knepp_2023 %>%
 mutate(Species = str_trim(Species))
knepp_2023$Species <- gsub(" ", "_", knepp_2023$Species, fixed=TRUE)
knepp_2023[is.na(knepp_2023)] <- 0

knepp_2023 <- subset(knepp_2023, !grepl('^333\\*', Plot))
knepp_2023 <- subset(knepp_2023, !grepl('^122\\*', Plot))
knepp_2023 <- subset(knepp_2023, !grepl('^133\\*', Plot))
knepp_2023 <- subset(knepp_2023, !grepl('^222\\*', Plot))
knepp_2023 <- subset(knepp_2023, !grepl('^333\\*', Plot))
knepp_2023 <- knepp_2023[knepp_2023$Plot != "", ]

ktree2023 <- congeneric.merge(tree, unique(knepp_2023$Species))

# split plot into numeric and character
knepp_2023 <- knepp_2023 %>%
  mutate(Plot_character = gsub("[0-9]", "", Plot),
         Plot_numeric = gsub("[^0-9]", "", Plot))

# Remove the original plot column
knepp_2023 <- knepp_2023 %>%
  select(-Plot)

# rename plot_character to block
knepp_2023 <- knepp_2023 %>%
  rename(Block = Plot_character)

# rename plot_numeric to plot 
knepp_2023 <- knepp_2023 %>%
  rename(Plot = Plot_numeric)

k.comm2023 <- with(knepp_2023, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
k.comm2023[is.na(k.comm2023)] <- 0
k.c.data2023 <- comparative.comm(ktree2023, k.comm2023)

k_wanted_spp <- species(k.c.data2023)
knepp_2023_clean <- subset(knepp_2023, Species %in% k_wanted_spp)
knepp_2023_clean$Species <- gsub("Geranium_robertianium", "Geranium_robertianum", knepp_2023_clean$Species)
knepp_2023_clean$Species <-gsub("Avenella_flexuosa", "Deschampsia_flexuosa", knepp_2023_clean$Species)

write.csv(knepp_2023_clean, file = "clean_data/knepp_2023_clean.csv", row.names=F)

knepp_2023_clean <- read.csv("clean_data/knepp_2023_clean.csv")

raw.groups <- strsplit(sites(k.c.data2023), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 

rownames(env) <- sites(k.c.data2023)

write.csv(env, file = "clean_data/knepp2023env.csv", row.names = F)
k.c.data2023 <- comparative.comm(tree(k.c.data2023), comm(k.c.data2023), env=env)
saveRDS(k.c.data2023, "clean_data/k.c.data2023.RDS")
```

```{r Cleaning Knepp 2024}

# repeating for knepp 2024 
knepp_2024$Species <- stringi::stri_trans_general(knepp_2024$Species, "latin-ascii")
knepp_2024 <- knepp_2024 %>%
 mutate(Species = str_trim(Species))
knepp_2024$Species <- gsub(" ", "_", knepp_2024$Species, fixed=TRUE)
knepp_2024[is.na(knepp_2024)] <- 0

ktree2024 <- congeneric.merge(tree, unique(knepp_2024$Species))

knepp_2024 <- knepp_2024 %>%
  mutate(Plot_character = gsub("[0-9]", "", Plot),
         Plot_numeric = gsub("[^0-9]", "", Plot))

knepp_2024 <- knepp_2024 %>%
  select(-Plot)

knepp_2024 <- knepp_2024 %>%
  rename(Block = Plot_character)

knepp_2024 <- knepp_2024 %>%
  rename(Plot = Plot_numeric)

k.comm2024 <- with(knepp_2024, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
k.comm2024[is.na(k.comm2024)] <- 0
k.c.data2024 <- comparative.comm(ktree2024, k.comm2024)

k_wanted_spp <- species(k.c.data2024)
knepp_2024_clean <- subset(knepp_2024, Species %in% k_wanted_spp)
knepp_2024_clean$Species <- gsub("Geranium_disectum", "Geranium_dissectum", knepp_2024_clean$Species)
knepp_2024_clean$Species <- gsub("Jacobaea_aquatica", "Senecio_aquaticus", knepp_2024_clean$Species)
knepp_2024_clean$Species <- gsub("Taraxacum_officinale_\\(L\\.\\)", "Taraxacum_officinale", knepp_2024_clean$Species)
knepp_2024_clean$Species <- gsub("Taraxacum_offinale", "Taraxacum_officinale", knepp_2024_clean$Species)
knepp_2024_clean$Species <- gsub("Jacobaea_erucifolia", "Senecio_erucifolius", knepp_2024_clean$Species)
knepp_2024_clean$Species <- gsub("Prunus_Spinosa", "Prunus spinosa", knepp_2024_clean$Species)

write.csv(knepp_2024_clean, file = "clean_data/knepp_2024_clean.csv", row.names=F)

knepp_2024_clean <- read.csv("clean_data/knepp_2024_clean.csv")

raw.groups <- strsplit(sites(k.c.data2024), " ")
site.no <- sapply(raw.groups, function(x) x[4])

env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 

rownames(env) <- sites(k.c.data2024)

write.csv(env, file = "clean_data/knepp2024env.csv", row.names = F)
k.c.data2024 <- comparative.comm(tree(k.c.data2024), comm(k.c.data2024), env=env)
saveRDS(k.c.data2024, "clean_data/k.c.data2024.RDS")
```

```{r Cleaning Boothby 2022}

boothby_2022$Species <- stringi::stri_trans_general(boothby_2022$Species, "latin-ascii")
boothby_2022 <- boothby_2022 %>%
  mutate(Species = str_trim(Species))
boothby_2022$Species <-gsub(" ", "_", boothby_2022$Species, fixed=TRUE)
boothby_2022[is.na(boothby_2022)] <- 0

boothby_2022 <- subset(boothby_2022, !grepl('^333\\*', Plot))
boothby_2022 <- subset(boothby_2022, !grepl('^122\\*', Plot))
boothby_2022 <- subset(boothby_2022, !grepl('^133\\*', Plot))
boothby_2022 <- subset(boothby_2022, !grepl('^222\\*', Plot))
boothby_2022 <- subset(boothby_2022, !grepl('^333\\*', Plot))
boothby_2022 <- subset(boothby_2022, !grepl('^321\\*', Plot))

boothby_2022 <- boothby_2022[boothby_2022$Plot != "", ]

btree2022 <- congeneric.merge(tree, unique(boothby_2022$Species))

b.comm2022 <- with(boothby_2022, tapply(Cover, list(paste(Site,Block,Plot), Species), mean, rm.na=TRUE))
b.comm2022[is.na(b.comm2022)] <- 0
b.c.data2022 <- comparative.comm(btree2022, b.comm2022)

b_wanted_spp <- species(b.c.data2022)
boothby_2022_clean <- subset(boothby_2022, Species %in% b_wanted_spp)
boothby_2022_clean$Species <- gsub("Prunus_spinosa\\?", "Prunus_spinosa", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Rubus_fructicosus", "Rubus_fruticosus", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Rubus_sp\\?", "Rubus_sp", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Succisa_pratensid", "Succisa_pratensis", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Vicia_tetraspermae", "Vicia_tetrasperma", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Fallopia_convolvulvus", "Fallopia_convolvulus", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Vicia_fava", "Vicia_faba", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Deschampsia_caespitosa", "Deschampsia_cespitosa", boothby_2022_clean$Species)
boothby_2022_clean$Species <- gsub("Lotus_glaber", "Lotus_tenuis", boothby_2022_clean$Species)


write.csv(boothby_2022_clean, file = "clean_data/boothby_2022_clean.csv", row.names = F)
boothby_2022_clean <- read.csv("clean_data/boothby_2022_clean.csv")

raw.groups <- strsplit(sites(b.c.data2022), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(b.c.data2022)
write.csv(env, file = "clean_data/boothby2022env.csv", row.names = F)

b.c.data2022 <- comparative.comm(tree(b.c.data2022), comm(b.c.data2022), env=env)
saveRDS(b.c.data2022, "clean_data/b.c.data2022.RDS")
```

```{r Cleaning Boothby 2023}

boothby_2023$Species <- stringi::stri_trans_general(boothby_2023$Species, "latin-ascii")
boothby_2023 <- boothby_2023 %>%
  mutate(Species = str_trim(Species))
boothby_2023$Species <-gsub(" ", "_", boothby_2023$Species, fixed=TRUE)
boothby_2023[is.na(boothby_2023)] <- 0

boothby_2023 <- subset(boothby_2023, !grepl('^333\\*', Plot))
boothby_2023 <- subset(boothby_2023, !grepl('^122\\*', Plot))
boothby_2023 <- subset(boothby_2023, !grepl('^133\\*', Plot))
boothby_2023 <- subset(boothby_2023, !grepl('^222\\*', Plot))
boothby_2023 <- subset(boothby_2023, !grepl('^333\\*', Plot))
boothby_2023 <- subset(boothby_2023, !grepl('^321\\*', Plot))

btree2023 <- congeneric.merge(tree, unique(boothby_2023$Species))

# filter rows where 'plot' is 0
plot_zero_rows <- boothby_2023[boothby_2023$Plot == 0, ]
print(plot_zero_rows)

split_plot <- function(plot) {
 plot_character <- gsub("[0-9]", "", plot)
  plot_numeric <- gsub("[^0-9]", "", plot)
 return(list(plot_character = plot_character, plot_numeric = plot_numeric))
}

plot_split <- lapply(boothby_2023$Plot, split_plot)

boothby_2023$Block <- sapply(plot_split, function(x) x$plot_character)
boothby_2023$Plot <- sapply(plot_split, function(x) x$plot_numeric)

boothby_2023$Plot <- as.numeric(boothby_2023$Plot)

b.comm2023 <- with(boothby_2023, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
b.comm2023[is.na(b.comm2023)] <- 0
b.c.data2023 <- comparative.comm(btree2023, b.comm2023)

b_wanted_spp <- species(b.c.data2023)
boothby_2023_clean <- subset(boothby_2023, Species %in% b_wanted_spp)
boothby_2023_clean$Species <- gsub("Geranium_robertianium", "Geranium_robertianum", boothby_2023_clean$Species)
boothby_2023_clean$Species <- gsub("Hieracium_sp.", "Hieracium_sp", boothby_2023_clean$Species)
boothby_2023_clean$Species <- gsub("Festuca_myuros", "Vulpia_myuros", boothby_2023_clean$Species)
boothby_2023_clean$Species <- gsub("Helminthotheca_echioides", "Picris_echioides", boothby_2023_clean$Species)


write.csv(boothby_2023_clean, file = "clean_data/boothby_2023_clean.csv", row.names = F)
boothby_2023_clean <- read.csv("clean_data/boothby_2023_clean.csv")

raw.groups <- strsplit(sites(b.c.data2023), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(b.c.data2023)
write.csv(env, file = "clean_data/boothby2023env.csv", row.names = F)

b.c.data2023 <- comparative.comm(tree(b.c.data2023), comm(b.c.data2023), env=env)
saveRDS(b.c.data2023, "clean_data/b.c.data2023.RDS")
```

```{r Cleaning Boothby 2024}

boothby_2024$Species <- stringi::stri_trans_general(boothby_2024$Species, "latin-ascii")
boothby_2024 <- boothby_2024 %>%
  mutate(Species = str_trim(Species))
boothby_2024$Species <-gsub(" ", "_", boothby_2024$Species, fixed=TRUE)
boothby_2024[is.na(boothby_2024)] <- 0

btree2024 <- congeneric.merge(tree, unique(boothby_2024$Species))

split_plot <- function(plot) {
  plot_character <- gsub("[0-9]", "", plot)
  plot_numeric <- gsub("[^0-9]", "", plot)
  return(list(plot_character = plot_character, plot_numeric = plot_numeric))
}

plot_split <- lapply(boothby_2024$Plot, split_plot)

boothby_2024$Block <- sapply(plot_split, function(x) x$plot_character)
boothby_2024$Plot <- sapply(plot_split, function(x) x$plot_numeric)

boothby_2024$Plot <- as.numeric(boothby_2024$Plot)

b.comm2024 <- with(boothby_2024, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
b.comm2024[is.na(b.comm2024)] <- 0
b.c.data2024 <- comparative.comm(btree2024, b.comm2024)

b_wanted_spp <- species(b.c.data2024)
boothby_2024_clean <- subset(boothby_2024, Species %in% b_wanted_spp)
boothby_2024_clean$Species <- gsub("Centaurea_nigrescenes", "Centaurea_nigrescens", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Epilobium_Parviflorum", "Epilobium_parviflorum", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Helminthotheca_echiodes", "Helminthotheca_echioides", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Jacobaea_eruciflora", "Senecio_erucifolius", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Pinus_spp", "Pinus_spp.", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Quercus_Robur", "Quercus_robur", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Rosa_multiflore", "Rosa_multiflora", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Carex actiformis", "Carex_acutiformis", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Achillea_nobilis", "Achillea_ptarmica", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Helminthotheca_echioides", "Picris_echioides", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Lamium_galeobdolon", "Lamiastrum_galeobdolon", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Packera_aurea", "Senecio_aureus", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Carex_actiformis", "Carex_acutiformis", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Carex_actiformis", "Carex_acutiformis", boothby_2024_clean$Species)
boothby_2024_clean$Species <- gsub("Lolium_arundinaceum","Festuca_arundinacea", boothby_2024_clean$Species)

write.csv(boothby_2024_clean, file = "clean_data/boothby_2024_clean.csv", row.names = F)
boothby_2024_clean <- read.csv("clean_data/boothby_2024_clean.csv")

raw.groups <- strsplit(sites(b.c.data2024), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(b.c.data2024)
write.csv(env, file = "clean_data/boothby2024env.csv", row.names = F)

b.c.data2024 <- comparative.comm(tree(b.c.data2024), comm(b.c.data2024), env=env)
saveRDS(b.c.data2024, "clean_data/b.c.data2024.RDS")
```

```{r Cleaning Budworth}

budworth_2021$Species <- stringi::stri_trans_general(budworth_2021$Species, "latin-ascii")
budworth_2021 <- budworth_2021 %>%
  mutate(Species = str_trim(Species))
budworth_2021$Species <-gsub(" ", "_", budworth_2021$Species, fixed=TRUE)
budworth_2021[is.na(budworth_2021)] <- 0

unique(budworth_2021$Plot)
unique(budworth_2021$Species)

brtree2021 <- congeneric.merge(tree, unique(budworth_2021$Species))

br.comm2021 <- with(budworth_2021, tapply(Cover, list(paste(Site,Plot), Species), mean, rm.na=TRUE))
br.comm2021[is.na(br.comm2021)] <- 0
br.c.data2021 <- comparative.comm(brtree2021, br.comm2021)

br_wanted_spp <- species(br.c.data2021)
budworth_2021_clean <- subset(budworth_2021, Species %in% br_wanted_spp)
budworth_2021_clean$Species <- gsub("Sorbus_acuparia", "Sorbus_aucuparia", budworth_2021_clean$Species)
budworth_2021_clean$Species <- gsub("Rubus_fruticosus_agg.", "Rubus_fruticosus", budworth_2021_clean$Species)

write.csv(budworth_2021_clean, file = "clean_data/budworth_2021_clean.csv", row.names = F)
budworth_2021_clean <- read.csv("clean_data/budworth_2021_clean.csv")

raw.groups <- strsplit(sites(br.c.data2021), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(br.c.data2021)
write.csv(env, file = "clean_data/budworth2021env.csv", row.names = F)

br.c.data2021 <- comparative.comm(tree(br.c.data2021), comm(br.c.data2021), env=env)
saveRDS(br.c.data2021, "clean_data/br.c.data2021.RDS")
```

```{r Cleaning Silwood 2021}

silwood_2021$Species <- stringi::stri_trans_general(silwood_2021$Species, "latin-ascii")
silwood_2021 <- silwood_2021 %>%
  mutate(Species = str_trim(Species))
silwood_2021$Species <-gsub(" ", "_", silwood_2021$Species, fixed=TRUE)
silwood_2021[is.na(silwood_2021)] <- 0
silwood_2021 <- silwood_2021 %>%
  rename(Plot = Site)

silwood_2021 <- silwood_2021 %>%
  mutate(Site = "Silwood_Park")

stree2021 <- congeneric.merge(tree, unique(silwood_2021$Species))

s.comm2021 <- with(silwood_2021, tapply(Cover, list(paste(Plot), Species), mean, rm.na=TRUE))
s.comm2021[is.na(s.comm2021)] <- 0
s.c.data2021 <- comparative.comm(stree2021, s.comm2021)

s_wanted_spp <- species(s.c.data2021)
silwood_2021_clean <- subset(silwood_2021, Species %in% s_wanted_spp)
silwood_2021_clean$Species <- gsub("Hyacinthoides_x_massartiana", "Hyacinthoides_hispanica", silwood_2021_clean$Species)

write.csv(silwood_2021_clean, file = "clean_data/silwood_2021_clean.csv", row.names = F)
silwood_2021_clean <- read.csv("clean_data/silwood_2021_clean.csv")

raw.groups <- strsplit(sites(s.c.data2021), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(s.c.data2021)
write.csv(env, file = "clean_data/silwood2021env.csv", row.names = F)

s.c.data2021 <- comparative.comm(tree(s.c.data2021), comm(s.c.data2021), env=env)
saveRDS(s.c.data2021, "clean_data/s.c.data2021.RDS")
```

```{r Cleaning Silwood 2022}

silwood_2022$Species <- stringi::stri_trans_general(silwood_2022$Species, "latin-ascii")
silwood_2022 <- silwood_2022 %>%
  mutate(Species = str_trim(Species))
silwood_2022$Species <-gsub(" ", "_", silwood_2022$Species, fixed=TRUE)
silwood_2022[is.na(silwood_2022)] <- 0
silwood_2022$Site <- str_trim(silwood_2022$Site)
silwood_2022$Site[silwood_2022$Site=="Silwood Park"] <- "Silwood_Park"

# remove empty plots 
entries_to_remove <- c("")
silwood_2022 <- silwood_2022 %>%
  filter(!Plot %in% entries_to_remove)

unique(silwood_2022$Species)

silwood_2022$Species <- str_replace(silwood_2022$Species, "_+$", "")

stree2022 <- congeneric.merge(tree, unique(silwood_2022$Species))

s.comm2022 <- with(silwood_2022, tapply(Cover, list(paste(Site, Plot), Species), mean, rm.na=TRUE))
s.comm2022[is.na(s.comm2022)] <- 0
s.c.data2022 <- comparative.comm(stree2022, s.comm2022)

s_wanted_spp2 <- species(s.c.data2022)
silwood_2022_clean <- subset(silwood_2022, Species %in% s_wanted_spp2)
silwood_2022_clean$Species <- gsub("Angelica_silvestris", "Angelica_sylvestris", silwood_2022_clean$Species)
silwood_2022_clean$Species <- gsub("Holcus_molis", "Holcus_mollis", silwood_2022_clean$Species)
silwood_2022_clean$Species <- gsub("Poa_trivalis", "Poa_trivialis", silwood_2022_clean$Species)
silwood_2022_clean$Species <- gsub("Rubus_pruinosus", "Rubus_fruticosus", silwood_2022_clean$Species)
write.csv(silwood_2022_clean, file = "clean_data/silwood_2022_clean.csv", row.names = F)
silwood_2022_clean <- read.csv("clean_data/silwood_2022_clean.csv")

raw.groups <- strsplit(sites(s.c.data2022), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(s.c.data2022)
write.csv(env, file = "clean_data/silwood2022env.csv", row.names = F)

s.c.data2022 <- comparative.comm(tree(s.c.data2022), comm(s.c.data2022), env=env)
saveRDS(s.c.data2022, "clean_data/s.c.data2022.RDS")
```

```{r Cleaning Silwood 2023}

silwood_2023$Species <- stringi::stri_trans_general(silwood_2023$Species, "latin-ascii")
silwood_2023 <- silwood_2023 %>%
  mutate(Species = str_trim(Species))
silwood_2023$Species <-gsub(" ", "_", silwood_2023$Species, fixed=TRUE)
silwood_2023[is.na(silwood_2023)] <- 0
silwood_2023$Site <- str_trim(silwood_2023$Site)
silwood_2023$Site[silwood_2023$Site=="Silwood Park"] <- "Silwood_Park"

silwood_2023$Species <- str_replace(silwood_2023$Species, "_+$", "")

stree2023 <- congeneric.merge(tree, unique(silwood_2023$Species))

s.comm2023 <- with(silwood_2023, tapply(Cover, list(paste(Site, Plot), Species), mean, rm.na=TRUE))
s.comm2023[is.na(s.comm2023)] <- 0
s.c.data2023 <- comparative.comm(stree2023, s.comm2023)

s_wanted_spp2 <- species(s.c.data2023)
silwood_2023_clean <- subset(silwood_2023, Species %in% s_wanted_spp2)
silwood_2023_clean$Species <- gsub("Poa_Annua", "Poa_annua", silwood_2023_clean$Species)
silwood_2023_clean$Species <- gsub("Luzula_Campestris", "Luzula campestris", silwood_2023_clean$Species)

write.csv(silwood_2023_clean, file = "clean_data/silwood_2023_clean.csv", row.names = F)
silwood_2023_clean <- read.csv("clean_data/silwood_2023_clean.csv")

raw.groups <- strsplit(sites(s.c.data2023), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(s.c.data2023)
write.csv(env, file = "clean_data/silwood2023env.csv", row.names = F)

s.c.data2023 <- comparative.comm(tree(s.c.data2023), comm(s.c.data2023), env=env)
saveRDS(s.c.data2023, "clean_data/s.c.data2023.RDS")

```

```{r Cleaning Harold's Park Farm 2024}

hpf_2024$Species <- stringi::stri_trans_general(hpf_2024$Species, "latin-ascii")
hpf_2024 <- hpf_2024 %>%
  mutate(Species = str_trim(Species))
hpf_2024$Species <-gsub(" ", "_", hpf_2024$Species, fixed=TRUE)
hpf_2024[is.na(hpf_2024)] <- 0

hpftree2024 <- congeneric.merge(tree, unique(hpf_2024$Species))
hpf_2024 <- hpf_2024 %>%
  rename(Block = block)
hpf.comm2024 <- with(hpf_2024, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
hpf.comm2024[is.na(hpf.comm2024)] <- 0
hpf.c.data2024 <- comparative.comm(hpftree2024, hpf.comm2024)

hpf_wanted_spp <- species(hpf.c.data2024)
hpf_2024_clean <- subset(hpf_2024, Species %in% hpf_wanted_spp)
hpf_2024_clean$Species <-gsub("Agrostis_capollaris", "Agrostis_capillaris
", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Alopecurus_myosuroides_Huds.", "Alopecurus_myosuroides", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Heracleum_sphypndylium", "Heracleum_sphondylium", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Lepidium_didyum", "Lepidium_didymum", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Picea_Rubens", "Picea_rubens", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Succisa_preatensis", "Succisa_pratensis", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Agrostis_capillaris\n", "Agrostis_capillaris", hpf_2024_clean$Species)
hpf_2024_clean$Species <- gsub("Anthriscus_sylvestris_\\(L\\.\\)_Hoffm\\.", "Anthriscus_sylvestris", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Cerastium_fontanum_Baumg.", "Cerastium_fontanum", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Epilobium_alsinifolium_Vill.", "Epilobium_alsinifolium", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Epilobium_ciliatum_Raf.", "Epilobium_ciliatum", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Epilobium_tetragonum_L.", "Epilobium_tetragonum", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Rumex_acetosa_L.", "Rumex_acetosa", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Triticum_aestivum_L.", "Triticum_aestivum", hpf_2024_clean$Species)
hpf_2024_clean$Species <-gsub("Vicia_lathyroides_L.", "Vicia_lathyroides", hpf_2024_clean$Species)


write.csv(hpf_2024_clean, file = "clean_data/hpf_2024_clean.csv", row.names = F)
hpf_2024_clean <- read.csv("clean_data/hpf_2024_clean.csv")

raw.groups <- strsplit(sites(hpf.c.data2024), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(hpf.c.data2024)
write.csv(env, file = "clean_data/hpf2024env.csv", row.names = F)

hpf.c.data2024 <- comparative.comm(tree(hpf.c.data2024), comm(hpf.c.data2024), env=env)
saveRDS(hpf.c.data2024, "clean_data/hpf.c.data2024.RDS")
```

```{r Cleaning Hepple}

hep_2024$Species <- stringi::stri_trans_general(hep_2024$Species, "latin-ascii")
hep_2024 <- hep_2024 %>%
  mutate(Species = str_trim(Species))
hep_2024$Species <-gsub(" ", "_", hep_2024$Species, fixed=TRUE)
hep_2024[is.na(hep_2024)] <- 0

heptree2024 <- congeneric.merge(tree, unique(hep_2024$Species))
hep_2024 <- hep_2024[hep_2024$Plot != "", ]

hep_2024$Block <- substr(hep_2024$Plot, 1, 1)
hep_2024$NumericPlot <- as.numeric(substr(hep_2024$Plot, 2, nchar(hep_2024$Plot)))

hep_2024$Plot <- NULL
hep_2024$Site <- gsub("Hepple ", "Hepple", hep_2024$Site, fixed = TRUE)

names(hep_2024)[names(hep_2024) == "NumericPlot"] <- "Plot"

head(hep_2024)

hep.comm2024 <- with(hep_2024, tapply(Cover, list(paste(Site,Block, Plot), Species), mean, rm.na=TRUE))
hep.comm2024[is.na(hep.comm2024)] <- 0
hep.c.data2024 <- comparative.comm(heptree2024, hep.comm2024)

hep_wanted_spp <- species(hep.c.data2024)
hep_2024_clean <- subset(hep_2024, Species %in% hep_wanted_spp)
hep_2024_clean$Species <-gsub("Carex_Lepidocarpa", "Carex_lepidocarpa", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Holcus_ianatus", "Holcus_lanatus", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Holcus_Mollis", "Holcus_mollis", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Juncus_articulartus", "Juncus_articulatus", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Juncus_squarosis", "Juncus_squarrosus", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Molinia_Caerulea", "Molinia_caerulea", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Phleum_bertoloni", "Phleum_bertolonii", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Plantago_lancculata", "Plantago_lanceolata", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Poa_pretensis", "Poa_pratensis", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Rumex_acestosa", "Rumex_acetosa", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Avenella_flexuosa", "Deschampsia_flexuosa", hep_2024_clean$Species)
hep_2024_clean$Species <-gsub("Dichondra_micantha", "Dichondra_repens", hep_2024_clean$Species)

write.csv(hep_2024_clean, file = "clean_data/hep_2024_clean.csv", row.names = F)
hep_2024_clean <- read.csv("clean_data/hep_2024_clean.csv")

raw.groups <- strsplit(sites(hep.c.data2024), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(hep.c.data2024)
write.csv(env, file = "clean_data/hep2024env.csv", row.names = F)

hep.c.data2024 <- comparative.comm(tree(hep.c.data2024), comm(hep.c.data2024), env=env)
saveRDS(hep.c.data2024, "clean_data/hep.c.data2024.RDS")
```

```{r Cleaning High Fen}

high_fen$Species <- stringi::stri_trans_general(high_fen$Species, "latin-ascii")
high_fen <- high_fen %>%
  mutate(Species = str_trim(Species))
high_fen$Species <- gsub(" ", "_", high_fen$Species, fixed=TRUE)
high_fen[is.na(high_fen)] <- 0

high_fentree <- congeneric.merge(tree, unique(high_fen$Species))
high_fen <- high_fen[high_fen$Plot != "", ]

high_fen$Site <- gsub("High fen", "High_fen", high_fen$Site, fixed = TRUE)

high_fen.comm <- with(high_fen, tapply(Cover, list(paste(Site, Plot), Species), mean, rm.na=TRUE))
high_fen.comm[is.na(high_fen.comm)] <- 0
high_fen.c.data <- comparative.comm(high_fentree, high_fen.comm)

high_fen_wanted_spp <- species(high_fen.c.data)
high_fen_clean <- subset(high_fen, Species %in% high_fen_wanted_spp)

write.csv(high_fen_clean, file = "clean_data/high_fen_clean.csv", row.names = F)
high_fen_clean <- read.csv("clean_data/high_fen_clean.csv")

raw.groups <- strsplit(sites(high_fen.c.data), " ")
site.no <- sapply(raw.groups, function(x) x[4])
env <- data.frame(
  block = sapply(raw.groups, function(x) x[2]),
  fractal = sapply(raw.groups, function(x) x[3]),
  major = substr(site.no, 0, 1),
  minor = substr(site.no, 2, 2)
)

env$fractal[env$fractal=="NA"] <- "A" 
rownames(env) <- sites(high_fen.c.data)
write.csv(env, file = "clean_data/highfenenv.csv", row.names = F)

high_fen.c.data <- comparative.comm(tree(high_fen.c.data), comm(high_fen.c.data), env=env)
saveRDS(high_fen.c.data, "clean_data/high_fen.c.data.RDS")
```

```{r Loading clean data}

knepp_2022_clean <- read.csv("clean_data/knepp_2022_clean.csv")
k.c.data2022 <- readRDS("clean_data/k.c.data2022.RDS")

knepp_2023_clean <- read.csv("clean_data/knepp_2023_clean.csv")
k.c.data2023 <- readRDS("clean_data/k.c.data2023.RDS")

knepp_2024_clean <- read.csv("clean_data/knepp_2024_clean.csv")
k.c.data2024 <- readRDS("clean_data/k.c.data2024.RDS")

boothby_2022_clean <- read.csv("clean_data/boothby_2022_clean.csv")
b.c.data2022 <- readRDS("clean_data/b.c.data2022.RDS")

boothby_2023_clean <- read.csv("clean_data/boothby_2023_clean.csv")
b.c.data2023 <- readRDS("clean_data/b.c.data2023.RDS")

boothby_2024_clean <- read.csv("clean_data/boothby_2024_clean.csv")
b.c.data2024 <- readRDS("clean_data/b.c.data2024.RDS")

budworth_2021_clean <- read.csv("clean_data/budworth_2021_clean.csv")
br.c.data2021 <- readRDS("clean_data/br.c.data2021.RDS")

silwood_2021_clean <- read.csv("clean_data/silwood_2021_clean.csv")
s.c.data2021 <- readRDS("clean_data/s.c.data2021.RDS")

silwood_2022_clean <- read.csv("clean_data/silwood_2022_clean.csv")
s.c.data2022 <- readRDS("clean_data/s.c.data2022.RDS")

silwood_2023_clean <- read.csv("clean_data/silwood_2023_clean.csv")
s.c.data2023 <- readRDS("clean_data/s.c.data2023.RDS")

hpf_2024_clean <- read.csv("clean_data/hpf_2024_clean.csv")
hpf.c.data2024 <- readRDS("clean_data/hpf.c.data2024.RDS")

hep_2024_clean <- read.csv("clean_data/hep_2024_clean.csv")
hep.c.data2024 <- readRDS("clean_data/hep.c.data2024.RDS")

high_fen_clean <- read.csv("clean_data/high_fen_clean.csv")
high_fen.c.data <- readRDS("clean_data/high_fen.c.data.RDS")

# Select the Species column
knepp_2022_species <- knepp_2022_clean %>% dplyr::select(Species)
knepp_2023_species <- knepp_2023_clean %>% dplyr::select(Species)
knepp_2024_species <- knepp_2024_clean %>% dplyr::select(Species)

boothby_2022_species <- boothby_2022_clean %>% dplyr::select(Species)
boothby_2023_species <- boothby_2023_clean %>% dplyr::select(Species)
boothby_2024_species <- boothby_2024_clean %>% dplyr::select(Species)

budworth_2021_species <- budworth_2021_clean %>% dplyr::select(Species)
silwood_2021_species <- silwood_2021_clean %>% dplyr::select(Species)
silwood_2022_species <- silwood_2022_clean %>% dplyr::select(Species)
silwood_2023_species <- silwood_2023_clean %>% dplyr::select(Species)

hpf_2024_species <- hpf_2024_clean %>% dplyr::select(Species)
hep_2024_species <- hep_2024_clean %>% dplyr::select(Species)
high_fen_species <- high_fen_clean %>% dplyr::select(Species)


# unique species count for data used
combined_species_data <- bind_rows(
  knepp_2022_species, knepp_2023_species, knepp_2024_species,
  boothby_2022_species, boothby_2023_species, boothby_2024_species,
  budworth_2021_species, silwood_2021_species,
  silwood_2022_species, silwood_2023_species,
  hpf_2024_species, hep_2024_species, high_fen_species
)

num_unique_species <- combined_species_data %>%
  distinct(Species) %>%
  nrow()
print(num_unique_species)

# natural sites only
subset_natural <- bind_rows(
  budworth_2021_species, silwood_2021_species,
  silwood_2022_species, silwood_2023_species
)

num_unique_species2 <- subset_natural %>%
  distinct(Species) %>%
  nrow()
print(num_unique_species2)

# rewilded sites only 
subset_wild <- bind_rows(
  knepp_2022_species, knepp_2023_species, knepp_2024_species,
  boothby_2022_species, boothby_2023_species, boothby_2024_species,
  hpf_2024_species, hep_2024_species, high_fen_species
)

num_unique_species3 <- subset_wild %>%
  distinct(Species) %>%
  nrow()
print(num_unique_species3)

```

```{r Species richness calculations with site IDs added}

# all richness calcs are in alphanumeric order but have to add these to dataframe

# Boothby 2022
b2022.rich <- .ses.mntd(b.c.data2022)$ntaxa

# extract site names from b.c.data
site_names <- rownames(b.c.data2022$comm)  

# combine site names with richness values
richness_per_site <- data.frame(site = site_names, richness = b2022.rich)

# order sites alphanumerically
b2022.rich.label <- richness_per_site[order(richness_per_site$site), ]

# view 
print(b2022.rich.label)

# format so year, state etc are added 
b2022.rich.label$year <- paste("2022", b2022.rich.label$year)
b2022.rich.label$state <- paste("early", b2022.rich.label$state)
b2022.rich.label <- b2022.rich.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2022.rich.label <- b2022.rich.label %>%
  mutate(group = NA)

# create a new column rewilding_age based on block values
b2022.rich.label <- b2022.rich.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,  
    TRUE ~ NA_real_  
  ))

# Boothby 2023
b2023.rich <- .ses.mntd(b.c.data2023)$ntaxa
site_names <- rownames(b.c.data2023$comm) 
richness_per_site <- data.frame(site = site_names, richness = b2023.rich)
b2023.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(b2023.rich.label)
b2023.rich.label$year <- paste("2023", b2023.rich.label$year)
b2023.rich.label$state <- paste("early", b2023.rich.label$state)
b2023.rich.label <- b2023.rich.label %>%
  separate(site, into = c("site", "block","plot"), sep = " ")
b2023.rich.label <- b2023.rich.label %>%
  mutate(group = NA)
b2023.rich.label <- b2023.rich.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 1, 
    TRUE ~ NA_real_  
  ))

# Boothby 2024
b2024.rich <- .ses.mntd(b.c.data2024)$ntaxa
site_names <- rownames(b.c.data2024$comm)  
richness_per_site <- data.frame(site = site_names, richness = b2024.rich)
b2024.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(b2024.rich.label)
b2024.rich.label$year <- paste("2024", b2024.rich.label$year)
b2024.rich.label$state <- paste("early", b2024.rich.label$state)
b2024.rich.label <- b2024.rich.label %>%
  separate(site, into = c("site", "block","plot"), sep = " ")
b2024.rich.label <- b2024.rich.label %>%
  mutate(group = NA)
b2024.rich.label <- b2024.rich.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 2,  
    TRUE ~ NA_real_  
  ))


# Knepp 2022
k2022.rich <- .ses.mntd(k.c.data2022)$ntaxa
site_names <- rownames(k.c.data2022$comm)  
richness_per_site <- data.frame(site = site_names, richness = k2022.rich)
k2022.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(k2022.rich.label)
k2022.rich.label$year <- paste("2022", k2022.rich.label$year)
k2022.rich.label$state <- paste("late", k2022.rich.label$state)
k2022.rich.label$group <- paste("NA", k2022.rich.label$group)
k2022.rich.label <- k2022.rich.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2022.rich.label <- k2022.rich.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX","SY","SZ") ~ 21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))

# Knepp 2023
k2023.rich <- .ses.mntd(k.c.data2023)$ntaxa
site_names <- rownames(k.c.data2023$comm)  
richness_per_site <- data.frame(site = site_names, richness = k2023.rich)
k2023.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(k2023.rich.label)
# Add year 
k2023.rich.label$year <- paste("2023", k2023.rich.label$year)
# add state
k2023.rich.label$state <- paste("late", k2023.rich.label$state)
k2023.rich.label <- k2023.rich.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2023.rich.label <- k2023.rich.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 22,
    block %in% c("M", "N") ~ 19,
    TRUE ~ NA_real_  
  ))
k2023.rich.label <- k2023.rich.label %>%
  mutate(group = NA)

# Knepp 2024
k2024.rich <- .ses.mntd(k.c.data2024)$ntaxa
site_names <- rownames(k.c.data2024$comm)  
richness_per_site <- data.frame(site = site_names, richness = k2024.rich)
k2024.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(k2024.rich.label)
k2024.rich.label$year <- paste("2024", k2024.rich.label$year)
k2024.rich.label$state <- paste("late", k2024.rich.label$state)
k2024.rich.label <- k2024.rich.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2024.rich.label <- k2024.rich.label %>%
  mutate(rewilding_age = case_when(block %in% c("SX", "SY", "SZ") ~ 23,
    block %in% c("M", "N") ~ 20,
    TRUE ~ NA_real_  
  ))
k2024.rich.label <- k2024.rich.label %>%
  mutate(group = NA)

# Budworth
br2021.rich <- .ses.mntd(br.c.data2021)$ntaxa
site_names <- rownames(br.c.data2021$comm) 
richness_per_site <- data.frame(site = site_names, richness = br2021.rich)
br2021.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(br2021.rich.label)
br2021.rich.label$year <- paste("2021", br2021.rich.label$year)
br2021.rich.label$state <- paste("natural", br2021.rich.label$state)
br2021.rich.label <- br2021.rich.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
br2021.rich.label <- br2021.rich.label %>%
  mutate(group = NA, block = NA, rewilding_age=NA)

# Silwood 2021
silwood2021.rich <- .ses.mntd(s.c.data2021)$ntaxa
site_names <- rownames(s.c.data2021$comm)  
richness_per_site <- data.frame(plot = site_names, richness = silwood2021.rich)
silwood2021.rich.label <- richness_per_site[order(richness_per_site$plot), ]
print(silwood2021.rich.label)
silwood2021.rich.label$year <- paste("2021", silwood2021.rich.label$year)
silwood2021.rich.label$state <- paste("natural", silwood2021.rich.label$state)
silwood2021.rich.label <- silwood2021.rich.label %>%
  mutate(site = "Silwood_Park")
silwood2021.rich.label <- silwood2021.rich.label %>%
  mutate(group = NA, block = NA,rewilding_age=NA)

# Silwood 2022
silwood2022.rich <- .ses.mntd(s.c.data2022)$ntaxa
site_names <- rownames(s.c.data2022$comm) 
richness_per_site <- data.frame(site = site_names, richness = silwood2022.rich)
silwood2022.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(silwood2022.rich.label)
silwood2022.rich.label$year <- paste("2022", silwood2022.rich.label$year)
silwood2022.rich.label$state <- paste("natural", silwood2022.rich.label$state)
silwood2022.rich.label <- silwood2022.rich.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2022.rich.label <- silwood2022.rich.label %>%
  mutate(group = NA, block = NA,rewilding_age=NA)

# Silwood 2023
silwood2023.rich <- .ses.mntd(s.c.data2023)$ntaxa
site_names <- rownames(s.c.data2023$comm)  
richness_per_site <- data.frame(site = site_names, richness = silwood2023.rich)
silwood2023.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(silwood2023.rich.label)
silwood2023.rich.label$year <- paste("2023", silwood2023.rich.label$year)
silwood2023.rich.label$state <- paste("natural", silwood2023.rich.label$state)
silwood2023.rich.label <- silwood2023.rich.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2023.rich.label <- silwood2023.rich.label %>%
  mutate(group = NA, block = NA,rewilding_age=NA)

# Harold's Park Farm 2024
hpf2024.rich <- .ses.mntd(hpf.c.data2024)$ntaxa
site_names <- rownames(hpf.c.data2024$comm)  # Adjust this based on your actual data structure
richness_per_site <- data.frame(site = site_names, richness = hpf2024.rich)
hpf2024.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(hpf2024.rich.label)
hpf2024.rich.label$year <- paste("2024", hpf2024.rich.label$year)
hpf2024.rich.label$state <- paste("early", hpf2024.rich.label$state)
hpf2024.rich.label$rewilding_age <- paste("0", hpf2024.rich.label$rewilding_age)
hpf2024.rich.label$group <- paste("NA", hpf2024.rich.label$group)
hpf2024.rich.label <- hpf2024.rich.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ", extra = "merge")


# Hepple 2024
hep2024.rich <- .ses.mntd(hep.c.data2024)$ntaxa
site_names <- rownames(hep.c.data2024$comm)  
richness_per_site <- data.frame(site = site_names, richness = hep2024.rich)
hep2024.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(hep2024.rich.label)
hep2024.rich.label$year <- paste("2024", hep2024.rich.label$year)
hep2024.rich.label$state <- paste("early", hep2024.rich.label$state)
hep2024.rich.label$rewilding_age <- paste("3", hep2024.rich.label$rewilding_age)
hep2024.rich.label$group <- paste("NA", hep2024.rich.label$group)
hep2024.rich.label <- hep2024.rich.label %>%
  separate(site, into = c("site","block", "plot"), sep = " ")

# High Fen
high_fen.rich <- .ses.mntd(high_fen.c.data)$ntaxa
site_names <- rownames(high_fen.c.data$comm) 
richness_per_site <- data.frame(site = site_names, richness = high_fen.rich)
high_fen.rich.label <- richness_per_site[order(richness_per_site$site), ]
print(high_fen.rich.label)
high_fen.rich.label$year <- paste("2024", high_fen.rich.label$year)
high_fen.rich.label$state <- paste("early", high_fen.rich.label$state)
high_fen.rich.label$rewilding_age <- paste("2", high_fen.rich.label$rewilding_age)
high_fen.rich.label$group <- paste("NA", high_fen.rich.label$group)
high_fen.rich.label$block <- paste("NA", high_fen.rich.label$block)
high_fen.rich.label <- high_fen.rich.label %>%
  separate(site, into = c("site", "plot"), sep = " ")

# Combine
combined_rich <- rbind(k2022.rich.label, k2023.rich.label, k2024.rich.label, b2022.rich.label,b2024.rich.label,b2023.rich.label, br2021.rich.label, silwood2021.rich.label, silwood2022.rich.label, silwood2023.rich.label, hpf2024.rich.label, hep2024.rich.label, high_fen.rich.label)

head(combined_rich)
combined_rich$group[combined_rich$group == "NA "] <- NA

# check for normal distribution
hist(combined_rich$rich) # right skewed 

write.csv(combined_rich, file = "metric_calcs_final/combined_rich.csv", row.names = F)
```

```{r Faith's PD calculations with side IDs}

# Knepp 2022
k2022.pd <- .pd(k.c.data2022)[,"pd"]
k2022.pd
site_names <- rownames(k.c.data2022$comm)  
pd_per_site <- data.frame(site = site_names, pd = k2022.pd)
k2022.pd.label <- pd_per_site[order(pd_per_site$site), ]
print(k2022.pd.label)
k2022.pd.label <- k2022.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2022.pd.label$year <- paste("2022", k2022.pd.label$year)
k2022.pd.label$state <- paste("late", k2022.pd.label$state)
k2022.pd.label <- k2022.pd.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY","SZ") ~ 21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))
k2022.pd.label <- k2022.pd.label %>%
  mutate(group = NA)

# Knepp 2023
k2023.pd <- .pd(k.c.data2023)[,"pd"]
k2023.pd
site_names <- rownames(k.c.data2023$comm)  
pd_per_site <- data.frame(site = site_names, pd = k2023.pd)
k2023.pd.label <- pd_per_site[order(pd_per_site$site), ]
print(k2023.pd.label)
k2023.pd.label <- k2023.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2023.pd.label$year <- paste("2023", k2023.pd.label$year)
k2023.pd.label$state <- paste("late", k2023.pd.label$state)
k2023.pd.label <- k2023.pd.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 22,
    block %in% c("M", "N") ~ 19,
    TRUE ~ NA_real_ 
  ))
k2023.pd.label <- k2023.pd.label %>%
  mutate(group = NA)

# Knepp 2024
k2024.pd <- .pd(k.c.data2024)[,"pd"]
site_names <- rownames(k.c.data2024$comm)  
pd_per_site <- data.frame(site = site_names, pd = k2024.pd)
k2024.pd.label <- pd_per_site[order(pd_per_site$site), ]
print(k2024.pd.label)
k2024.pd.label <- k2024.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2024.pd.label$year <- paste("2024", k2024.pd.label$year)
k2024.pd.label$state <- paste("late", k2024.pd.label$state)
k2024.pd.label <- k2024.pd.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 23,
    block %in% c("M", "N") ~ 20,
    TRUE ~ NA_real_  
  ))
k2024.pd.label <- k2024.pd.label %>%
  mutate(group = NA)

# Boothby 2022
b2022.pd <- .pd(b.c.data2022)[,"pd"]
site_names <- rownames(b.c.data2022$comm)
pd_per_site <- data.frame(site = site_names, pd = b2022.pd)
b2022.pd.label <- pd_per_site[order(pd_per_site$site), ]
b2022.pd.label <- b2022.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2022.pd.label <- b2022.pd.label %>%
  mutate(group = NA)
b2022.pd.label <- b2022.pd.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,  
    TRUE ~ NA_real_ 
  ))
b2022.pd.label$year <- paste("2022", b2022.pd.label$year)
b2022.pd.label$state <- paste("early", b2022.pd.label$state)

# Boothby 2023
b2023.pd <- .pd(b.c.data2023)[,"pd"]
site_names <- rownames(b.c.data2023$comm)
pd_per_site <- data.frame(site = site_names, pd = b2023.pd)
b2023.pd.label <- pd_per_site[order(pd_per_site$site), ]
b2023.pd.label <- b2023.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2023.pd.label <- b2023.pd.label %>%
  mutate(group = NA)
b2023.pd.label <- b2023.pd.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 1,  
    TRUE ~ NA_real_  
  ))
b2023.pd.label$year <- paste("2023", b2023.pd.label$year)
b2023.pd.label$state <- paste("early", b2023.pd.label$state)

# Boothby 2024
b2024.pd <- .pd(b.c.data2024)[,"pd"]
site_names <- rownames(b.c.data2024$comm)
pd_per_site <- data.frame(site = site_names, pd = b2024.pd)
b2024.pd.label <- pd_per_site[order(pd_per_site$site), ]
b2024.pd.label <- b2024.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2024.pd.label <- b2024.pd.label %>%
  mutate(group = NA)
b2024.pd.label <- b2024.pd.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 2,  
    TRUE ~ NA_real_  
  ))
b2024.pd.label$year <- paste("2024", b2024.pd.label$year)
b2024.pd.label$state <- paste("early", b2024.pd.label$state)

# Budworth 2021
br2021.pd <- .pd(br.c.data2021)[,"pd"]
site_names <- rownames(br.c.data2021$comm)
pd_per_site <- data.frame(site = site_names, pd = br2021.pd)
br2021.pd.label <- pd_per_site[order(pd_per_site$site), ]
br2021.pd.label <- br2021.pd.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
br2021.pd.label$year <- paste("2021", br2021.pd.label$year)
br2021.pd.label$state <- paste("natural", br2021.pd.label$state)
br2021.pd.label <- br2021.pd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2021
silwood2021.pd <- .pd(s.c.data2021)[,"pd"]
site_names <- rownames(s.c.data2021$comm)
pd_per_site <- data.frame(site = site_names, pd = silwood2021.pd)
silwood2021.pd.label <- pd_per_site[order(pd_per_site$site), ]
silwood2021.pd.label <- silwood2021.pd.label %>%
  mutate(
    plot = site,   
    site = "Silwood_Park"  
  ) 
silwood2021.pd.label$year <- paste("2021", silwood2021.pd.label$year)
silwood2021.pd.label$state <- paste("natural", silwood2021.pd.label$state)
silwood2021.pd.label <- silwood2021.pd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2022
silwood2022.pd <- .pd(s.c.data2022)[,"pd"]
site_names <- rownames(s.c.data2022$comm)
pd_per_site <- data.frame(site = site_names, pd = silwood2022.pd)
silwood2022.pd.label <- pd_per_site[order(pd_per_site$site), ]
silwood2022.pd.label <- silwood2022.pd.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2022.pd.label$year <- paste("2022", silwood2022.pd.label$year)
silwood2022.pd.label$state <- paste("natural", silwood2022.pd.label$state)
silwood2022.pd.label <- silwood2022.pd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2023
silwood2023.pd <- .pd(s.c.data2023)[,"pd"]
site_names <- rownames(s.c.data2023$comm)
pd_per_site <- data.frame(site = site_names, pd = silwood2023.pd)
silwood2023.pd.label <- pd_per_site[order(pd_per_site$site), ]
silwood2023.pd.label <- silwood2023.pd.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2023.pd.label$year <- paste("2023", silwood2023.pd.label$year)
silwood2023.pd.label$state <- paste("natural", silwood2023.pd.label$state)
silwood2023.pd.label <- silwood2023.pd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Harold's Park Farm
hpf2024.pd <- .pd(hpf.c.data2024)[,"pd"]
site_names <- rownames(hpf.c.data2024$comm)
pd_per_site <- data.frame(site = site_names, pd = hpf2024.pd)
hpf2024.pd.label <- pd_per_site[order(pd_per_site$site), ]
hpf2024.pd.label <- hpf2024.pd.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ", extra = "merge")
hpf2024.pd.label <- hpf2024.pd.label %>%
  mutate(group = NA)
hpf2024.pd.label <- hpf2024.pd.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0, 
    TRUE ~ NA_real_  
  ))
hpf2024.pd.label$year <- paste("2024", hpf2024.pd.label$year)
hpf2024.pd.label$state <- paste("early", hpf2024.pd.label$state)

# Hepple 2024
hep2024.pd <- .pd(hep.c.data2024)[,"pd"]
site_names <- rownames(hep.c.data2024$comm)  
pd_per_site <- data.frame(site = site_names, pd = hep2024.pd)
hep2024.pd.label <- pd_per_site[order(pd_per_site$site), ]
print(hep2024.pd.label)
hep2024.pd.label$year <- paste("2024", hep2024.pd.label$year)
hep2024.pd.label$state <- paste("early", hep2024.pd.label$state)
hep2024.pd.label$rewilding_age <- paste("3", hep2024.pd.label$rewilding_age)
hep2024.pd.label$group <- paste("NA", hep2024.pd.label$group)
hep2024.pd.label <- hep2024.pd.label %>%
  separate(site, into = c("site","block", "plot"), sep = " ")

# High Fen
high_fen.pd <- .pd(high_fen.c.data)[,"pd"]
site_names <- rownames(high_fen.c.data$comm) 
pd_per_site <- data.frame(site = site_names, pd = high_fen.pd)
high_fen.pd.label <- pd_per_site[order(pd_per_site$site), ]
print(high_fen.pd.label)
high_fen.pd.label$year <- paste("2024", high_fen.pd.label$year)
high_fen.pd.label$state <- paste("early", high_fen.pd.label$state)
high_fen.pd.label$rewilding_age <- paste("2", high_fen.pd.label$rewilding_age)
high_fen.pd.label$group <- paste("NA", high_fen.pd.label$group)
high_fen.pd.label$block <- paste("NA", high_fen.pd.label$block)
high_fen.pd.label <- high_fen.pd.label %>%
  separate(site, into = c("site", "plot"), sep = " ")

# Combine
combined_pd <- rbind(k2022.pd.label,k2023.pd.label,k2024.pd.label, b2022.pd.label, b2023.pd.label, b2024.pd.label, br2021.pd.label, silwood2021.pd.label, silwood2022.pd.label, silwood2023.pd.label, hpf2024.pd.label, hep2024.pd.label, high_fen.pd.label)

head(combined_pd)
combined_pd$group[combined_pd$group == "NA "] <- NA

# check for normal distribution 
hist(combined_pd$pd) # ok

# save 
write.csv(combined_pd, file = "metric_calcs_final/combined_pd.csv", row.names = F)

```

```{r Simpsons calculations with site IDs}

# Knepp 2022
k2022.simpson <- diversity(k.c.data2022$comm, index="simpson") 
site_names <- rownames(k.c.data2022$comm)  
s_per_site <- data.frame(site = site_names, simpsons = k2022.simpson)
k2022.simpson.label <- s_per_site[order(s_per_site$site), ]
print(k2022.simpson.label)
k2022.simpson.label <- k2022.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2022.simpson.label$year <- paste("2022", k2022.simpson.label$year)
k2022.simpson.label$state <- paste("late", k2022.simpson.label$state)
k2022.simpson.label <- k2022.simpson.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))
k2022.simpson.label <- k2022.simpson.label %>%
  mutate(group = NA)
head(k2022.simpson.label)

# Knepp 2023
k2023.simpson <- diversity(k.c.data2023$comm, "simpson") 
site_names <- rownames(k.c.data2023$comm)  
s_per_site <- data.frame(site = site_names, simpsons = k2023.simpson)
k2023.simpson.label <- s_per_site[order(s_per_site$site), ]
print(k2023.simpson.label)
k2023.simpson.label <- k2023.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2023.simpson.label$year <- paste("2023", k2023.simpson.label$year)
k2023.simpson.label$state <- paste("late", k2023.simpson.label$state)
k2023.simpson.label <- k2023.simpson.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 22,
    block %in% c("M", "N") ~ 19,
    TRUE ~ NA_real_ 
  ))
k2023.simpson.label <- k2023.simpson.label %>%
  mutate(group = NA)

# Knepp 2024
k2024.simpson <- diversity(k.c.data2024$comm, "simpson") 
site_names <- rownames(k.c.data2024$comm)  
s_per_site <- data.frame(site = site_names, simpsons = k2024.simpson)
k2024.simpson.label <- s_per_site[order(s_per_site$site), ]
print(k2024.simpson.label)
k2024.simpson.label <- k2024.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2024.simpson.label$year <- paste("2024", k2024.simpson.label$year)
k2024.simpson.label$state <- paste("late", k2024.simpson.label$state)
k2024.simpson.label <- k2024.simpson.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 23,
    block %in% c("M", "N") ~ 20,
    TRUE ~ NA_real_  
  ))
k2024.simpson.label <- k2024.simpson.label %>%
  mutate(group = NA)

# Boothby 2022
b2022.simpson <- diversity(b.c.data2022$comm, "simpson") 
site_names <- rownames(b.c.data2022$comm)
s_per_site <- data.frame(site = site_names, simpsons = b2022.simpson)
b2022.simpson.label <- s_per_site[order(s_per_site$site), ]
b2022.simpson.label <- b2022.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2022.simpson.label <- b2022.simpson.label %>%
  mutate(group = NA)
b2022.simpson.label <- b2022.simpson.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,  
    TRUE ~ NA_real_  
  ))
b2022.simpson.label$year <- paste("2022", b2022.simpson.label$year)
b2022.simpson.label$state <- paste("early", b2022.simpson.label$state)

# Boothby 2023
b2023.simpson <- diversity(b.c.data2023$comm, "simpson") 
site_names <- rownames(b.c.data2023$comm)
s_per_site <- data.frame(site = site_names, simpsons = b2023.simpson)
b2023.simpson.label <- s_per_site[order(s_per_site$site), ]
b2023.simpson.label <- b2023.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2023.simpson.label <- b2023.simpson.label %>%
  mutate(group = NA)
b2023.simpson.label <- b2023.simpson.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 1, 
    TRUE ~ NA_real_  
  ))
b2023.simpson.label$year <- paste("2023", b2023.simpson.label$year)
b2023.simpson.label$state <- paste("early", b2023.simpson.label$state)

# Boothby 2024
b2024.simpson <- diversity(b.c.data2024$comm, "simpson") 
site_names <- rownames(b.c.data2024$comm)
s_per_site <- data.frame(site = site_names, simpsons = b2024.simpson)
b2024.simpson.label <- s_per_site[order(s_per_site$site), ]
b2024.simpson.label <- b2024.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b2024.simpson.label <- b2024.simpson.label %>%
  mutate(group = NA)
b2024.simpson.label <- b2024.simpson.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 2,  
    TRUE ~ NA_real_  
  ))
b2024.simpson.label$year <- paste("2024", b2024.simpson.label$year)
b2024.simpson.label$state <- paste("early", b2024.simpson.label$state)

# Budworth 2021
br2021.simpson <- diversity(br.c.data2021$comm, "simpson") 
site_names <- rownames(br.c.data2021$comm)
s_per_site <- data.frame(site = site_names, simpsons = br2021.simpson)
br2021.simpson.label <- s_per_site[order(s_per_site$site), ]
br2021.simpson.label <- br2021.simpson.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
br2021.simpson.label$year <- paste("2021", br2021.simpson.label$year)
br2021.simpson.label$state <- paste("natural", br2021.simpson.label$state)
br2021.simpson.label <- br2021.simpson.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2021
silwood2021.simpson <- diversity(s.c.data2021$comm, "simpson") 
site_names <- rownames(s.c.data2021$comm)
s_per_site <- data.frame(site = site_names, simpsons = silwood2021.simpson)
silwood2021.simpson.label <- s_per_site[order(s_per_site$site), ]
silwood2021.simpson.label <- silwood2021.simpson.label %>%
  mutate(
    plot = site,    
    site = "Silwood_Park"  
  ) 
silwood2021.simpson.label$year <- paste("2021", silwood2021.simpson.label$year)
silwood2021.simpson.label$state <- paste("natural", silwood2021.simpson.label$state)
silwood2021.simpson.label <- silwood2021.simpson.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2022
silwood2022.simpson <- diversity(s.c.data2022$comm, "simpson") 
site_names <- rownames(s.c.data2022$comm)
s_per_site <- data.frame(site = site_names, simpsons = silwood2022.simpson)
silwood2022.simpson.label <- s_per_site[order(s_per_site$site), ]
silwood2022.simpson.label <- silwood2022.simpson.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2022.simpson.label$year <- paste("2022", silwood2022.simpson.label$year)
silwood2022.simpson.label$state <- paste("natural", silwood2022.simpson.label$state)
silwood2022.simpson.label <- silwood2022.simpson.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2023
silwood2023.simpson <- diversity(s.c.data2023$comm, "simpson") 
site_names <- rownames(s.c.data2023$comm)
s_per_site <- data.frame(site = site_names, simpsons = silwood2023.simpson)
silwood2023.simpson.label <- s_per_site[order(s_per_site$site), ]
silwood2023.simpson.label <- silwood2023.simpson.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood2023.simpson.label$year <- paste("2023", silwood2023.simpson.label$year)
silwood2023.simpson.label$state <- paste("natural", silwood2023.simpson.label$state)
silwood2023.simpson.label <- silwood2023.simpson.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Harolds Park Farm
hpf2024.simpson <- diversity(hpf.c.data2024$comm, "simpson") 
site_names <- rownames(hpf.c.data2024$comm)
s_per_site <- data.frame(site = site_names, simpsons = hpf2024.simpson)
hpf2024.simpson.label <- s_per_site[order(s_per_site$site), ]
hpf2024.simpson.label <- hpf2024.simpson.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ", extra = "merge")
hpf2024.simpson.label <- hpf2024.simpson.label %>%
  mutate(group = NA)
hpf2024.simpson.label <- hpf2024.simpson.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,  
    TRUE ~ NA_real_  
  ))
hpf2024.simpson.label$year <- paste("2024", hpf2024.simpson.label$year)
hpf2024.simpson.label$state <- paste("early", hpf2024.simpson.label$state)

# Hepple 
hep2024.simpson <- diversity(hep.c.data2024$comm, "simpson") 
site_names <- rownames(hep.c.data2024$comm)
s_per_site <- data.frame(site = site_names, simpsons = hep2024.simpson)
hep2024.simpson.label <- s_per_site[order(s_per_site$site), ]
print(hep2024.simpson.label)
hep2024.simpson.label$year <- paste("2024", hep2024.simpson.label$year)
hep2024.simpson.label$state <- paste("early", hep2024.simpson.label$state)
hep2024.simpson.label$rewilding_age <- paste("3", hep2024.simpson.label$rewilding_age)
hep2024.simpson.label$group <- paste("NA", hep2024.simpson.label$group)
hep2024.simpson.label <- hep2024.simpson.label %>%
  separate(site, into = c("site","block", "plot"), sep = " ")
rownames(hep2024.simpson.label) <- NULL

# High Fen
high_fen.simpson <- diversity(high_fen.c.data$comm, "simpson") 
site_names <- rownames(high_fen.c.data$comm)  
s_per_site <- data.frame(site = site_names, simpsons = high_fen.simpson)
high_fen.simpson.label <- s_per_site[order(s_per_site$site), ]
print(high_fen.simpson.label)
high_fen.simpson.label$year <- paste("2024", high_fen.simpson.label$year)
high_fen.simpson.label$state <- paste("early", high_fen.simpson.label$state)
high_fen.simpson.label$rewilding_age <- paste("2", high_fen.simpson.label$rewilding_age)
high_fen.simpson.label$group <- paste("NA", high_fen.simpson.label$group)
high_fen.simpson.label$block <- paste("NA", high_fen.simpson.label$block)
high_fen.simpson.label <- high_fen.simpson.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
rownames(high_fen.simpson.label) <- NULL

# Combine
combined_simpson <- rbind(k2022.simpson.label, k2023.simpson.label,k2024.simpson.label, b2022.simpson.label,b2023.simpson.label,b2024.simpson.label, br2021.simpson.label, silwood2021.simpson.label, silwood2022.simpson.label,silwood2023.simpson.label, hpf2024.simpson.label, hep2024.simpson.label, high_fen.simpson.label)
combined_simpson <- combined_simpson %>%
  mutate(group = ifelse(group == "NA ", NA, group))

hist(combined_simpson$simpsons)
write.csv(combined_simpson, file = "metric_calcs_final/combined_simpson.csv", row.names = F)

```

```{r Inverse simpsons with side IDs}

# Knepp 2022
k2022.simpsoninv <- diversity(k.c.data2022$comm, index="invsimpson") 
site_names <- rownames(k.c.data2022$comm)  
s_per_site <- data.frame(site = site_names, invsimpsons = k2022.simpsoninv)
k2022.simpson.labelinv <- s_per_site[order(s_per_site$site), ]
print(k2022.simpson.labelinv)
k2022.simpson.labelinv <- k2022.simpson.labelinv %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k2022.simpson.labelinv$year <- paste("2022", k2022.simpson.labelinv$year)
k2022.simpson.labelinv$state <- paste("late", k2022.simpson.labelinv$state)
k2022.simpson.labelinv <- k2022.simpson.labelinv %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))
k2022.simpson.labelinv <- k2022.simpson.labelinv %>%
  mutate(group = NA)

# Knepp 2023
k2023.simpson.labelinv <- data.frame(site = rownames(k.c.data2023$comm), invsimpsons = diversity(k.c.data2023$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ") %>%
  mutate(year = "2023",
         state = "late",
         rewilding_age = case_when(
           block %in% c("SX", "SY", "SZ") ~ 22,
           block %in% c("M", "N") ~ 19,
           TRUE ~ NA_real_
         ),
         group = NA)

# Knepp 2024
k2024.simpson.labelinv <- data.frame(site = rownames(k.c.data2024$comm), invsimpsons = diversity(k.c.data2024$comm, index="simpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ") %>%
  mutate(year = "2024",
         state = "late",
         rewilding_age = case_when(
           block %in% c("SX", "SY", "SZ") ~ 23,
           block %in% c("M", "N") ~ 20,
           TRUE ~ NA_real_
         ),
         group = NA)

# Boothby 2022
b2022.simpson.labelinv <- data.frame(site = rownames(b.c.data2022$comm), invsimpsons = diversity(b.c.data2022$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ") %>%
  mutate(year = "2022",
         state = "early",
         rewilding_age = 0,
        group = NA)

# Boothby 2023
b2023.simpson.labelinv <- data.frame(site = rownames(b.c.data2023$comm), invsimpsons = diversity(b.c.data2023$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ") %>%
  mutate(year = "2023",
         state = "early",
         rewilding_age = 1,
         group = NA)

# Boothby 2024
b2024.simpson.labelinv <- data.frame(site = rownames(b.c.data2024$comm), invsimpsons = diversity(b.c.data2024$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ") %>%
  mutate(year = "2024",
         state = "early",
         rewilding_age = 2,
         group = NA)

# Budworth 2021
br2021.simpson.labelinv <- data.frame(site = rownames(br.c.data2021$comm), invsimpsons = diversity(br.c.data2021$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "plot"), sep = " ") %>%
  mutate(year = "2021",
         state = "natural",
         group = NA,
         block = NA,
         rewilding_age = NA)

# Silwood 2021
silwood2021.simpson.labelinv <- data.frame(site = rownames(s.c.data2021$comm), invsimpsons = diversity(s.c.data2021$comm, index="invsimpson")) %>%
  arrange(site) %>%
  mutate(plot = site,
         site = "Silwood_Park") %>%
  mutate(year = "2021",
         state = "natural",
         group = NA,
         block = NA,
         rewilding_age = NA)

# Silwood 2022
silwood2022.simpson.labelinv <- data.frame(site = rownames(s.c.data2022$comm), invsimpsons = diversity(s.c.data2022$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "plot"), sep = " ") %>%
  mutate(year = "2022",
         state = "natural",
         group = NA,
         block = NA,
         rewilding_age = NA)

# Silwood 2023
silwood2023.simpson.labelinv <- data.frame(site = rownames(s.c.data2023$comm), invsimpsons = diversity(s.c.data2023$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "plot"), sep = " ") %>%
  mutate(year = "2023",
         state = "natural",
         group = NA,
         block = NA,
         rewilding_age = NA)

# Harolds Park Farm
hpf2024.simpson.labelinv <- data.frame(site = rownames(hpf.c.data2024$comm), invsimpsons = diversity(hpf.c.data2024$comm, index="invsimpson")) %>%
  arrange(site) %>%
  separate(site, into = c("site", "block", "plot"), sep = " ", extra="merge") %>%
  mutate(year = "2024",
         state = "early",
         rewilding_age = 0,
         group = NA)

# Hepple 
hep2024.simpsoninv <- diversity(hep.c.data2024$comm, "invsimpson") 
site_names <- rownames(hep.c.data2024$comm)  
s_per_site <- data.frame(site = site_names, invsimpsons = hep2024.simpsoninv)
hep2024.simpson.labelinv <- s_per_site[order(s_per_site$site), ]
print(hep2024.simpson.labelinv)
hep2024.simpson.labelinv$year <- paste("2024", hep2024.simpson.labelinv$year)
hep2024.simpson.labelinv$state <- paste("early", hep2024.simpson.labelinv$state)
hep2024.simpson.labelinv$rewilding_age <- paste("3", hep2024.simpson.labelinv$rewilding_age)
hep2024.simpson.labelinv$group <- paste("NA", hep2024.simpson.labelinv$group)
hep2024.simpson.labelinv <- hep2024.simpson.labelinv %>%
  separate(site, into = c("site","block", "plot"), sep = " ")
rownames(hep2024.simpson.labelinv) <- NULL

# High Fen 
high_fen.simpsoninv <- diversity(high_fen.c.data$comm, "invsimpson") 
site_names <- rownames(high_fen.c.data$comm) 
s_per_site <- data.frame(site = site_names, invsimpsons = high_fen.simpsoninv)
high_fen.simpson.labelinv <- s_per_site[order(s_per_site$site), ]
print(high_fen.simpson.labelinv)
high_fen.simpson.labelinv$year <- paste("2024", high_fen.simpson.labelinv$year)
high_fen.simpson.labelinv$state <- paste("early", high_fen.simpson.labelinv$state)
high_fen.simpson.labelinv$rewilding_age <- paste("2", high_fen.simpson.labelinv$rewilding_age)
high_fen.simpson.labelinv$group <- paste("NA", high_fen.simpson.labelinv$group)
high_fen.simpson.labelinv$block <- paste("NA", high_fen.simpson.labelinv$block)
high_fen.simpson.labelinv <- high_fen.simpson.labelinv %>%
  separate(site, into = c("site", "plot"), sep = " ")
rownames(high_fen.simpson.labelinv) <- NULL

# combine 
combined_inv_simpson <- rbind(
  k2022.simpson.labelinv,
  k2023.simpson.labelinv,
  k2024.simpson.labelinv,
  b2022.simpson.labelinv,
  b2023.simpson.labelinv,
  b2024.simpson.labelinv,
  br2021.simpson.labelinv,
  silwood2021.simpson.labelinv,
  silwood2022.simpson.labelinv,
  silwood2023.simpson.labelinv,
  hpf2024.simpson.labelinv,
  hep2024.simpson.labelinv,
  high_fen.simpson.labelinv
)

# view
print(combined_inv_simpson)

combined_inv_simpson <- combined_inv_simpson %>%
  mutate(group = ifelse(group == "NA ", NA, group))

# remove row names 
#combined_inv_simpson <- combined_inv_simpson %>%
 # rownames_to_column(var = "rownames") %>%
 # select(-rownames)

hist(combined_inv_simpson$invsimpsons)

write.csv(combined_inv_simpson, file = "metric_calcs_final/combined_inv_simpson.csv", row.names = F)


```

```{r SES MPD}

# Knepp 2022
k.ses.mpd.2022 <- .ses.mpd(k.c.data2022)$mpd.obs.z
k.ses.mpd.2022[is.na(k.ses.mpd.2022)] <- 0
site_names <- rownames(k.c.data2022$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = k.ses.mpd.2022)
k.ses.mpd.2022.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(k.ses.mpd.2022.label)
k.ses.mpd.2022.label <- k.ses.mpd.2022.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mpd.2022.label$year <- paste("2022", k.ses.mpd.2022.label$year)
k.ses.mpd.2022.label$state <- paste("late", k.ses.mpd.2022.label$state)
k.ses.mpd.2022.label <- k.ses.mpd.2022.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))
k.ses.mpd.2022.label <- k.ses.mpd.2022.label %>%
  mutate(group = NA)
k.ses.mpd.2022.label <- k.ses.mpd.2022.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Knepp 2023
k.ses.mpd.2023 <- .ses.mpd(k.c.data2023)$mpd.obs.z
k.ses.mpd.2023[is.na(k.ses.mpd.2023)] <- 0
site_names <- rownames(k.c.data2023$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = k.ses.mpd.2023)
k.ses.mpd.2023.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(k.ses.mpd.2023.label)
k.ses.mpd.2023.label <- k.ses.mpd.2023.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mpd.2023.label <- k.ses.mpd.2023.label %>%
  mutate(group = NA)
k.ses.mpd.2023.label$year <- paste("2023", k.ses.mpd.2023.label$year)
k.ses.mpd.2023.label$state <- paste("late", k.ses.mpd.2023.label$state)
k.ses.mpd.2023.label <- k.ses.mpd.2023.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 22,
    block %in% c("M", "N") ~ 19,
    TRUE ~ NA_real_ 
  ))
k.ses.mpd.2023.label <- k.ses.mpd.2023.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Knepp 2024
k.ses.mpd.2024 <- .ses.mpd(k.c.data2024)$mpd.obs.z
k.ses.mpd.2024[is.na(k.ses.mpd.2024)] <- 0
site_names <- rownames(k.c.data2024$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = k.ses.mpd.2024)
k.ses.mpd.2024.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(k.ses.mpd.2024.label)
k.ses.mpd.2024.label <- k.ses.mpd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mpd.2024.label <- k.ses.mpd.2024.label %>%
  mutate(group = NA)
k.ses.mpd.2024.label$year <- paste("2024", k.ses.mpd.2024.label$year)
k.ses.mpd.2024.label$state <- paste("late", k.ses.mpd.2024.label$state)
k.ses.mpd.2024.label <- k.ses.mpd.2024.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 23,
    block %in% c("M", "N") ~ 20,
    TRUE ~ NA_real_  
  ))
k.ses.mpd.2024.label <- k.ses.mpd.2024.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Boothby 2022
b.ses.mpd.2022 <- .ses.mpd(b.c.data2022)$mpd.obs.z
b.ses.mpd.2022[is.na(b.ses.mpd.2022)] <- 0
site_names <- rownames(b.c.data2022$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = b.ses.mpd.2022)
b.ses.mpd.2022.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(b.ses.mpd.2022.label)
b.ses.mpd.2022.label <- b.ses.mpd.2022.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mpd.2022.label$year <- paste("2022", b.ses.mpd.2022.label$year)
b.ses.mpd.2022.label$state <- paste("early", b.ses.mpd.2022.label$state)
b.ses.mpd.2022.label <- b.ses.mpd.2022.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,
    TRUE ~ NA_real_  
  ))
b.ses.mpd.2022.label <- b.ses.mpd.2022.label %>%
  mutate(group = NA)
b.ses.mpd.2022.label <- b.ses.mpd.2022.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Boothby 2023
b.ses.mpd.2023 <- .ses.mpd(b.c.data2023)$mpd.obs.z
b.ses.mpd.2023[is.na(b.ses.mpd.2023)] <- 0
site_names <- rownames(b.c.data2023$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = b.ses.mpd.2023)
b.ses.mpd.2023.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(b.ses.mpd.2023.label)
b.ses.mpd.2023.label <- b.ses.mpd.2023.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mpd.2023.label$year <- paste("2023", b.ses.mpd.2023.label$year)
b.ses.mpd.2023.label$state <- paste("early", b.ses.mpd.2023.label$state)
b.ses.mpd.2023.label <- b.ses.mpd.2023.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 1,
    TRUE ~ NA_real_  
  ))
b.ses.mpd.2023.label <- b.ses.mpd.2023.label %>%
  mutate(group = NA)
b.ses.mpd.2023.label <- b.ses.mpd.2023.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Boothby 2024
b.ses.mpd.2024 <- .ses.mpd(b.c.data2024)$mpd.obs.z
b.ses.mpd.2024[is.na(b.ses.mpd.2024)] <- 0
site_names <- rownames(b.c.data2024$comm) 
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = b.ses.mpd.2024)
b.ses.mpd.2024.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(b.ses.mpd.2024.label)
b.ses.mpd.2024.label <- b.ses.mpd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mpd.2024.label$year <- paste("2024", b.ses.mpd.2024.label$year)
b.ses.mpd.2024.label$state <- paste("early", b.ses.mpd.2024.label$state)
b.ses.mpd.2024.label <- b.ses.mpd.2024.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 2,
    TRUE ~ NA_real_  
  ))
b.ses.mpd.2024.label <- b.ses.mpd.2024.label %>%
  mutate(group = NA)
b.ses.mpd.2024.label <- b.ses.mpd.2024.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Budworth 2021
br.ses.mpd.2021 <- .ses.mpd(br.c.data2021)$mpd.obs.z
site_names <- rownames(br.c.data2021$comm)
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = br.ses.mpd.2021)
br.ses.mpd.2021.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
br.ses.mpd.2021.label <- br.ses.mpd.2021.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
br.ses.mpd.2021.label$year <- paste("2021", br.ses.mpd.2021.label$year)
br.ses.mpd.2021.label$state <- paste("natural", br.ses.mpd.2021.label$state)
br.ses.mpd.2021.label <- br.ses.mpd.2021.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2021
silwood.ses.mpd.2021 <- .ses.mpd(s.c.data2021)$mpd.obs.z
silwood.ses.mpd.2021[is.na(silwood.ses.mpd.2021)] <- 0
site_names <- rownames(s.c.data2021$comm)
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = silwood.ses.mpd.2021)
silwood2021.ses.mpd.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
silwood2021.ses.mpd.label <- silwood2021.ses.mpd.label %>%
  mutate(
    plot = site,    
    site = "Silwood_Park" 
  ) 
silwood2021.ses.mpd.label$year <- paste("2021", silwood2021.ses.mpd.label$year)
silwood2021.ses.mpd.label$state <- paste("natural", silwood2021.ses.mpd.label$state)
silwood2021.ses.mpd.label <- silwood2021.ses.mpd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood2021.ses.mpd.label <- silwood2021.ses.mpd.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Silwood 2022
silwood.ses.mpd.2022 <- .ses.mpd(s.c.data2022)$mpd.obs.z
silwood.ses.mpd.2022[is.na(silwood.ses.mpd.2022)] <- 0
site_names <- rownames(s.c.data2022$comm)
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = silwood.ses.mpd.2022)
silwood.ses.mpd.2022.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
silwood.ses.mpd.2022.label <- silwood.ses.mpd.2022.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood.ses.mpd.2022.label$year <- paste("2022", silwood.ses.mpd.2022.label$year)
silwood.ses.mpd.2022.label$state <- paste("natural", silwood.ses.mpd.2022.label$state)
silwood.ses.mpd.2022.label <- silwood.ses.mpd.2022.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood.ses.mpd.2022.label <- silwood.ses.mpd.2022.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Silwood 2023
silwood.ses.mpd.2023 <- .ses.mpd(s.c.data2023)$mpd.obs.z
silwood.ses.mpd.2023[is.na(silwood.ses.mpd.2023)] <- 0
site_names <- rownames(s.c.data2023$comm)
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = silwood.ses.mpd.2023)
silwood.ses.mpd.2023.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
silwood.ses.mpd.2023.label <- silwood.ses.mpd.2023.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood.ses.mpd.2023.label$year <- paste("2023", silwood.ses.mpd.2023.label$year)
silwood.ses.mpd.2023.label$state <- paste("natural", silwood.ses.mpd.2023.label$state)
silwood.ses.mpd.2023.label <- silwood.ses.mpd.2023.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood.ses.mpd.2023.label <- silwood.ses.mpd.2023.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Harolds Park Farm 2024
hpf.ses.mpd.2024 <- .ses.mpd(hpf.c.data2024)$mpd.obs.z
hpf.ses.mpd.2024[is.na(hpf.ses.mpd.2024)] <- 0
site_names <- rownames(hpf.c.data2024$comm) 
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = hpf.ses.mpd.2024)
hpf.ses.mpd.2024.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(hpf.ses.mpd.2024.label)
hpf.ses.mpd.2024.label <- hpf.ses.mpd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ",extra="merge")

hpf.ses.mpd.2024.label$year <- paste("2024", hpf.ses.mpd.2024.label$year)
hpf.ses.mpd.2024.label$state <- paste("early", hpf.ses.mpd.2024.label$state)
hpf.ses.mpd.2024.label <- hpf.ses.mpd.2024.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,
    TRUE ~ NA_real_  
  ))
hpf.ses.mpd.2024.label <- hpf.ses.mpd.2024.label %>%
  mutate(group = NA)
hpf.ses.mpd.2024.label <- hpf.ses.mpd.2024.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# Hepple 2024
hep.ses.mpd.2024 <- .ses.mpd(hep.c.data2024)$mpd.obs.z
hep.ses.mpd.2024[is.na(hep.ses.mpd.2024)] <- 0
site_names <- rownames(hep.c.data2024$comm)  
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = hep.ses.mpd.2024)
hep.ses.mpd.2024.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(hep.ses.mpd.2024.label)
hep.ses.mpd.2024.label <- hep.ses.mpd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
hep.ses.mpd.2024.label$year <- paste("2024", hep.ses.mpd.2024.label$year)
hep.ses.mpd.2024.label$state <- paste("early", hep.ses.mpd.2024.label$state)
hep.ses.mpd.2024.label$rewilding_age <- paste("3", hep.ses.mpd.2024.label$rewilding_age)
hep.ses.mpd.2024.label <- hep.ses.mpd.2024.label %>%
  mutate(group = NA)
hep.ses.mpd.2024.label <- hep.ses.mpd.2024.label %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

# High Fen 
high_fen.ses.mpd <- .ses.mpd(high_fen.c.data)$mpd.obs.z
high_fen.ses.mpd[is.na(high_fen.ses.mpd)] <- 0
site_names <- rownames(high_fen.c.data$comm) 
ses.mpd_per_site <- data.frame(site = site_names, ses.mpd = high_fen.ses.mpd)
high_fen.ses.mpd.label <- ses.mpd_per_site[order(ses.mpd_per_site$site), ]
print(high_fen.ses.mpd.label)
high_fen.ses.mpd.label <- high_fen.ses.mpd.label %>%
  separate(site, into = c("site","plot"), sep = " ")
high_fen.ses.mpd.label$year <- paste("2024", high_fen.ses.mpd.label$year)
high_fen.ses.mpd.label$state <- paste("early", high_fen.ses.mpd.label$state)
high_fen.ses.mpd.label$rewilding_age <- paste("2", high_fen.ses.mpd.label$rewilding_age)
high_fen.ses.mpd.label <- high_fen.ses.mpd.label %>%
  mutate(group = NA, block = NA)
high_fen.ses.mpd.label <- high_fen.ses.mpd.label %>%
  mutate(ses.mpd = replace_na(ses.mpd, 0))

# Combine
combined_ses.mpd <- rbind(k.ses.mpd.2022.label,k.ses.mpd.2023.label, k.ses.mpd.2024.label, b.ses.mpd.2022.label, b.ses.mpd.2023.label,b.ses.mpd.2024.label, br.ses.mpd.2021.label, silwood2021.ses.mpd.label, silwood.ses.mpd.2022.label,silwood.ses.mpd.2023.label, hpf.ses.mpd.2024.label, hep.ses.mpd.2024.label, high_fen.ses.mpd.label)

#Replace NA values in the ses.mntd column with zero
combined_ses.mpd <- combined_ses.mpd %>%
 mutate(ses.mpd = replace_na(ses.mpd, 0))

hist(combined_ses.mpd$ses.mpd)

write.csv(combined_ses.mpd, file = "metric_calcs_final/combined_ses.mpd.csv", row.names = F)

```

```{r SES MNTD}

# Knepp 2022
k.ses.mntd.2022 <- .ses.mntd(k.c.data2022)$mntd.obs.z
k.ses.mntd.2022[is.na(k.ses.mntd.2022)] <- 0
site_names <- rownames(k.c.data2022$comm) 
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = k.ses.mntd.2022)
k.ses.mntd.2022.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(k.ses.mntd.2022.label)
k.ses.mntd.2022.label <- k.ses.mntd.2022.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mntd.2022.label$year <- paste("2022", k.ses.mntd.2022.label$year)
k.ses.mntd.2022.label$state <- paste("late", k.ses.mntd.2022.label$state)
k.ses.mntd.2022.label <- k.ses.mntd.2022.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~21,
    block %in% c("M", "N") ~ 18,
    TRUE ~ NA_real_  
  ))
k.ses.mntd.2022.label <- k.ses.mntd.2022.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))
k.ses.mntd.2022.label <- k.ses.mntd.2022.label %>%
  mutate(group = NA)

# Knepp 2023
k.ses.mntd.2023 <- .ses.mntd(k.c.data2023)$mntd.obs.z
k.ses.mntd.2023[is.na(k.ses.mntd.2023)] <- 0
site_names <- rownames(k.c.data2023$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = k.ses.mntd.2023)
k.ses.mntd.2023.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(k.ses.mntd.2023.label)
k.ses.mntd.2023.label <- k.ses.mntd.2023.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mntd.2023.label$year <- paste("2023", k.ses.mntd.2023.label$year)
k.ses.mntd.2023.label$state <- paste("late", k.ses.mntd.2023.label$state)
k.ses.mntd.2023.label <- k.ses.mntd.2023.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 22,
    block %in% c("M", "N") ~ 19,
    TRUE ~ NA_real_  
  ))
k.ses.mntd.2023.label <- k.ses.mntd.2023.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))
k.ses.mntd.2023.label <- k.ses.mntd.2023.label %>%
  mutate(group = NA)

# Knepp 2024
k.ses.mntd.2024 <- .ses.mntd(k.c.data2024)$mntd.obs.z
k.ses.mntd.2024[is.na(k.ses.mntd.2024)] <- 0
site_names <- rownames(k.c.data2024$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = k.ses.mntd.2024)
k.ses.mntd.2024.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(k.ses.mntd.2024.label)
k.ses.mntd.2024.label <- k.ses.mntd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
k.ses.mntd.2024.label$year <- paste("2024", k.ses.mntd.2024.label$year)
k.ses.mntd.2024.label$state <- paste("late", k.ses.mntd.2024.label$state)
k.ses.mntd.2024.label <- k.ses.mntd.2024.label %>%
  mutate(rewilding_age = case_when(
    block %in% c("SX", "SY", "SZ") ~ 23,
    block %in% c("M", "N") ~ 20,
    TRUE ~ NA_real_  
  ))
k.ses.mntd.2024.label <- k.ses.mntd.2024.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))
k.ses.mntd.2024.label <- k.ses.mntd.2024.label %>%
  mutate(group = NA)

# Boothby 2022
b.ses.mntd.2022 <- .ses.mntd(b.c.data2022)$mntd.obs.z
b.ses.mntd.2022[is.na(b.ses.mntd.2022)] <- 0
site_names <- rownames(b.c.data2022$comm) 
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = b.ses.mntd.2022)
b.ses.mntd.2022.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(b.ses.mntd.2022.label)
b.ses.mntd.2022.label <- b.ses.mntd.2022.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mntd.2022.label$year <- paste("2022", b.ses.mntd.2022.label$year)
b.ses.mntd.2022.label$state <- paste("early", b.ses.mntd.2022.label$state)
b.ses.mntd.2022.label <- b.ses.mntd.2022.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,
    TRUE ~ NA_real_  
  ))
b.ses.mntd.2022.label <- b.ses.mntd.2022.label %>%
  mutate(group = NA)
b.ses.mntd.2022.label <- b.ses.mntd.2022.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Boothby 2023
b.ses.mntd.2023 <- .ses.mntd(b.c.data2023)$mntd.obs.z
b.ses.mntd.2023[is.na(b.ses.mntd.2023)] <- 0
site_names <- rownames(b.c.data2023$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = b.ses.mntd.2023)
b.ses.mntd.2023.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(b.ses.mntd.2023.label)
b.ses.mntd.2023.label <- b.ses.mntd.2023.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mntd.2023.label$year <- paste("2023", b.ses.mntd.2023.label$year)
b.ses.mntd.2023.label$state <- paste("early", b.ses.mntd.2023.label$state)
b.ses.mntd.2023.label <- b.ses.mntd.2023.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 1,
    TRUE ~ NA_real_ 
  ))
b.ses.mntd.2023.label <- b.ses.mntd.2023.label %>%
  mutate(group = NA)
b.ses.mntd.2023.label <- b.ses.mntd.2023.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Bootby 2024
b.ses.mntd.2024 <- .ses.mntd(b.c.data2024)$mntd.obs.z
b.ses.mntd.2024[is.na(b.ses.mntd.2024)] <- 0
site_names <- rownames(b.c.data2024$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = b.ses.mntd.2024)
b.ses.mntd.2024.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(b.ses.mntd.2024.label)
b.ses.mntd.2024.label <- b.ses.mntd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
b.ses.mntd.2024.label$year <- paste("2024", b.ses.mntd.2024.label$year)
b.ses.mntd.2024.label$state <- paste("early", b.ses.mntd.2024.label$state)
b.ses.mntd.2024.label <- b.ses.mntd.2024.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 2,
    TRUE ~ NA_real_  
  ))
b.ses.mntd.2024.label <- b.ses.mntd.2024.label %>%
  mutate(group = NA)
b.ses.mntd.2024.label <- b.ses.mntd.2024.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Budworth 2021
br.ses.mntd.2021 <- .ses.mntd(br.c.data2021)$mntd.obs.z
site_names <- rownames(br.c.data2021$comm)
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = br.ses.mntd.2021)
br.ses.mntd.2021.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
br.ses.mntd.2021.label <- br.ses.mntd.2021.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
br.ses.mntd.2021.label$year <- paste("2021", br.ses.mntd.2021.label$year)
br.ses.mntd.2021.label$state <- paste("natural", br.ses.mntd.2021.label$state)
br.ses.mntd.2021.label <- br.ses.mntd.2021.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)

# Silwood 2021
silwood.ses.mntd.2021 <- .ses.mntd(s.c.data2021)$mntd.obs.z
silwood.ses.mntd.2021[is.na(silwood.ses.mntd.2021)] <- 0
site_names <- rownames(s.c.data2021$comm)
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = silwood.ses.mntd.2021)
silwood2021.ses.mntd.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
silwood2021.ses.mntd.label <- silwood2021.ses.mntd.label %>%
  mutate(
    plot = site,    
    site = "Silwood_Park"  
  ) 
silwood2021.ses.mntd.label$year <- paste("2021", silwood2021.ses.mntd.label$year)
silwood2021.ses.mntd.label$state <- paste("natural", silwood2021.ses.mntd.label$state)
silwood2021.ses.mntd.label <- silwood2021.ses.mntd.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood2021.ses.mntd.label <- silwood2021.ses.mntd.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Silwood 2022
silwood.ses.mntd.2022 <- .ses.mntd(s.c.data2022)$mntd.obs.z
silwood.ses.mntd.2022[is.na(silwood.ses.mntd.2022)] <- 0
site_names <- rownames(s.c.data2022$comm)
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = silwood.ses.mntd.2022)
silwood.ses.mntd.2022.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
silwood.ses.mntd.2022.label <- silwood.ses.mntd.2022.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood.ses.mntd.2022.label$year <- paste("2022", silwood.ses.mntd.2022.label$year)
silwood.ses.mntd.2022.label$state <- paste("natural", silwood.ses.mntd.2022.label$state)
silwood.ses.mntd.2022.label <- silwood.ses.mntd.2022.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood.ses.mntd.2022.label <- silwood.ses.mntd.2022.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Silwood 2023
silwood.ses.mntd.2023 <- .ses.mntd(s.c.data2023)$mntd.obs.z
silwood.ses.mntd.2023[is.na(silwood.ses.mntd.2023)] <- 0
site_names <- rownames(s.c.data2023$comm)
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = silwood.ses.mntd.2023)
silwood.ses.mntd.2023.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
silwood.ses.mntd.2023.label <- silwood.ses.mntd.2023.label %>%
  separate(site, into = c("site", "plot"), sep = " ")
silwood.ses.mntd.2023.label$year <- paste("2023", silwood.ses.mntd.2023.label$year)
silwood.ses.mntd.2023.label$state <- paste("natural", silwood.ses.mntd.2023.label$state)
silwood.ses.mntd.2023.label <- silwood.ses.mntd.2023.label %>%
  mutate(group = NA, block = NA, rewilding_age = NA)
silwood.ses.mntd.2023.label <- silwood.ses.mntd.2023.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Harolds Park Farm 2024
hpf.ses.mntd.2024 <- .ses.mntd(hpf.c.data2024)$mntd.obs.z
hpf.ses.mntd.2024[is.na(hpf.ses.mntd.2024)] <- 0
site_names <- rownames(hpf.c.data2024$comm) 
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = hpf.ses.mntd.2024)
hpf.ses.mntd.2024.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(hpf.ses.mntd.2024.label)
hpf.ses.mntd.2024.label <- hpf.ses.mntd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ", extra="merge")

hpf.ses.mntd.2024.label$year <- paste("2024", hpf.ses.mntd.2024.label$year)
hpf.ses.mntd.2024.label$state <- paste("early", hpf.ses.mntd.2024.label$state)
hpf.ses.mntd.2024.label <- hpf.ses.mntd.2024.label %>%
  mutate(rewilding_age = case_when(
    TRUE ~ 0,
    TRUE ~ NA_real_  
  ))
hpf.ses.mntd.2024.label <- hpf.ses.mntd.2024.label %>%
  mutate(group = NA)
hpf.ses.mntd.2024.label <- hpf.ses.mntd.2024.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# Hepple 2024
hep.ses.mntd.2024 <- .ses.mntd(hep.c.data2024)$mntd.obs.z
hep.ses.mntd.2024[is.na(hep.ses.mntd.2024)] <- 0
site_names <- rownames(hep.c.data2024$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = hep.ses.mntd.2024)
hep.ses.mntd.2024.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(hep.ses.mntd.2024.label)
hep.ses.mntd.2024.label <- hep.ses.mntd.2024.label %>%
  separate(site, into = c("site", "block", "plot"), sep = " ")
hep.ses.mntd.2024.label$year <- paste("2024", hep.ses.mntd.2024.label$year)
hep.ses.mntd.2024.label$state <- paste("early", hep.ses.mntd.2024.label$state)
hep.ses.mntd.2024.label$rewilding_age <- paste("3", hep.ses.mntd.2024.label$rewilding_age )
hep.ses.mntd.2024.label <- hep.ses.mntd.2024.label %>%
  mutate(group = NA)
hep.ses.mntd.2024.label <- hep.ses.mntd.2024.label %>%
 mutate(ses.mntd = replace_na(ses.mntd, 0))

# High Fen 2024
high_fen.ses.mntd <- .ses.mntd(high_fen.c.data)$mntd.obs.z
high_fen.ses.mntd[is.na(high_fen.ses.mntd)] <- 0
site_names <- rownames(high_fen.c.data$comm)  
ses.mntd_per_site <- data.frame(site = site_names, ses.mntd = high_fen.ses.mntd)
high_fen.ses.mntd.label <- ses.mntd_per_site[order(ses.mntd_per_site$site), ]
print(high_fen.ses.mntd.label)
high_fen.ses.mntd.label <- high_fen.ses.mntd.label %>%
  separate(site, into = c("site","plot"), sep = " ")
high_fen.ses.mntd.label$year <- paste("2024", high_fen.ses.mntd.label$year)
high_fen.ses.mntd.label$state <- paste("early", high_fen.ses.mntd.label$state)
high_fen.ses.mntd.label$rewilding_age <- paste("2", high_fen.ses.mntd.label$rewilding_age)
high_fen.ses.mntd.label <- high_fen.ses.mntd.label %>%
  mutate(group = NA, block =NA)
high_fen.ses.mntd.label <- high_fen.ses.mntd.label %>%
  mutate(ses.mntd = replace_na(ses.mntd, 0))

# Combine
combined_ses.mntd <- rbind(k.ses.mntd.2022.label, k.ses.mntd.2023.label, k.ses.mntd.2024.label, b.ses.mntd.2022.label,b.ses.mntd.2023.label, b.ses.mntd.2024.label,  br.ses.mntd.2021.label, silwood2021.ses.mntd.label, silwood.ses.mntd.2022.label,silwood.ses.mntd.2023.label, hpf.ses.mntd.2024.label, hep.ses.mntd.2024.label, high_fen.ses.mntd.label)

# Replace NA values in the ses.mntd column with zero
combined_ses.mntd <- combined_ses.mntd %>%
mutate(ses.mntd = replace_na(ses.mntd, 0))

hist(combined_ses.mntd$ses.mntd)

write.csv(combined_ses.mntd, file = "metric_calcs_final/combined_ses.mntd.csv", row.names = F)

```

```{r Load metric calcs}

combined_rich <- read.csv("metric_calcs_final/combined_rich.csv")
combined_pd <- read.csv("metric_calcs_final/combined_pd.csv")
combined_simpson <- read.csv("metric_calcs_final/combined_simpson.csv")
combined_inv_simpson <- read.csv("metric_calcs_final/combined_inv_simpson.csv")
combined_ses.mpd <- read.csv("metric_calcs_final/combined_ses.mpd.csv")
combined_ses.mntd <- read.csv("metric_calcs_final/combined_ses.mntd.csv")

# format
combined_rich$block <- trimws(combined_rich$block)
combined_rich <- combined_rich %>%
  mutate(block = na_if(block, "NA"))
combined_pd$block <- trimws(combined_pd$block)
combined_pd <- combined_pd %>%
  mutate(block = na_if(block, "NA"))
combined_simpson$block <- trimws(combined_simpson$block)
combined_simpson <- combined_simpson %>%
  mutate(block = na_if(block, "NA"))
combined_inv_simpson$block <- trimws(combined_inv_simpson$block)
combined_inv_simpson <- combined_inv_simpson %>%
  mutate(block = na_if(block, "NA"))

# combine
combined_tax_phylo <- combined_rich %>%
  left_join(combined_pd, by = c("site", "block", "group", "plot", "year", "state", "rewilding_age")) %>%
  left_join(combined_simpson, by = c("site", "block", "group", "plot", "year", "state", "rewilding_age")) %>%
  left_join(combined_inv_simpson, by = c("site", "block", "group", "plot", "year", "state", "rewilding_age")) %>%
  left_join(combined_ses.mpd, by = c("site", "block", "group", "plot", "year", "state", "rewilding_age")) %>%
  left_join(combined_ses.mntd, by = c("site", "block", "group", "plot", "year", "state", "rewilding_age"))

# remove trailing spaces
combined_tax_phylo <- combined_tax_phylo %>%
  mutate(site = trimws(site),
         block = trimws(block),
         plot = trimws(plot))

combined_inv_simpson <- combined_inv_simpson %>%
  mutate(site = trimws(site),
         block = trimws(block),
         plot = trimws(plot))

# check the unique values for differences
unique_tax_phylo <- combined_tax_phylo %>%
  dplyr::select(site, block, plot,year) %>%
  distinct()

unique_inv_simpson <- combined_inv_simpson %>%
  dplyr::select(site, block, plot,year) %>%
  distinct()

# view
print(unique_tax_phylo)
print(unique_inv_simpson)

# merge again
merged_df <- combined_tax_phylo %>%
  left_join(combined_inv_simpson %>% dplyr::select(site, block, plot, year,invsimpsons), 
            by = c("site", "block", "plot","year"))

head(merged_df) # this worked better

# rename 
combined_tax_phylo <- merged_df

# remove 'inv.simpsons.y' and rename other
combined_tax_phylo <- combined_tax_phylo %>% dplyr::select(-invsimpsons.y)
combined_tax_phylo <- combined_tax_phylo %>% dplyr::rename(invsimpsons = invsimpsons.x)

rows_with_zero <- combined_tax_phylo[combined_tax_phylo$invsimpsons == 0, ]
print(rows_with_zero)

# View the combined data frame and histograms 
head(combined_tax_phylo)
hist(combined_tax_phylo$richness)
hist(combined_tax_phylo$simpsons)
hist(combined_tax_phylo$invsimpsons)
hist(combined_tax_phylo$pd)
hist(combined_tax_phylo$ses.mpd)
hist(combined_tax_phylo$ses.mntd)

```

```{r Averaged across sites}

# average values for knepp by block
avg_pd_knepp_block <- k2022.pd.label %>%
  group_by(block) %>%
  summarise(
    avg_pd = mean(pd, na.rm = TRUE))

avg_simpson_knepp_block <- k2022.simpson.label %>%
  group_by(block) %>%
  summarise(
    avg_pd = mean(simpsons, na.rm = TRUE))

avg_rich_knepp_block <- k2022.rich.label %>%
  group_by(block) %>%
  summarise(
    avg_rich = mean(richness, na.rm = TRUE))

avg_mpd_knepp_block <- k.ses.mpd.2022.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mpd = mean(ses.mpd, na.rm = TRUE))


avg_mntd_knepp_block <- k.ses.mntd.2022.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mntd = mean(ses.mntd, na.rm = TRUE)
  )

# combine into a single data frame
combined_knepp_block <- avg_pd_knepp_block %>%
  left_join(avg_simpson_knepp_block, by = "block") %>%
  left_join(avg_rich_knepp_block, by = "block") %>%
  left_join(avg_mpd_knepp_block, by = "block") %>%
  left_join(avg_mntd_knepp_block, by = "block")

# add site and age columns 
combined_knepp_block <- combined_knepp_block %>%
  mutate(
    Site = "Knepp",
    age = case_when(
      block == "M" ~ 18,
      block == "N" ~ 18,
      block %in% c("SX", "SY", "SZ") ~ 21,
      TRUE ~ NA_real_
    )
  )

# renaming columns in combined_knepp_block
combined_knepp_block <- combined_knepp_block %>%
  rename(Age = age,
    Richness = avg_rich,
    PD = avg_pd.x,  
    Simpsons = avg_pd.y, 
    SES_MPD = avg_ses_mpd,
    SES_MNTD = avg_ses_mntd
  )

# format
combined_knepp_block$Age <- as.character(combined_knepp_block$Age)

# repeat for k 2023
avg_pd_k2023_block <- k2023.pd.label %>%
  group_by(block) %>%
  summarise(
    avg_pd = mean(pd, na.rm = TRUE)
  )

avg_simpson_k2023_block <- k2023.simpson.label %>%
  group_by(block) %>%
  summarise(
    avg_simpson = mean(simpsons, na.rm = TRUE)
  )

avg_rich_k2023_block <- k2023.rich.label %>%
  group_by(block) %>%
  summarise(
    avg_rich = mean(richness, na.rm = TRUE)
  )

avg_mpd_k2023_block <- k.ses.mpd.2023.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mpd = mean(ses.mpd, na.rm = TRUE)
  )

avg_mntd_k2023_block <- k.ses.mntd.2023.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mntd = mean(ses.mntd, na.rm = TRUE)
  )

combined_k2023_block <- avg_pd_k2023_block %>%
  left_join(avg_simpson_k2023_block, by = "block") %>%
  left_join(avg_rich_k2023_block, by = "block") %>%
  left_join(avg_mpd_k2023_block, by = "block") %>%
  left_join(avg_mntd_k2023_block, by = "block")

combined_k2023_block <- combined_k2023_block %>%
  mutate(
    Site = "Knepp",
    Age = case_when(
      block == "M" ~ 19,
      block == "N" ~ 19,
      block %in% c("SX", "SY", "SZ") ~ 22,
      TRUE ~ NA_real_
    )
  )

combined_k2023_block <- combined_k2023_block %>%
  rename(
    Richness = avg_rich,
    PD = avg_pd,
    Simpsons = avg_simpson,
    SES_MPD = avg_ses_mpd,
    SES_MNTD = avg_ses_mntd
  )

combined_k2023_block$Age <- as.character(combined_k2023_block$Age)

# k 2024
avg_pd_k2024_block <- k2024.pd.label %>%
  group_by(block) %>%
  summarise(
    avg_pd = mean(pd, na.rm = TRUE)
  )

avg_simpson_k2024_block <- k2024.simpson.label %>%
  group_by(block) %>%
  summarise(
    avg_simpson = mean(simpsons, na.rm = TRUE)
  )

avg_rich_k2024_block <- k2024.rich.label %>%
  group_by(block) %>%
  summarise(
    avg_rich = mean(richness, na.rm = TRUE)
  )

avg_mpd_k2024_block <- k.ses.mpd.2024.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mpd = mean(ses.mpd, na.rm = TRUE)
  )

avg_mntd_k2024_block <- k.ses.mntd.2024.label %>%
  group_by(block) %>%
  summarise(
    avg_ses_mntd = mean(ses.mntd, na.rm = TRUE)
  )

combined_k2024_block <- avg_pd_k2024_block %>%
  left_join(avg_simpson_k2024_block, by = "block") %>%
  left_join(avg_rich_k2024_block, by = "block") %>%
  left_join(avg_mpd_k2024_block, by = "block") %>%
  left_join(avg_mntd_k2024_block, by = "block")

combined_k2024_block <- combined_k2024_block %>%
  mutate(
    Site = "Knepp",
    Age = case_when(
      block == "M" ~ 20,
      block == "N" ~ 20,
      block %in% c("SX", "SY", "SZ") ~ 23,
      TRUE ~ NA_real_
    )
  )

combined_k2024_block <- combined_k2024_block %>%
  rename(
    Richness = avg_rich,
    PD = avg_pd,
    Simpsons = avg_simpson,
    SES_MPD = avg_ses_mpd,
    SES_MNTD = avg_ses_mntd
  )

combined_k2024_block$Age <- as.character(combined_k2024_block$Age)

# combine all and add year for identification 
combined_knepp_by_block_all <- rbind(
  mutate(combined_knepp_block, Year = 2022),  
  mutate(combined_k2023_block, Year = 2023),
  mutate(combined_k2024_block, Year = 2024)
)

head(combined_knepp_by_block_all)

#  average richness
avg_richness <- c(mean(b2022.rich), mean(b2023.rich), mean(b2024.rich), mean(k2022.rich), mean(k2023.rich), mean(k2024.rich), mean(br2021.rich), mean(silwood2021.rich), mean(silwood2022.rich),mean(silwood2023.rich),  mean(hpf2024.rich), mean(hep2024.rich), mean(high_fen.rich))

#  average pd
avg_pd <- c(
  mean(b2022.pd), mean(b2023.pd), mean(b2024.pd),
  mean(k2022.pd), mean(k2023.pd), mean(k2024.pd), 
  mean(br2021.pd), 
  mean(silwood2021.pd), 
  mean(silwood2022.pd), mean(silwood2023.pd), 
   mean(hpf2024.pd), mean(hep2024.pd), mean(high_fen.pd)
)

# average simpson
avg_simpson <- c(
  mean(b2022.simpson),mean(b2023.simpson), mean(b2024.simpson),
  mean(k2022.simpson),mean(k2023.simpson), mean(k2024.simpson),
  mean(br2021.simpson),
  mean(silwood2021.simpson),
  mean(silwood2022.simpson), mean(silwood2023.simpson),
   mean(hpf2024.simpson), mean(hep2024.simpson), mean(high_fen.simpson))

# avg ses mpd
avg_ses_mpd <- c(
  mean(b.ses.mpd.2022),  mean(b.ses.mpd.2023),   mean(b.ses.mpd.2024),
  mean(k.ses.mpd.2022),mean(k.ses.mpd.2023), mean(k.ses.mpd.2024),
  mean(br.ses.mpd.2021),
  mean(silwood.ses.mpd.2021),
  mean(silwood.ses.mpd.2022),mean(silwood.ses.mpd.2023),
 mean(hpf.ses.mpd.2024), mean(hep.ses.mpd.2024), mean(high_fen.ses.mpd))

# mntd
avg_ses_mntd <- c(
 mean(b.ses.mntd.2022),mean(b.ses.mntd.2023), mean(b.ses.mntd.2024),
 mean(k.ses.mntd.2022),mean(k.ses.mntd.2023), mean(k.ses.mntd.2024),
 mean(br.ses.mntd.2021),
 mean(silwood.ses.mntd.2021),
 mean(silwood.ses.mntd.2022),mean(silwood.ses.mntd.2023),
 mean(hep.ses.mntd.2024), mean(hep.ses.mntd.2024), mean(high_fen.ses.mntd))

# create a data frame for plotting
metric_data <- data.frame(
  Site = c("Boothby 2022","Boothby 2023", "Boothby 2024", "Knepp 2022", "Knepp 2023", "Knepp 2024", "Budworth","Silwood 2021", "Silwood 2022","Silwood 2023", "HPF", "Hepple", "High Fen"),
    Age = c("0","1", "2", "18","19","20", "Natural","Natural","Natural","Natural", "0","3", "2"),
  Richness = avg_richness,
  PD = avg_pd, Simpsons = avg_simpson, SES_MPD = avg_ses_mpd, SES_MNTD = avg_ses_mntd
)

write.csv(metric_data, file = "metric_calcs_final/metric_data.csv", row.names = F)
write.csv(combined_knepp_block, file = "metric_calcs_final/metric_data_knepp.csv", row.names = F)
```

```{r Load metrics averaged}
metric_data <- read.csv("metric_calcs_final/metric_data.csv")
tp_metric_data_knepp <- read.csv("metric_calcs_final/metric_data_knepp.csv")
```

```{r Knepp matrix community data}

# calculate the mean cover of each species within combinations of Block, Group, and Plot
# create a matrix where rows represent these combinations and columns represent species, with each cell containing the mean cover value
betaknepp2022 <- with(knepp_2022_clean, tapply(Cover, list(paste(Block,Plot, sep=""), Species), mean, rm.na=TRUE))

# replace missing values with 0
betaknepp2022[is.na(betaknepp2022)] <- 0

# remove any occurrences of 0 from row names 
rownames(betaknepp2022) <- gsub("0", "", rownames(betaknepp2022), fixed = TRUE)

# convert to dataframe and save 
betaknepp2022 <- as.data.frame(betaknepp2022)
saveRDS(betaknepp2022, "clean_data/betaknepp2022.RDS")

# load data about sampling coordinates
k.map2022 <- read.csv("ecofrac-rawdata/k-map.csv")

# remove entries where ID is blank
k.map2022 <- subset(k.map2022, k.map2022$uniqueID != "")

# set row names of map data to be unique ID tags and save 
row.names(k.map2022) <- k.map2022$uniqueID
saveRDS(k.map2022, "clean_data/k.map2022.RDS")

# load data 
betaknepp2022_clean <- readRDS("clean_data/betaknepp2022.RDS")

# per block
site_names <- rownames(betaknepp2022_clean)
betaknepp2022_clean_M<-betaknepp2022_clean[grep("^M", site_names), ]
betaknepp2022_clean_N<-betaknepp2022_clean[grep("^N", site_names), ]
betaknepp2022_clean_S<-betaknepp2022_clean[grep("^S", site_names), ]

k.map2022_clean <- readRDS("clean_data/k.map2022.RDS")

# checking the only site differences between the map and the plant dataset are the * ones
# identify the row names that exist in k.map2022_clean but not in betaknepp2022_clean
setdiff(rownames(k.map2022_clean), rownames(betaknepp2022_clean))

# ensure both dataframes have same row names 
setdiff(rownames(betaknepp2022_clean), rownames(k.map2022_clean))
betaknepp2022_clean <- betaknepp2022_clean[rownames(betaknepp2022_clean) %in% rownames(k.map2022_clean),]
k.map2022_clean <- k.map2022_clean[rownames(k.map2022_clean) %in% rownames(betaknepp2022_clean),]
betaknepp2022_clean <- betaknepp2022_clean[match(rownames(k.map2022_clean), rownames(betaknepp2022_clean)),]
identical(rownames(betaknepp2022_clean), rownames(k.map2022_clean))

# save
saveRDS(k.map2022_clean, "clean_data/k.map2022_clean.RDS")
saveRDS(betaknepp2022_clean, "clean_data/betaknepp2022_clean.RDS")
saveRDS(betaknepp2022_clean_M, "clean_data/betaknepp2022_clean_M.RDS")
saveRDS(betaknepp2022_clean_N, "clean_data/betaknepp2022_clean_N.RDS")
saveRDS(betaknepp2022_clean_S, "clean_data/betaknepp2022_clean_S.RDS")


# 2023
betaknepp2023 <- with(knepp_2023_clean, tapply(Cover, list(paste(Block,Plot, sep=""), Species), mean, rm.na=TRUE))
betaknepp2023[is.na(betaknepp2023)] <- 0
rownames(betaknepp2023) <- gsub("0", "", rownames(betaknepp2023), fixed = TRUE)
betaknepp2023 <- as.data.frame(betaknepp2023)
saveRDS(betaknepp2023, "clean_data/betaknepp2023.RDS")
k.map2023 <- read.csv("ecofrac-rawdata/k-map.csv")
k.map2023 <- subset(k.map2023, k.map2023$uniqueID != "")
row.names(k.map2023) <- k.map2023$uniqueID
saveRDS(k.map2023, "clean_data/k.map2023.RDS")
betaknepp2023_clean <- readRDS("clean_data/betaknepp2023.RDS")
site_names <- rownames(betaknepp2023_clean)
betaknepp2023_clean_M<-betaknepp2023_clean[grep("^M", site_names), ]
betaknepp2023_clean_N<-betaknepp2023_clean[grep("^N", site_names), ]
betaknepp2023_clean_S<-betaknepp2023_clean[grep("^S", site_names), ]

k.map2023_clean <- readRDS("clean_data/k.map2023.RDS")

# save
saveRDS(betaknepp2023, "clean_data/betaknepp2023_clean.RDS")
saveRDS(betaknepp2023_clean_M, "clean_data/betaknepp2023_clean_M.RDS")
saveRDS(betaknepp2023_clean_N, "clean_data/betaknepp2023_clean_N.RDS")
saveRDS(betaknepp2023_clean_S, "clean_data/betaknepp2023_clean_S.RDS")


# 2024
betaknepp2024 <- with(knepp_2024_clean, tapply(Cover, list(paste(Block,Plot, sep=""), Species), mean, rm.na=TRUE))
betaknepp2024[is.na(betaknepp2024)] <- 0
rownames(betaknepp2024) <- gsub("0", "", rownames(betaknepp2024), fixed = TRUE)
betaknepp2024 <- as.data.frame(betaknepp2024)
saveRDS(betaknepp2024, "clean_data/betaknepp2024.RDS")
k.map2024 <- read.csv("ecofrac-rawdata/k-map.csv")
k.map2024 <- subset(k.map2024, k.map2024$uniqueID != "")
row.names(k.map2024) <- k.map2024$uniqueID
saveRDS(k.map2024, "clean_data/k.map2024.RDS")
betaknepp2024_clean <- readRDS("clean_data/betaknepp2024.RDS")
site_names <- rownames(betaknepp2024_clean)
betaknepp2024_clean_M<-betaknepp2024_clean[grep("^M", site_names), ]
betaknepp2024_clean_N<-betaknepp2024_clean[grep("^N", site_names), ]
betaknepp2024_clean_S<-betaknepp2024_clean[grep("^S", site_names), ]

k.map2024_clean <- readRDS("clean_data/k.map2024.RDS")

# save
saveRDS(betaknepp2024, "clean_data/betaknepp2024_clean.RDS")
saveRDS(betaknepp2024_clean_M, "clean_data/betaknepp2024_clean_M.RDS")
saveRDS(betaknepp2024_clean_N, "clean_data/betaknepp2024_clean_N.RDS")
saveRDS(betaknepp2024_clean_S, "clean_data/betaknepp2024_clean_S.RDS")


```

```{r Cleaning Knepp community data, running and separating into blocks}

betaknepp2022_clean <- readRDS("clean_data/betaknepp2022_clean.RDS")

# convert to a matrix
k.comm2022 <- as.matrix(betaknepp2022_clean)
site_names <- rownames(betaknepp2022_clean)

# split into separate data frames based on blocks
M.k.comm2022 <- k.comm2022[grep("^M", site_names), ]
N.k.comm2022 <- k.comm2022[grep("^N", site_names), ]
S.k.comm2022 <- k.comm2022[grep("^S", site_names), ]

# remove zero abundance columns 
all_zero_columns <- apply(k.comm2022, 2, function(x) all(x == 0))
k.comm2022 <- k.comm2022[, !all_zero_columns]

all_zero_columns <- apply(M.k.comm2022, 2, function(x) all(x == 0))
M.k.comm2022 <- M.k.comm2022[, !all_zero_columns]

all_zero_columns <- apply(N.k.comm2022, 2, function(x) all(x == 0))
N.k.comm2022 <- N.k.comm2022[, !all_zero_columns]

all_zero_columns <- apply(S.k.comm2022, 2, function(x) all(x == 0))
S.k.comm2022 <- S.k.comm2022[, !all_zero_columns]

# remove zero abundance rows
all_zero_rows <- apply(k.comm2022, 1, function(x) all(x == 0))
k.comm2022 <- k.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(M.k.comm2022, 1, function(x) all(x == 0))
M.k.comm2022 <- M.k.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(N.k.comm2022, 1, function(x) all(x == 0))
N.k.comm2022 <- N.k.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(S.k.comm2022, 1, function(x) all(x == 0))
S.k.comm2022 <- S.k.comm2022[!all_zero_rows, ]

#2023
betaknepp2023_clean <- readRDS("clean_data/betaknepp2023_clean.RDS")
k.comm2023 <- as.matrix(betaknepp2023_clean)
site_names <- rownames(betaknepp2023_clean)

M.k.comm2023 <- k.comm2023[grep("^M", site_names), ]
N.k.comm2023 <- k.comm2023[grep("^N", site_names), ]
S.k.comm2023 <- k.comm2023[grep("^S", site_names), ]

all_zero_columns <- apply(k.comm2023, 2, function(x) all(x == 0))
k.comm2023 <- k.comm2023[, !all_zero_columns]

all_zero_columns <- apply(M.k.comm2023, 2, function(x) all(x == 0))
M.k.comm2023 <- M.k.comm2023[, !all_zero_columns]

all_zero_columns <- apply(N.k.comm2023, 2, function(x) all(x == 0))
N.k.comm2023 <- N.k.comm2023[, !all_zero_columns]

all_zero_columns <- apply(S.k.comm2023, 2, function(x) all(x == 0))
S.k.comm2023 <- S.k.comm2023[, !all_zero_columns]

all_zero_rows <- apply(k.comm2023, 1, function(x) all(x == 0))

all_zero_rows <- apply(M.k.comm2023, 1, function(x) all(x == 0))

all_zero_rows <- apply(N.k.comm2023, 1, function(x) all(x == 0))

all_zero_rows <- apply(S.k.comm2023, 1, function(x) all(x == 0))

#2024
betaknepp2024_clean <- readRDS("clean_data/betaknepp2024_clean.RDS")
k.comm2024 <- as.matrix(betaknepp2024_clean)

site_names <- rownames(betaknepp2024_clean)

M.k.comm2024 <- k.comm2024[grep("^M", site_names), ]
N.k.comm2024 <- k.comm2024[grep("^N", site_names), ]
S.k.comm2024 <- k.comm2024[grep("^S", site_names), ]

all_zero_columns <- apply(k.comm2024, 2, function(x) all(x == 0))
k.comm2024 <- k.comm2024[, !all_zero_columns]

all_zero_columns <- apply(M.k.comm2024, 2, function(x) all(x == 0))
M.k.comm2024 <- M.k.comm2024[, !all_zero_columns]

all_zero_columns <- apply(N.k.comm2024, 2, function(x) all(x == 0))
N.k.comm2024 <- N.k.comm2024[, !all_zero_columns]

all_zero_columns <- apply(S.k.comm2024, 2, function(x) all(x == 0))
S.k.comm2024 <- S.k.comm2024[, !all_zero_columns]

```

```{r Boothby matrix community data}

betaboothby_2022 <- with(boothby_2022_clean, tapply(Cover, list(paste(Block,Plot, sep=""), Species), mean, rm.na=TRUE))
betaboothby_2022[is.na(betaboothby_2022)] <- 0
betaboothby_2022 <- as.data.frame(betaboothby_2022)
saveRDS(betaboothby_2022, "clean_data/betaboothby_2022.RDS")

b.map2022 <- read.csv("ecofrac-rawdata/b-map.csv")
b.map2022 <- subset(b.map2022, b.map2022$name != "")
row.names(b.map2022) <- b.map2022$name
b.map2022 <- subset(b.map2022, select = -c(layer,path,ID_SHAPE, ID_PART, ID_POINT, CLOCKWISE, LAKE, ID, fid, description))
saveRDS(b.map2022, "clean_data/b.map2022.RDS")

betaboothby2022_clean <- readRDS("clean_data/betaboothby_2022.RDS")
b.map2022_clean <- readRDS("clean_data/b.map2022.RDS")

setdiff(rownames(b.map2022_clean), rownames(betaboothby2022_clean))
setdiff(rownames(betaboothby2022_clean), rownames(b.map2022_clean))
betaboothby2022_clean <- betaboothby2022_clean[rownames(betaboothby2022_clean) %in% rownames(b.map2022_clean),]
b.map2022_clean <- b.map2022_clean[rownames(b.map2022_clean) %in% rownames(betaboothby2022_clean),]
betaboothby2022_clean <- betaboothby2022_clean[match(rownames(b.map2022_clean), rownames(betaboothby2022_clean)),]
identical(rownames(betaboothby2022_clean), rownames(b.map2022_clean))

saveRDS(b.map2022_clean, "clean_data/b.map2022_clean.RDS")
saveRDS(betaboothby2022_clean, "clean_data/betaboothby2022_clean.RDS")

# 2023
betaboothby_2023 <- with(boothby_2023_clean, tapply(Cover, list(paste(Block, Plot, sep=""), Species), function(x) mean(x, na.rm = TRUE)))
betaboothby_2023[is.na(betaboothby_2023)] <- 0
betaboothby_2023 <- as.data.frame(betaboothby_2023)
saveRDS(betaboothby_2023, "clean_data/betaboothby_2023.RDS")

# 2024
betaboothby_2024 <- with(boothby_2024_clean, tapply(Cover, list(paste(Block,Plot, sep=""), Species), mean, rm.na=TRUE))
betaboothby_2024[is.na(betaboothby_2024)] <- 0
betaboothby_2024 <- as.data.frame(betaboothby_2024)
saveRDS(betaboothby_2024, "clean_data/betaboothby_2024.RDS")
```

```{r Cleaning Boothby community data}

betaboothby2022_clean <- readRDS("clean_data/betaboothby2022_clean.RDS")
b.comm2022 <- as.matrix(betaboothby2022_clean)
b.comm2022[is.na(b.comm2022)] <- 0

site_names <- rownames(betaboothby2022_clean)

C.B.comm2022 <- b.comm2022[grep("^C", site_names), ]
NE.B.comm2022 <- b.comm2022[grep("^NE", site_names), ]
S.B.comm2022 <- b.comm2022[grep("^S", site_names), ]
NW.B.comm2022 <- b.comm2022[grep("^NW", site_names), ]

all_zero_columns <- apply(C.B.comm2022, 2, function(x) all(x == 0))
C.B.comm2022 <- C.B.comm2022[, !all_zero_columns]

all_zero_columns <- apply(NE.B.comm2022, 2, function(x) all(x == 0))
NE.B.comm2022 <- NE.B.comm2022[, !all_zero_columns]

all_zero_columns <- apply(S.B.comm2022, 2, function(x) all(x == 0))
S.B.comm2022 <- S.B.comm2022[, !all_zero_columns]

all_zero_columns <- apply(NW.B.comm2022, 2, function(x) all(x == 0))
NW.B.comm2022 <- NW.B.comm2022[, !all_zero_columns]

all_zero_rows <- apply(C.B.comm2022, 1, function(x) all(x == 0))
C.B.comm2022 <- C.B.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(NE.B.comm2022, 1, function(x) all(x == 0))
NE.B.comm2022 <- NE.B.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(S.B.comm2022, 1, function(x) all(x == 0))
S.B.comm2022 <- S.B.comm2022[!all_zero_rows, ]

all_zero_rows <- apply(NW.B.comm2022, 1, function(x) all(x == 0))
NW.B.comm2022 <- NW.B.comm2022[!all_zero_rows, ]

# calculate 
betadivboothby2022C <- beta.div(C.B.comm2022, method = "sorensen", samp=FALSE, save.D=TRUE)
saveRDS(betadivboothby2022C, file = "metric_calcs/betadivboothby2022C.rds")

betadivboothby2022NE <- beta.div(NE.B.comm2022, method = "sorensen", samp=FALSE, save.D=TRUE)
saveRDS(betadivboothby2022NE, file = "metric_calcs/betadivboothby2022NE.rds")

betadivboothby2022S <- beta.div(S.B.comm2022, method = "sorensen", samp=FALSE, save.D=TRUE)
saveRDS(betadivboothby2022S, file = "metric_calcs/betadivboothby2022S.rds")

betadivboothby2022NW <- beta.div(NW.B.comm2022, method = "sorensen", samp=FALSE, save.D=TRUE)
saveRDS(betadivboothby2022NW, file = "metric_calcs/betadivboothby2022NW.rds")

# 2023
betaboothby2023_clean <- readRDS("clean_data/betaboothby_2023.RDS")
b.comm2023 <- as.matrix(betaboothby2023_clean)
b.comm2023[is.na(b.comm2023)] <- 0

site_names <- rownames(betaboothby2023_clean)

# Split into separate data frames based on blocks
C.B.comm2023 <- b.comm2023[grep("^C", site_names), ]
NE.B.comm2023 <- b.comm2023[grep("^NE", site_names), ]
S.B.comm2023 <- b.comm2023[grep("^S", site_names), ]
NW.B.comm2023 <- b.comm2023[grep("^NW", site_names), ]

# Remove zero abundances
all_zero_columns <- apply(C.B.comm2023, 2, function(x) all(x == 0))
C.B.comm2023 <- C.B.comm2023[, !all_zero_columns]

all_zero_columns <- apply(NE.B.comm2023, 2, function(x) all(x == 0))
NE.B.comm2023 <- NE.B.comm2023[, !all_zero_columns]

all_zero_columns <- apply(S.B.comm2023, 2, function(x) all(x == 0))
S.B.comm2023 <- S.B.comm2023[, !all_zero_columns]

all_zero_columns <- apply(NW.B.comm2023, 2, function(x) all(x == 0))
NW.B.comm2023 <- NW.B.comm2023[, !all_zero_columns]

# Remove zero abundance communities
all_zero_rows <- apply(C.B.comm2023, 1, function(x) all(x == 0))
C.B.comm2023 <- C.B.comm2023[!all_zero_rows, ]

all_zero_rows <- apply(NE.B.comm2023, 1, function(x) all(x == 0))
NE.B.comm2023 <- NE.B.comm2023[!all_zero_rows, ]

all_zero_rows <- apply(S.B.comm2023, 1, function(x) all(x == 0))
S.B.comm2023 <- S.B.comm2023[!all_zero_rows, ]

all_zero_rows <- apply(NW.B.comm2023, 1, function(x) all(x == 0))
NW.B.comm2023 <- NW.B.comm2023[!all_zero_rows, ]

# 2024
betaboothby2024_clean <- readRDS("clean_data/betaboothby_2024.RDS")
b.comm2024 <- as.matrix(betaboothby2024_clean)
b.comm2024[is.na(b.comm2024)] <- 0

site_names <- rownames(betaboothby2024_clean)

C.B.comm2024 <- b.comm2024[grep("^C", site_names), ]
NE.B.comm2024 <- b.comm2024[grep("^NE", site_names), ]
S.B.comm2024 <- b.comm2024[grep("^S", site_names), ]
NW.B.comm2024 <- b.comm2024[grep("^NW", site_names), ]

all_zero_columns <- apply(C.B.comm2024, 2, function(x) all(x == 0))
C.B.comm2024 <- C.B.comm2024[, !all_zero_columns]

all_zero_columns <- apply(NE.B.comm2024, 2, function(x) all(x == 0))
NE.B.comm2024 <- NE.B.comm2024[, !all_zero_columns]

all_zero_columns <- apply(S.B.comm2024, 2, function(x) all(x == 0))
S.B.comm2024 <- S.B.comm2024[, !all_zero_columns]

all_zero_columns <- apply(NW.B.comm2024, 2, function(x) all(x == 0))
NW.B.comm2024 <- NW.B.comm2024[, !all_zero_columns]

all_zero_rows <- apply(C.B.comm2024, 1, function(x) all(x == 0))
C.B.comm2024 <- C.B.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(NE.B.comm2024, 1, function(x) all(x == 0))
NE.B.comm2024 <- NE.B.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(S.B.comm2024, 1, function(x) all(x == 0))
S.B.comm2024 <- S.B.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(NW.B.comm2024, 1, function(x) all(x == 0))
NW.B.comm2024 <- NW.B.comm2024[!all_zero_rows, ]


```

```{r Matrix of each site}

# Budworth 
betabr2021 <- with(budworth_2021_clean, tapply(Cover, list(paste(Plot, sep=""), Species), mean, rm.na=TRUE))
betabr2021[is.na(betabr2021)] <- 0
rownames(betabr2021) <- gsub("0", "", rownames(betabr2021), fixed = TRUE)
betabr2021 <- as.data.frame(betabr2021)
saveRDS(betabr2021, "clean_data/betabr2021.RDS")

# Silwood 2021
betasilwood2021 <- with(silwood_2021_clean, tapply(Cover, list(paste(Plot, sep=""), Species), mean, rm.na=TRUE))
betasilwood2021[is.na(betasilwood2021)] <- 0
rownames(betasilwood2021) <- gsub("0", "", rownames(betasilwood2021), fixed = TRUE)
betasilwood2021 <- as.data.frame(betasilwood2021)
saveRDS(betasilwood2021, "clean_data/betasilwood2021.RDS")

# Silwood 2022
betasilwood2022 <- with(silwood_2022_clean, tapply(Cover, list(paste(Plot, sep=""), Species), mean, rm.na=TRUE))
betasilwood2022[is.na(betasilwood2022)] <- 0
rownames(betasilwood2022) <- gsub("0", "", rownames(betasilwood2022), fixed = TRUE)
betasilwood2022 <- as.data.frame(betasilwood2022)
saveRDS(betasilwood2022, "clean_data/betasilwood2022.RDS")

# Silwood 2023
betasilwood2023 <- with(silwood_2023_clean, tapply(Cover, list(paste(Plot, sep=""), Species), mean, rm.na=TRUE))
betasilwood2023[is.na(betasilwood2023)] <- 0
rownames(betasilwood2023) <- gsub("0", "", rownames(betasilwood2023), fixed = TRUE)
betasilwood2023 <- as.data.frame(betasilwood2023)
saveRDS(betasilwood2023, "clean_data/betasilwood2023.RDS")

# HPF 2024
betahpf2024 <- with(hpf_2024_clean, tapply(Cover, list(paste(Block, Plot, sep=""), Species), mean, rm.na=TRUE))
betahpf2024[is.na(betahpf2024)] <- 0
#rownames(betahpf2024) <- gsub("0", "", rownames(betahpf2024), fixed = TRUE)
betahpf2024 <- as.data.frame(betahpf2024)
saveRDS(betahpf2024, "clean_data/betahpf2024.RDS")

# Hepple 2024
betahep2024 <- with(hep_2024_clean, tapply(Cover, list(paste(Block, Plot, sep=""), Species), mean, rm.na=TRUE))
betahep2024[is.na(betahep2024)] <- 0
#rownames(betahpf2024) <- gsub("0", "", rownames(betahpf2024), fixed = TRUE)
betahep2024 <- as.data.frame(betahep2024)
saveRDS(betahep2024, "clean_data/betahep2024.RDS")

# High fen
betahighfen2024 <- with(high_fen_clean, tapply(Cover, list(paste(Plot, sep=""), Species), mean, rm.na=TRUE))
betahighfen2024[is.na(betahighfen2024)] <- 0
betahighfen2024 <- as.data.frame(betahighfen2024)
saveRDS(betahighfen2024, "clean_data/betahighfen2024.RDS")
```

```{r Load matrix data of each site}

betarein2021_clean <- readRDS("clean_data/betarein2021.RDS")
betaordu2021_clean <- readRDS("clean_data/betaordu2021.RDS")
betabr2021_clean <- readRDS("clean_data/betabr2021.RDS")
betasilwood2021_clean <- readRDS("clean_data/betasilwood2021.RDS")
betasilwood2022_clean <- readRDS("clean_data/betasilwood2022.RDS")
betasilwood2023_clean <- readRDS("clean_data/betasilwood2023.RDS")
betaenez2021_clean <- readRDS("clean_data/betaenez2021.RDS")
betaordu2021_clean <- readRDS("clean_data/betaordu2021.RDS")
betarhf2017_clean <- readRDS("clean_data/betarhf2017.RDS")
betarhf2018_clean <- readRDS("clean_data/betarhf2018.RDS")
betarhf2019_clean <- readRDS("clean_data/betarhf2019.RDS")
betarhf2020_clean <- readRDS("clean_data/betarhf2020.RDS")
betahpf2024_clean <- readRDS("clean_data/betahpf2024.RDS")
betahep2024_clean <- readRDS("clean_data/betahep2024.RDS")
betaknepp2022_clean <- readRDS("clean_data/betaknepp2022.RDS")
betaknepp2023_clean <- readRDS("clean_data/betaknepp2023.RDS")
betaknepp2024_clean <- readRDS("clean_data/betaknepp2024.RDS")
betaboothby2022_clean <- readRDS("clean_data/betaboothby2022_clean.RDS")
betaboothby2023_clean <- readRDS("clean_data/betaboothby_2023.RDS")
betaboothby2024_clean <- readRDS("clean_data/betaboothby_2024.RDS")
betahighfen2024_clean <- readRDS("clean_data/betahighfen2024.RDS")


```

```{r Cleaning matrix of each site and split into blocks}

# budworth
br.comm2021 <- as.matrix(betabr2021_clean)
br.comm2021[is.na(br.comm2021)] <- 0

# silwood 21
s.comm2021 <- as.matrix(betasilwood2021_clean)
s.comm2021[is.na(s.comm2021)] <- 0

# silwood 22
s.comm2022 <- as.matrix(betasilwood2022_clean)
s.comm2022[is.na(s.comm2022)] <- 0

# silwood 23
s.comm2023 <- as.matrix(betasilwood2023_clean)
s.comm2023[is.na(s.comm2023)] <- 0

# hpf
hpf2024.comm <- as.matrix(betahpf2024_clean)
hpf2024.comm[is.na(hpf2024.comm)] <- 0

# split into blocks
site_names <- rownames(betahpf2024_clean)
F.HPF.comm2024 <- hpf2024.comm[grep("^2020", site_names), ]
S.HPF.comm2024 <- hpf2024.comm[grep("^South", site_names), ]

all_zero_columns <- apply(F.HPF.comm2024, 2, function(x) all(x == 0))
F.HPF.comm2024 <- F.HPF.comm2024[, !all_zero_columns]

all_zero_columns <- apply(S.HPF.comm2024, 2, function(x) all(x == 0))
S.HPF.comm2024 <- S.HPF.comm2024[, !all_zero_columns]

all_zero_rows <- apply(F.HPF.comm2024, 1, function(x) all(x == 0))
F.HPF.comm2024 <- F.HPF.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(S.HPF.comm2024, 1, function(x) all(x == 0))
S.HPF.comm2024 <- S.HPF.comm2024[!all_zero_rows, ]

# hepple
hep2024.comm <- as.matrix(betahep2024_clean)
hep2024.comm[is.na(hep2024.comm)] <- 0

site_names <- rownames(betahep2024_clean)

E.hep.comm2024 <- hep2024.comm[grep("^E", site_names), ]
S.hep.comm2024 <- hep2024.comm[grep("^S", site_names), ]
W.hep.comm2024 <- hep2024.comm[grep("^W", site_names), ]

all_zero_columns <- apply(E.hep.comm2024, 2, function(x) all(x == 0))
E.hep.comm2024 <- E.hep.comm2024[, !all_zero_columns]

all_zero_columns <- apply(S.hep.comm2024, 2, function(x) all(x == 0))
S.hep.comm2024 <- S.hep.comm2024[, !all_zero_columns]

all_zero_columns <- apply(W.hep.comm2024, 2, function(x) all(x == 0))
W.hep.comm2024 <- W.hep.comm2024[, !all_zero_columns]

all_zero_rows <- apply(E.hep.comm2024, 1, function(x) all(x == 0))
E.hep.comm2024 <- E.hep.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(S.hep.comm2024, 1, function(x) all(x == 0))
S.hep.comm2024 <- S.hep.comm2024[!all_zero_rows, ]

all_zero_rows <- apply(W.hep.comm2024, 1, function(x) all(x == 0))
W.hep.comm2024 <- W.hep.comm2024[!all_zero_rows, ]

# high fen
high_fen.comm <- as.matrix(betahighfen2024_clean)
high_fen.comm[is.na(high_fen.comm)] <- 0
```

```{r Loading and cleaning try and diaz datasets}

# read try data 
try_traits856 <- fread("try_data/34856.txt", sep = "\t", quote = "")
try_traits855 <- fread("try_data/old/34855.txt", sep = "\t", quote = "")

# remove blank trait rows
try_traits855 <- try_traits855 %>% filter(TraitName != "")
try_traits856 <- try_traits856 %>% filter(TraitName != "")

# merge these so all three traits there 
desired_traits <- c("Plant height vegetative", 
                    "Plant biomass and allometry: Seed mass per plant", 
                    "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)")

# filter to just desired
filtered_855 <- try_traits855 %>% filter(TraitName %in% desired_traits)
filtered_856 <- try_traits856 %>% filter(TraitName %in% desired_traits)

# combine 
try_traits_complete <- bind_rows(filtered_855, filtered_856)
bn <- subset(try_traits_complete, SpeciesName == "Brassica napus")

# subset
subset_try <- subset(try_traits_complete, select = c("SpeciesName","AccSpeciesName", "TraitID","OrigValueStr", "OrigUnitStr","StdValue", "TraitName", "ValueKindName","UnitName", "Comment"))

# load diaz data
diaz_data <- read.csv("diaz_data/Copy of Copy of Species_mean_traits.csv")

subset_diaz <- subset(diaz_data, select =c("Species.name.standardized.against.TPL", "Taxonomic.level", "Genus", "Leaf.area..mm2.","Plant.height..m.", "Diaspore.mass..mg."))

# save
write.csv(subset_try, file = "try_data/subset_try.csv", row.names = FALSE)

# save
write.csv(subset_diaz, file = "diaz_data/subset_diaz.csv", row.names = FALSE)

```

```{r Load clean try and diaz data}

# load subset_try from a CSV file
subset_try <- read.csv("try_data/subset_try.csv")

# load subset_diaz from a CSV file
subset_diaz <- read.csv("diaz_data/subset_diaz.csv")

```

```{r Knepp functional trait data 2022 - 2024, by block, setup}

# this process is repeated for each site and is so not marked in comments after Knepp 2022
# 2022
# load knepp species
species_names_knepp <- colnames(k.comm2022)

# format with _
formatted_species_list_knepp <- gsub("_", " ", species_names_knepp)

# get trait data for species
trait_data_knepp <- BIEN_trait_species(formatted_species_list_knepp)
head(trait_data_knepp)

# subset to remove unnecessary columns 
concise_trait_data_knepp <- subset(trait_data_knepp, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

# sort data frame columns alphabetically for ease of viewing 
concise_trait_data_knepp <- concise_trait_data_knepp[order(concise_trait_data_knepp$scrubbed_species_binomial), ]
head(concise_trait_data_knepp)

# remove NA
concise_trait_data_knepp <- concise_trait_data_knepp %>% drop_na(trait_name)
concise_trait_data_knepp <- concise_trait_data_knepp %>% drop_na(trait_value)

# what traits are there
unique(concise_trait_data_knepp$trait_name)

# how many of each trait there are - did this for each one
nrow(concise_trait_data_knepp[concise_trait_data_knepp$trait_name == 'leaf dry mass', ])

# average traits if there are multiple recordings of them per species
# function to get the mode of character traits
get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

# separate numeric and character traits
numeric_traits <- concise_trait_data_knepp %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp %>%
  filter(is.na(as.numeric(trait_value)))

# ensure numeric trait values are actually numeric
numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

# numeric traits by mean
summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

# character traits by mode
summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

# convert numeric trait values to character to avoid type conflict
summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

# combine the results
summarized_traits_knepp <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

# view
head(summarized_traits_knepp)

# view nas
total_nas <- sum(is.na(summarized_traits_knepp))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp$trait_name))
print(nas_in_trait_name)

# select only the traits of interest
refined_traits_knepp <- summarized_traits_knepp %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

print(refined_traits_knepp)

# missing spp
missing_species <- setdiff(formatted_species_list_knepp, refined_traits_knepp$scrubbed_species_binomial)
missing_species

# exclude ones that are or / uncertainties and change to genus level to match diaz
knepp2022missing <- c("Clinopodium", "Epilobium", 
                      "Lotus", "Myosotis", 
                      "Rosa", "Rumex", "Salix", "Vicia")

# check if in traits - check species name, none, so try genus seeing as all are genus level
present <- knepp2022missing %in% subset_diaz$Genus

# which species are present
results <- data.frame(
  species = knepp2022missing,
  present = present
) # all available

# filter subset_diaz for these genera
filtered_diaz <- subset_diaz %>% filter(Genus %in% knepp2022missing)

# average trait data at the genus level
average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

# format same as knepp trait data
average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

# pivot so same
average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  # Clean up trait names by removing the 'avg_' prefix
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

# rename so same
average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# merge
refined_traits_knepp <- rbind(refined_traits_knepp, average_traits_long)
refined_traits_knepp<-as.data.frame(refined_traits_knepp)

# pivot data to wide format
wide_data <- refined_traits_knepp %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

# identify missing data
missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

# print detailed missing species
for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

# missing traits
knepp2022leaf <- c("Epilobium tetragonum", "Parentucellia viscosa", 
                      "Phleum bertolonii", "Tripleurospermum inodorum")

knepp2022plant <- c("Carex sylvatica","Carpinus betulus","Cirsium dissectum","Crepis paludosa",       
 "Epilobium tetragonum",   "Geranium dissectum",     "Geranium pusillum"   ,   "Hordeum secalinum"   ,  
 "Juncus conglomeratus" ,  "Juncus inflexus"      ,  "Lathyrus nissolia",      "Lycopus europaeus",     
 "Oenanthe crocata" ,      "Parentucellia viscosa" , "Phleum bertolonii"   ,   "Potentilla reptans"    ,
 "Pulicaria dysenterica",  "Rosa arvensis"     ,     "Rumex sanguineus"     ,  "Sherardia arvensis"  ,  
"Stellaria graminea"     ,"Veronica serpyllifolia" ,"Vicia sativa"        ,   "Vicia tetrasperma"    , 
"Vulpia bromoides"   )

knepp2022seed <- c("Geranium pusillum"   ,   "Hordeum secalinum"    ,  "Impatiens noli-tangere", "Pulicaria dysenterica" ,"Rosa arvensis"     ,     "Salix aurita" )

# check if in diaz 
present <- knepp2022leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- knepp2022plant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- knepp2022seed %in% subset_diaz$Species.name.standardized.against.TPL

# which species are present
results <- data.frame(
  species = knepp2022leaf,
  present = present
) 
present

results <- data.frame(
  species = knepp2022plant,
  present = present2
) 
present2

results <- data.frame(
  species = knepp2022seed,
  present = present3
) 
present3

# filter
filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2022leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

# average trait data
average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

# format same as knepp trait data
average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

# pivot so same
average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

# rename so same
average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# replace missing S. aurita with mean of genus
mean_seed_mass_salix <- subset_diaz %>%
  filter(Genus == "Salix") %>%
  pull(Diaspore.mass..mg.) %>%
  mean(na.rm = TRUE)

# print the mean seed mass
print(mean_seed_mass_salix)

# replace NaN value in average_traits_long3 with the calculated mean
average_traits_long3<- average_traits_long3 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Salix aurita" & is.nan(trait_value) ~ mean_seed_mass_salix,
      TRUE ~ trait_value
    )
  )

# rbind all
refined_traits_knepp <- rbind(refined_traits_knepp, average_traits_long)
refined_traits_knepp <- rbind(refined_traits_knepp, average_traits_long2)
refined_traits_knepp <- rbind(refined_traits_knepp, average_traits_long3)

# recheck
data_summary <- refined_traits_knepp %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

# print
print(missing_data_summary) # all good

# fix genus level ones
# add spp to single-word species names
refined_traits_knepp <- refined_traits_knepp %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))

write.csv(refined_traits_knepp, file = "functional_data_final/refined_traits_knepp.csv", row.names = F)

# repeat for all others 
# 2022 M BLOCK
species_names_knepp_M <- colnames(M.k.comm2022)

formatted_species_list_knepp_M <- gsub("_", " ", species_names_knepp_M)

trait_data_knepp_M <- BIEN_trait_species(formatted_species_list_knepp_M)
head(trait_data_knepp_M)

concise_trait_data_knepp_M <- subset(trait_data_knepp_M, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_M <- concise_trait_data_knepp_M[order(concise_trait_data_knepp_M$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_M)

concise_trait_data_knepp_M <- concise_trait_data_knepp_M %>% drop_na(trait_name)
concise_trait_data_knepp_M <- concise_trait_data_knepp_M %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_M %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_M %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_M <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_M)

total_nas <- sum(is.na(summarized_traits_knepp_M))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_M$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_M <- summarized_traits_knepp_M %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_M, refined_traits_knepp_M$scrubbed_species_binomial)
missing_species

wide_data <- refined_traits_knepp_M %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2022Mleaf <- c("Phleum bertolonii")

knepp2022Mplant <- c("Carpinus betulus","Hordeum secalinum"   ,  "Phleum bertolonii"   ,   "Potentilla reptans" ,
"Stellaria graminea")

knepp2022Mseed <- c("Hordeum secalinum" )

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2022Mleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Mplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Mseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_M <- rbind(refined_traits_knepp_M, average_traits_long)
refined_traits_knepp_M <- rbind(refined_traits_knepp_M, average_traits_long2)
refined_traits_knepp_M <- rbind(refined_traits_knepp_M, average_traits_long3)

print(refined_traits_knepp_M)

refined_traits_knepp_M<-as.data.frame(refined_traits_knepp_M)
write.csv(refined_traits_knepp_M, file = "functional_data_final/refined_traits_knepp_M.csv", row.names = F)

# 2022 N BLOCK
species_names_knepp_N <- colnames(N.k.comm2022)

formatted_species_list_knepp_N <- gsub("_", " ", species_names_knepp_N)

trait_data_knepp_N <- BIEN_trait_species(formatted_species_list_knepp_N)
head(trait_data_knepp_N)

concise_trait_data_knepp_N <- subset(trait_data_knepp_N, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_N <- concise_trait_data_knepp_N[order(concise_trait_data_knepp_N$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_N)

concise_trait_data_knepp_N <- concise_trait_data_knepp_N %>% drop_na(trait_name)
concise_trait_data_knepp_N <- concise_trait_data_knepp_N %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_N %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_N %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_N <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_N)

total_nas <- sum(is.na(summarized_traits_knepp_N))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_N$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_N <- summarized_traits_knepp_N %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_N, refined_traits_knepp_N$scrubbed_species_binomial)
missing_species

knepp2022missingN <- c("Epilobium", "Vicia")

present <- knepp2022missingN %in% subset_diaz$Genus

results <- data.frame(
  species = knepp2022missingN,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% knepp2022missingN)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_N <- rbind(refined_traits_knepp_N, average_traits_long)

wide_data <- refined_traits_knepp_N %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2022Nleaf <- c("Epilobium tetragonum", "Parentucellia viscosa", 
                      "Phleum bertolonii", "Tripleurospermum inodorum")

knepp2022Nplant <- c("Carex sylvatica","Cirsium dissectum","Crepis paludosa",       
 "Epilobium tetragonum",   "Geranium dissectum",     
 "Oenanthe crocata" ,      "Parentucellia viscosa" , "Phleum bertolonii"   ,   "Potentilla reptans"    ,
 "Pulicaria dysenterica",  "Sherardia arvensis"  , "Vicia tetrasperma")

knepp2022Nseed <- c("Pulicaria dysenterica")

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2022Nleaf) %>%
   dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Nplant)%>%
   dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Nseed)%>%
   dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_N <- rbind(refined_traits_knepp_N, average_traits_long)
refined_traits_knepp_N <- rbind(refined_traits_knepp_N, average_traits_long2)
refined_traits_knepp_N <- rbind(refined_traits_knepp_N, average_traits_long3)

data_summary <- refined_traits_knepp_N %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
   dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good 

refined_traits_knepp_N <- refined_traits_knepp_N %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))

refined_traits_knepp_N<-as.data.frame(refined_traits_knepp_N)
write.csv(refined_traits_knepp_N, file = "functional_data_final/refined_traits_knepp_N.csv", row.names = F)

# 2022 S BLOCK
species_names_knepp_S <- colnames(S.k.comm2022)

formatted_species_list_knepp_S <- gsub("_", " ", species_names_knepp_S)

trait_data_knepp_S <- BIEN_trait_species(formatted_species_list_knepp_S)
head(trait_data_knepp_S)

concise_trait_data_knepp_S <- subset(trait_data_knepp_S, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_S <- concise_trait_data_knepp_S[order(concise_trait_data_knepp_S$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_S)

concise_trait_data_knepp_S <- concise_trait_data_knepp_S %>% drop_na(trait_name)
concise_trait_data_knepp_S <- concise_trait_data_knepp_S %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_S %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_S %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_S <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_S)

total_nas <- sum(is.na(summarized_traits_knepp_S))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_S$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_S <- summarized_traits_knepp_S %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_S, refined_traits_knepp_S$scrubbed_species_binomial)
missing_species

knepp2022missingS <- c("Clinopodium", "Epilobium", 
                      "Lotus", "Myosotis", 
                      "Rosa", "Rumex", "Salix", "Vicia")


present <- knepp2022missingS %in% subset_diaz$Genus

results <- data.frame(
  species = knepp2022missingS,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% knepp2022missingS)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_S <- rbind(refined_traits_knepp_S, average_traits_long)

print(refined_traits_knepp_S)

wide_data <- refined_traits_knepp_S %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2022Splant <- c("Cirsium dissectum"  ,    "Geranium dissectum",     "Geranium pusillum" ,     "Juncus conglomeratus",  "Juncus inflexus"    ,    "Lathyrus nissolia" ,     "Lycopus europaeus"     , "Oenanthe crocata",   "Pulicaria dysenterica" , "Rosa arvensis"  ,        "Rumex sanguineus"  ,     "Stellaria graminea"  ,  
"Veronica serpyllifolia" ,"Vicia sativa"       ,    "Vicia tetrasperma"     , "Vulpia bromoides"  )

knepp2022Sseed <- c("Geranium pusillum"   ,   "Impatiens noli-tangere" ,"Pulicaria dysenterica",  "Rosa arvensis"    ,"Salix aurita"  )

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Splant)%>%
   dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2022Sseed)%>%
   dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3<- average_traits_long3 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Salix aurita" & (is.nan(trait_value)|trait_value == "NaN") ~ as.numeric(mean_seed_mass_salix),
      TRUE ~ trait_value
    )
  )

refined_traits_knepp_S <- rbind(refined_traits_knepp_S, average_traits_long2)
refined_traits_knepp_S <- rbind(refined_traits_knepp_S, average_traits_long3)

data_summary <- refined_traits_knepp_S %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good 

refined_traits_knepp_S<-as.data.frame(refined_traits_knepp_S)

refined_traits_knepp_S <- refined_traits_knepp_S %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))

# duplicates
duplicate_rows <- refined_traits_knepp_S[duplicated(refined_traits_knepp_S), ]

# View the duplicated rows
print(duplicate_rows)

write.csv(refined_traits_knepp_S, file = "functional_data_final/refined_traits_knepp_S.csv", row.names = F)

## 2023
species_names_knepp <- colnames(k.comm2023)

formatted_species_list_knepp <- gsub("_", " ", species_names_knepp)

trait_data_knepp2023 <- BIEN_trait_species(formatted_species_list_knepp)
head(trait_data_knepp2023)

concise_trait_data_knepp2023 <- subset(trait_data_knepp2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp2023 <- concise_trait_data_knepp2023[order(concise_trait_data_knepp2023$scrubbed_species_binomial), ]

concise_trait_data_knepp2023 <- concise_trait_data_knepp2023 %>% drop_na(trait_name)
concise_trait_data_knepp2023 <- concise_trait_data_knepp2023 %>% drop_na(trait_value)

unique(concise_trait_data_knepp2023$trait_name)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp2023)

total_nas <- sum(is.na(summarized_traits_knepp2023))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp2023$trait_name))
print(nas_in_trait_name)

refined_traits_knepp2023 <- summarized_traits_knepp2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp, refined_traits_knepp2023$scrubbed_species_binomial)
missing_species

knepp2023missing <- c("Pteridium aquilinum")

present <- knepp2023missing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = knepp2023missing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023missing)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp2023 <- rbind(refined_traits_knepp2023, average_traits_long)

wide_data <- refined_traits_knepp2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2023leaf <- c("Atropa belladonna", "Odontites vernus" , "Persicaria hydropiper")

knepp2023plant <- c(
  "Acer campestre",
  "Asperula cynanchica",
  "Atropa belladonna",
  "Cerastium arvense",
  "Equisetum fluviatile",
  "Fumaria officinalis",
  "Geranium columbinum",
  "Geranium dissectum",
  "Hypericum tetrapterum",
  "Iris pseudacorus",
  "Jacobaea vulgaris",
  "Lathyrus nissolia",
  "Lycopus europaeus",
  "Odontites vernus",
  "Oenanthe crocata",
  "Potentilla anserina",
  "Potentilla reptans",
  "Primula vulgaris",
  "Prunus avium",
  "Pulicaria dysenterica",
  "Quercus petraea",
  "Scorzoneroides autumnalis",
  "Senecio erucifolius",
  "Stellaria graminea",
  "Veronica serpyllifolia",
  "Vicia sativa",
  "Vicia tetrasperma",
  "Vinca major"
)

knepp2023seed <- c("Asperula cynanchica"  , "Equisetum fluviatile","Pulicaria dysenterica" ,"Salix cinerea")

present <- knepp2023leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- knepp2023plant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- knepp2023seed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = knepp2023seed,
  present3 = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2023leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# get missing O. vernus data from try
leaf_area_value <- subset_try %>%
  filter(SpeciesName == "Odontites vernus" &
         TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 


plant_height_value <- subset_try %>%
  filter(SpeciesName == "Odontites vernus" &
         TraitName == "Plant height vegetative" & ValueKindName == "Maximum") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 

new_values <- data.frame(
  scrubbed_species_binomial = c("Odontites vernus", "Odontites vernus"),
  trait_name = c("leaf area", "maximum whole plant height"),
  trait_value = c(leaf_area_value, plant_height_value)
)

# merge all
refined_traits_knepp2023 <- rbind(refined_traits_knepp2023, average_traits_long)
refined_traits_knepp2023 <- rbind(refined_traits_knepp2023, average_traits_long2)
refined_traits_knepp2023 <- rbind(refined_traits_knepp2023, average_traits_long3)
refined_traits_knepp2023 <- rbind(refined_traits_knepp2023, new_values)

p_aq <- subset_try %>%
  filter(
    AccSpeciesName == "Pteridium aquilinum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

p_aq <- 2044.367

refined_traits_knepp2023<- refined_traits_knepp2023 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Pteridium aquilinum" & trait_name == "leaf area" ~ "2044.367",
      TRUE ~ trait_value
    )
  )


data_summary <- refined_traits_knepp2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

refined_traits_knepp2023<-as.data.frame(refined_traits_knepp2023)

refined_traits_knepp2023 <- refined_traits_knepp2023 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))

print(refined_traits_knepp2023)

duplicates <- refined_traits_knepp2023 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

write.csv(refined_traits_knepp2023, file = "functional_data_final/refined_traits_knepp2023.csv", row.names = F)

# 2023 M BLOCK
species_names_knepp_M <- colnames(M.k.comm2023)
formatted_species_list_knepp_M <- gsub("_", " ", species_names_knepp_M)

trait_data_knepp_M2023 <- BIEN_trait_species(formatted_species_list_knepp_M)
head(trait_data_knepp_M2023)

concise_trait_data_knepp_M2023 <- subset(trait_data_knepp_M2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_M2023 <- concise_trait_data_knepp_M2023[order(concise_trait_data_knepp_M2023$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_M2023)

concise_trait_data_knepp_M2023 <- concise_trait_data_knepp_M2023 %>% drop_na(trait_name)
concise_trait_data_knepp_M2023 <- concise_trait_data_knepp_M2023 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_M2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_M2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_M2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_M2023)

total_nas <- sum(is.na(summarized_traits_knepp_M2023))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_M2023$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_M2023 <- summarized_traits_knepp_M2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_M, refined_traits_knepp_M2023$scrubbed_species_binomial)
missing_species

wide_data <- refined_traits_knepp_M2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}


knepp2023leaf <- c("Persicaria hydropiper")
knepp2023plant <- c("Acer campestre"  ,       "Cerastium arvense" ,     "Geranium dissectum" ,    "Potentilla reptans"    , "Primula vulgaris" ,      "Pulicaria dysenterica" , "Quercus petraea"    ,    "Veronica serpyllifolia","Vinca major" )   
knepp2023seed <- c("Pulicaria dysenterica")

present2 <- knepp2023plant %in% subset_diaz$Species.name.standardized.against.TPL

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2023leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_M2023 <- rbind(refined_traits_knepp_M2023, average_traits_long)
refined_traits_knepp_M2023 <- rbind(refined_traits_knepp_M2023, average_traits_long2)
refined_traits_knepp_M2023 <- rbind(refined_traits_knepp_M2023, average_traits_long3)


data_summary <- refined_traits_knepp_M2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_knepp_M2023)

refined_traits_knepp_M2023 <- refined_traits_knepp_M2023 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))


refined_traits_knepp_M2023<-as.data.frame(refined_traits_knepp_M2023)
write.csv(refined_traits_knepp_M2023, file = "functional_data_final/refined_traits_knepp_M2023.csv", row.names = F)

# 2023 N BLOCK
species_names_knepp_N <- colnames(N.k.comm2023)
formatted_species_list_knepp_N <- gsub("_", " ", species_names_knepp_N)
trait_data_knepp_N2023 <- BIEN_trait_species(formatted_species_list_knepp_N)
head(trait_data_knepp_N2023)

concise_trait_data_knepp_N2023 <- subset(trait_data_knepp_N2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_N2023 <- concise_trait_data_knepp_N2023[order(concise_trait_data_knepp_N2023$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_N2023)

concise_trait_data_knepp_N2023 <- concise_trait_data_knepp_N2023 %>% drop_na(trait_name)
concise_trait_data_knepp_N2023 <- concise_trait_data_knepp_N2023 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_N2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_N2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_N2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_N2023)

total_nas <- sum(is.na(summarized_traits_knepp_N2023))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_N2023$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_N2023 <- summarized_traits_knepp_N2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_N, refined_traits_knepp_N2023$scrubbed_species_binomial)
missing_species

knepp2023missing <- c("Pteridium aquilinum")

present <- knepp2023missing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = knepp2023missing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023missing)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_N2023 <- rbind(refined_traits_knepp_N2023, average_traits_long)

# fill in p. aq leaf
refined_traits_knepp_N2023<- refined_traits_knepp_N2023 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Pteridium aquilinum" & trait_name == "leaf area" ~ "2044.367",
      TRUE ~ trait_value
    )
  )

wide_data <- refined_traits_knepp_N2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2023Nleaf <- c("Atropa belladonna", "Odontites vernus" )

knepp2023Nplant <- c("Atropa belladonna"    ,     "Cerastium arvense"       ,  "Fumaria officinalis"    ,   "Geranium columbinum", "Geranium dissectum"      ,  "Jacobaea vulgaris"         ,"Lathyrus nissolia"       ,  "Odontites vernus"  , "Oenanthe crocata"    ,      "Pulicaria dysenterica"   ,  "Quercus petraea"    ,       "Scorzoneroides autumnalis",
 "Senecio erucifolius"  ,     "Stellaria graminea"   ,     "Veronica serpyllifolia"    ,"Vicia sativa"     ,        
 "Vicia tetrasperma" )

knepp2023Nseed <- c("Pulicaria dysenterica")

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2023Nleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023Nplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023Nseed)%>%
 dplyr:: select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_N2023 <- rbind(refined_traits_knepp_N2023, average_traits_long)
refined_traits_knepp_N2023 <- rbind(refined_traits_knepp_N2023, average_traits_long2)
refined_traits_knepp_N2023 <- rbind(refined_traits_knepp_N2023, average_traits_long3)
refined_traits_knepp_N2023 <- rbind(refined_traits_knepp_N2023, new_values)

data_summary <- refined_traits_knepp_N2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_knepp_N2023)

refined_traits_knepp_N2023<-as.data.frame(refined_traits_knepp_N2023)
write.csv(refined_traits_knepp_N2023, file = "functional_data_final/refined_traits_knepp_N2023.csv", row.names = F)

# 2023 S BLOCK
species_names_knepp_S <- colnames(S.k.comm2023)

formatted_species_list_knepp_S <- gsub("_", " ", species_names_knepp_S)

trait_data_knepp_S2023 <- BIEN_trait_species(formatted_species_list_knepp_S)
head(trait_data_knepp_S2023)

concise_trait_data_knepp_S2023 <- subset(trait_data_knepp_S2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_S2023 <- concise_trait_data_knepp_S2023[order(concise_trait_data_knepp_S2023$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_S2023)

concise_trait_data_knepp_S2023 <- concise_trait_data_knepp_S2023 %>% drop_na(trait_name)
concise_trait_data_knepp_S2023 <- concise_trait_data_knepp_S2023 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_S2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_S2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_S2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_S2023)

total_nas <- sum(is.na(summarized_traits_knepp_S2023))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_S2023$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_S2023 <- summarized_traits_knepp_S2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_S, refined_traits_knepp_S2023$scrubbed_species_binomial)
missing_species

wide_data <- refined_traits_knepp_S2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2023Sleaf <- c("Atropa belladonna")

knepp2023Splant <- c("Asperula cynanchica"  ,  "Atropa belladonna"   ,   "Cerastium arvense"   ,   "Equisetum fluviatile", "Geranium dissectum"    , "Hypericum tetrapterum" , "Iris pseudacorus"   ,    "Lycopus europaeus" ,    
 "Potentilla anserina" ,   "Potentilla reptans"  ,   "Prunus avium"          , "Pulicaria dysenterica" ,
"Quercus petraea"    ,    "Senecio erucifolius"  ,  "Stellaria graminea"  ,   "Veronica serpyllifolia",
"Vicia sativa"     )

knepp2023Sseed <- c("Asperula cynanchica"  , "Equisetum fluviatile" , "Pulicaria dysenterica" ,"Salix cinerea")

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2023Sleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023Splant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2023Sseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp_S2023 <- rbind(refined_traits_knepp_S2023, average_traits_long)
refined_traits_knepp_S2023 <- rbind(refined_traits_knepp_S2023, average_traits_long2)
refined_traits_knepp_S2023 <- rbind(refined_traits_knepp_S2023, average_traits_long3)

data_summary <- refined_traits_knepp_S2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

refined_traits_knepp_S2023 <- refined_traits_knepp_S2023 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp."),
    scrubbed_species_binomial
  ))

refined_traits_knepp_S2023<-as.data.frame(refined_traits_knepp_S2023)
write.csv(refined_traits_knepp_S2023, file = "functional_data_final/refined_traits_knepp_S2023.csv", row.names = F)

# 2024
species_names_knepp <- colnames(k.comm2024)
formatted_species_list_knepp <- gsub("_", " ", species_names_knepp)
trait_data_knepp2024 <- BIEN_trait_species(formatted_species_list_knepp)
head(trait_data_knepp2024)
concise_trait_data_knepp2024 <- subset(trait_data_knepp2024, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))
concise_trait_data_knepp2024 <- concise_trait_data_knepp2024[order(concise_trait_data_knepp2024$scrubbed_species_binomial), ]
concise_trait_data_knepp2024 <- concise_trait_data_knepp2024 %>% drop_na(trait_name)
concise_trait_data_knepp2024 <- concise_trait_data_knepp2024 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp2024 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp2024 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

# Combine the results
summarized_traits_knepp2024 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp2024)
total_nas <- sum(is.na(summarized_traits_knepp2024))
print(total_nas)
nas_in_trait_name <- sum(is.na(summarized_traits_knepp2024$trait_name))
print(nas_in_trait_name)
refined_traits_knepp2024 <- summarized_traits_knepp2024 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp, refined_traits_knepp2024$scrubbed_species_binomial)
missing_species

knepp2024missing1 <- c("Cerastium")
knepp2024missing2 <- c( "Lysimachia arvensis" ,  "Polystichum setiferum",
"Pteridium aquilinum",   "Vicia pisiformis"   )

present1 <- knepp2024missing1 %in% subset_diaz$Genus
present2 <- knepp2024missing2 %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = knepp2024missing2,
  present = present2
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% knepp2024missing1)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2024missing2)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits2)

mean_leaf_area_vicia <- subset_diaz %>%
  filter(grepl("Vicia", Genus)) %>%
  summarise(mean_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE))

print(mean_leaf_area_vicia)

p_aq <- subset_try %>%
  filter(
    AccSpeciesName == "Pteridium aquilinum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

polystichum_leaf_area <- subset_diaz %>%
  filter(Genus == "Polystichum") %>%
  summarise(average_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE))

average_traits2_full <- average_traits2 %>%
  mutate(
    avg_Leaf.area..mm2. = case_when(
      Species.name.standardized.against.TPL == "Vicia pisiformis" ~ mean_leaf_area_vicia$mean_leaf_area,
      Species.name.standardized.against.TPL == "Pteridium aquilinum" ~ p_aq$average_leaf,
      Species.name.standardized.against.TPL == "Polystichum setiferum" ~ polystichum_leaf_area$average_leaf_area,
      TRUE ~ avg_Leaf.area..mm2. 
    )
  )

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

average_traits2_full <- average_traits2_full %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2_full %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long_cer <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, average_traits_long_cer)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, average_traits_long2)

wide_data <- refined_traits_knepp2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2024leaf <- c("Bromus catharticus"  ,   "Cirsium palustre"   ,    "Epilobium tetragonum" ,  "Geranium rotundifolium",
 "Hordeum brachyantherum" ,"Lolium pratense"    ,    "Melica uniflora"      ,  "Odontites vernus"      ,
 "Persicaria hydropiper" , "Ranunculus abortivus" ,  "Salix bebbiana"  ,       "Stellaria alsine"  
)

knepp2024plant <- c(
  "Adoxa moschatellina",    "Ajuga reptans",          "Borago officinalis",     "Brassica nigra",
  "Calamagrostis epigejos", "Carex distans",          "Carex hirta",            "Carex pendula",
  "Carex sylvatica",        "Carpinus betulus",       "Epilobium tetragonum",   "Erigeron annuus",
  "Geranium dissectum",     "Geranium rotundifolium", "Hordeum brachyantherum", "Hordeum secalinum",
  "Hypericum humifusum",    "Jacobaea vulgaris",      "Lathyrus nissolia",      "Lathyrus sativus",
  "Lolium pratense",        "Myosotis discolor",      "Myosotis laxa",          "Myosotis sylvatica",
  "Odontites vernus",       "Oenanthe crocata",       "Persicaria maculosa",    "Plantago media",
  "Potentilla anserina",    "Potentilla reptans",     "Pulicaria dysenterica",  "Raphanus raphanistrum",
  "Rosa multiflora",        "Rubus caesius",          "Rubus ulmifolius",       "Rumex conglomeratus",
  "Rumex sanguineus",       "Salix bebbiana",         "Senecio aquaticus",      "Senecio erucifolius",
  "Senecio sylvaticus",     "Stellaria graminea",     "Teucrium chamaedrys",    "Veronica filiformis",
  "Veronica serpyllifolia", "Vicia sativa",           "Vicia tetrasperma"
)


knepp2024seed <- c("Hordeum secalinum"  ,   "Pulicaria dysenterica" ,"Salix aurita"      ,   "Salix cinerea"    ,     "Veronica filiformis"
)

present <- knepp2024leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- knepp2024plant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- knepp2024seed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = knepp2024seed,
  present3 = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2024leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2024plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2024seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# get lolium pratense data
lolium_pratense_height <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(lolium_pratense_height)

lolium_pratense_leaf <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

print(lolium_pratense_leaf)

lolium_pratense_height <- 0.7833333 
lolium_pratense_leaf <- 3490.177

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Lolium pratense", "Lolium pratense"),
  trait_name = c("maximum whole plant height", "leaf area"),
  trait_value = c(lolium_pratense_height, lolium_pratense_leaf)
)

# now get Senecio aquaticus height data 
senecio_aq_height <- subset_try %>%
  filter(
    SpeciesName == "Senecio aquaticus" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

senecio_aq_height <- 0.6

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Senecio aquaticus"),
  trait_name = c("maximum whole plant height"),
  trait_value = c(senecio_aq_height)
)

refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, average_traits_long)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, average_traits_long2)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, average_traits_long3)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, new_values)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, new_values2)
refined_traits_knepp2024 <- rbind(refined_traits_knepp2024, new_values3)

# s. bebbiana leaf data 
salix_genus_leaf_area <- subset_diaz %>%
  mutate(Genus = word(Species.name.standardized.against.TPL, 1)) %>%  # Extract the genus
  filter(Genus == "Salix") %>%
  summarize(average_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE))

average_leaf_area_salix <- salix_genus_leaf_area$average_leaf_area

refined_traits_knepp2024 <- refined_traits_knepp2024 %>%
  mutate(trait_value = if_else(
    scrubbed_species_binomial == "Salix bebbiana" & trait_name == "leaf area",
    "680.446",
    trait_value
  ))

s_al_leaf <- subset_try %>%
  filter(AccSpeciesName == "Stellaria alsine" &
         TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 

new_row <- tibble(
  scrubbed_species_binomial = "Stellaria alsine",
  trait_name = "leaf area",
  trait_value = "316" 
)

refined_traits_knepp2024 <- bind_rows(refined_traits_knepp2024, new_row)

data_summary <- refined_traits_knepp2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

refined_traits_knepp2024<-as.data.frame(refined_traits_knepp2024)

mean_seed_mass_salix <- subset_diaz %>%
  filter(Genus == "Salix") %>%
  pull(Diaspore.mass..mg.) %>%
  mean(na.rm = TRUE)

mean_seed_mass_salix <- as.character(mean_seed_mass_salix)

refined_traits_knepp2024 <- refined_traits_knepp2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Salix aurita" & (is.na(trait_value) | trait_value == "NaN" | trait_value == "") ~ mean_seed_mass_salix,
      TRUE ~ trait_value
    )
  )

write.csv(refined_traits_knepp2024, file = "functional_data_final/refined_traits_knepp2024.csv", row.names = F)

# 2024 M BLOCK
species_names_knepp_M <- colnames(M.k.comm2024)
formatted_species_list_knepp_M <- gsub("_", " ", species_names_knepp_M)

trait_data_knepp_M2024 <- BIEN_trait_species(formatted_species_list_knepp_M)
head(trait_data_knepp_M2024)

concise_trait_data_knepp_M2024 <- subset(trait_data_knepp_M2024, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_knepp_M2024 <- concise_trait_data_knepp_M2024[order(concise_trait_data_knepp_M2024$scrubbed_species_binomial), ]
head(concise_trait_data_knepp_M2024)

concise_trait_data_knepp_M2024 <- concise_trait_data_knepp_M2024 %>% drop_na(trait_name)
concise_trait_data_knepp_M2024 <- concise_trait_data_knepp_M2024 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_knepp_M2024 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_knepp_M2024 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_knepp_M2024 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_knepp_M2024)

total_nas <- sum(is.na(summarized_traits_knepp_M2024))
print(total_nas)

nas_in_trait_name <- sum(is.na(summarized_traits_knepp_M2024$trait_name))
print(nas_in_trait_name)

refined_traits_knepp_M2024 <- summarized_traits_knepp_M2024 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_knepp_M, refined_traits_knepp_M2024$scrubbed_species_binomial)
missing_species

vicia_row <- refined_traits_knepp2024 %>%
  filter(scrubbed_species_binomial == "Vicia pisiformis")

refined_traits_knepp_M2024 <- refined_traits_knepp_M2024 %>%
  bind_rows(vicia_row)

wide_data <- refined_traits_knepp_M2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

knepp2024leaf <- c("Epilobium tetragonum", "Hordeum brachyantherum", 
  "Lolium pratense"
)

knepp2024plant <- c("Carpinus betulus"   ,    "Epilobium tetragonum" ,  "Hordeum brachyantherum", "Jacobaea vulgaris"     , "Lolium pratense"  ,      "Myosotis laxa"   ,       "Potentilla reptans" ,    "Raphanus raphanistrum" , "Veronica serpyllifolia")

present <- knepp2024leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- knepp2024plant %in% subset_diaz$Species.name.standardized.against.TPL

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% knepp2024leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% knepp2024plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Lolium pratense", "Lolium pratense"),
  trait_name = c("maximum whole plant height", "leaf area"),
  trait_value = c(lolium_pratense_height, lolium_pratense_leaf)
)

refined_traits_knepp_M2024 <- rbind(refined_traits_knepp_M2024, average_traits_long)
refined_traits_knepp_M2024 <- rbind(refined_traits_knepp_M2024, average_traits_long2)
refined_traits_knepp_M2024 <- rbind(refined_traits_knepp_M2024, new_values2)

data_summary <- refined_traits_knepp_M2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_knepp_M2024)

refined_traits_knepp_M2024<-as.data.frame(refined_traits_knepp_M2024)
write.csv(refined_traits_knepp_M2024, file = "functional_data_final/refined_traits_knepp_M2024.csv", row.names = F)

# 2024 N BLOCK
species_names_knepp_N <- colnames(N.k.comm2024)
formatted_species_list_knepp_N <- gsub("_", " ", species_names_knepp_N)

refined_traits_knepp_N2024 <- refined_traits_knepp2024 %>%
  filter(scrubbed_species_binomial %in% formatted_species_list_knepp_N)

print(refined_traits_knepp_N2024)

data_summary <- refined_traits_knepp_N2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_knepp_N2024)

refined_traits_knepp_N2024<-as.data.frame(refined_traits_knepp_N2024)
write.csv(refined_traits_knepp_N2024, file = "functional_data_final/refined_traits_knepp_N2024.csv", row.names = F)

# 2024 S BLOCK
species_names_knepp_S <- colnames(S.k.comm2024)

formatted_species_list_knepp_S <- gsub("_", " ", species_names_knepp_S)

refined_traits_knepp_S2024 <- refined_traits_knepp2024 %>%
  filter(scrubbed_species_binomial %in% formatted_species_list_knepp_S)

print(refined_traits_knepp_S2024)

data_summary <- refined_traits_knepp_S2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
 dplyr:: select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_knepp_S2024)

refined_traits_knepp_S2024<-as.data.frame(refined_traits_knepp_S2024)
write.csv(refined_traits_knepp_S2024, file = "functional_data_final/refined_traits_knepp_S2024.csv", row.names = F)

```

```{r Knepp functional metrics 2022 - 2024, by block traits also}

# for all functional metric calculation chunks, looking at zero abundance communities, species and common species etc.
# is just to be sure all is ok and the cleaning process worked - it did
# and also remove overhang species that are not included in the analysis 
# this is repeated for each sites so is not marked in comments

# 2022

# pivot wider
wide_refined_traits_knepp <- refined_traits_knepp %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp)
wide_refined_traits_knepp$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp$scrubbed_species_binomial)

# convert trait values to numeric
wide_refined_traits_knepp <- wide_refined_traits_knepp %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

# convert to data frame and set row names to species names
wide_refined_traits_knepp_df <- as.data.frame(wide_refined_traits_knepp)
rownames(wide_refined_traits_knepp_df) <- wide_refined_traits_knepp_df$scrubbed_species_binomial
wide_refined_traits_knepp_df$scrubbed_species_binomial <- NULL

# view
head(wide_refined_traits_knepp_df)

# get species to match between community and trait data

# extract species names from trait data
species_in_traits <- rownames(wide_refined_traits_knepp_df)

# extract species names from betakneppclean_2022
species_in_community <- colnames(betaknepp2022_clean)

# find common species
common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community # all jusy overhang 
# filter betakneppclean_2022 to include only common species
betaknepp2022_clean_traits <- betaknepp2022_clean[, common_species, drop = FALSE]

k.trait.comm2022 <- as.matrix(betaknepp2022_clean_traits)

# sum the abundances of each species across all communities
species_abundance <- colSums(k.trait.comm2022)

# identify species with zero total abundance
zero_abundance_species <- names(species_abundance[species_abundance == 0])

# display the species with zero abundance
zero_abundance_species

# remove species with zero abundance from the traits data frame
wide_refined_traits_knepp_df <- wide_refined_traits_knepp_df[!rownames(wide_refined_traits_knepp_df) %in% zero_abundance_species, ]

# check the head of the filtered traits data frame
head(wide_refined_traits_knepp_df)

# run dbfd
fd_results_knepp <- dbFD(x = wide_refined_traits_knepp_df, a = k.trait.comm2022)
fd_results_knepp <-as.data.frame(fd_results_knepp)

# save
saveRDS(fd_results_knepp, "functional_data_final/fd_results_knepp.RDS")
write.csv(wide_refined_traits_knepp_df, "functional_data_final/wide_refined_traits_knepp_df.csv")

## M BLOCK 
wide_refined_traits_knepp_M <- refined_traits_knepp_M %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp_M)
wide_refined_traits_knepp_M$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_M$scrubbed_species_binomial)

wide_refined_traits_knepp_M <- wide_refined_traits_knepp_M %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_M <- as.data.frame(wide_refined_traits_knepp_M)
rownames(wide_refined_traits_knepp_df_M) <- wide_refined_traits_knepp_df_M$scrubbed_species_binomial
wide_refined_traits_knepp_df_M$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_M)

species_in_traits <- rownames(wide_refined_traits_knepp_df_M)

betaknepp2022_clean_M <- readRDS("clean_data/betaknepp2022_clean_M.RDS")

species_in_community <- colnames(betaknepp2022_clean_M)

common_species <- intersect(species_in_traits, species_in_community)

betaknepp2022_clean_traits_M <- betaknepp2022_clean_M[, common_species, drop = FALSE]

M.k.trait.comm2022 <- as.matrix(betaknepp2022_clean_traits_M)

species_abundance <- colSums(M.k.trait.comm2022)

zero_abundance_species <- names(species_abundance[species_abundance == 0])

zero_abundance_species

wide_refined_traits_knepp_df_M <- wide_refined_traits_knepp_df_M[!rownames(wide_refined_traits_knepp_df_M) %in% zero_abundance_species, ]

head(wide_refined_traits_knepp_df_M)

species_traits <- rownames(wide_refined_traits_knepp_df_M)
species_communities <- colnames(M.k.trait.comm2022)

common_species <- intersect(species_traits, species_communities)

common_species

wide_refined_traits_knepp_df_M <- wide_refined_traits_knepp_df_M[common_species, ]

M.k.trait.comm2022 <- M.k.trait.comm2022[, common_species]

dim(wide_refined_traits_knepp_df_M)
dim(M.k.trait.comm2022)

fd_results_knepp_M<- dbFD(x = wide_refined_traits_knepp_df_M, a = M.k.trait.comm2022)

fd_results_knepp_M <-as.data.frame(fd_results_knepp_M)
saveRDS(fd_results_knepp_M, "functional_data_final/fd_results_knepp_M.RDS")
write.csv(wide_refined_traits_knepp_df_M, "functional_data_final/wide_refined_traits_knepp_M.csv")

## N BLOCK 
wide_refined_traits_knepp_N <- refined_traits_knepp_N %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp_N)
wide_refined_traits_knepp_N$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_N$scrubbed_species_binomial)

wide_refined_traits_knepp_N <- wide_refined_traits_knepp_N %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_N <- as.data.frame(wide_refined_traits_knepp_N)
rownames(wide_refined_traits_knepp_df_N) <- wide_refined_traits_knepp_df_N$scrubbed_species_binomial
wide_refined_traits_knepp_df_N$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_N)

species_in_traits <- rownames(wide_refined_traits_knepp_df_N)

betaknepp2022_clean_N <- readRDS("clean_data/betaknepp2022_clean_N.RDS")

species_in_community <- colnames(betaknepp2022_clean_N)

common_species <- intersect(species_in_traits, species_in_community)

betaknepp2022_clean_traits_N <- betaknepp2022_clean_N[, common_species, drop = FALSE]

N.k.trait.comm2022 <- as.matrix(betaknepp2022_clean_traits_N)

species_abundance <- colSums(N.k.trait.comm2022)
zero_abundance_species <- names(species_abundance[species_abundance == 0])

zero_abundance_species # all good

wide_refined_traits_knepp_df_N <- wide_refined_traits_knepp_df_N[!rownames(wide_refined_traits_knepp_df_N) %in% zero_abundance_species, ]

head(wide_refined_traits_knepp_df_N)

species_traits <- rownames(wide_refined_traits_knepp_df_N)
species_communities <- colnames(N.k.trait.comm2022)

common_species <- intersect(species_traits, species_communities)

common_species

wide_refined_traits_knepp_df_N <- wide_refined_traits_knepp_df_N[common_species, ]

N.k.trait.comm2022 <- N.k.trait.comm2022[, common_species]

dim(wide_refined_traits_knepp_df_N)
dim(N.k.trait.comm2022)

fd_results_knepp_N<- dbFD(x = wide_refined_traits_knepp_df_N, a = N.k.trait.comm2022)
fd_results_knepp_N <-as.data.frame(fd_results_knepp_N)
saveRDS(fd_results_knepp_N, "functional_data_final/fd_results_knepp_N.RDS")
write.csv(wide_refined_traits_knepp_df_N, "functional_data_final/wide_refined_traits_knepp_N.csv")


## S BLOCK 
wide_refined_traits_knepp_S <- refined_traits_knepp_S %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp_S)
wide_refined_traits_knepp_S$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_S$scrubbed_species_binomial)

wide_refined_traits_knepp_S <- wide_refined_traits_knepp_S %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_S <- as.data.frame(wide_refined_traits_knepp_S)
rownames(wide_refined_traits_knepp_df_S) <- wide_refined_traits_knepp_df_S$scrubbed_species_binomial
wide_refined_traits_knepp_df_S$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_S)

species_in_traits <- rownames(wide_refined_traits_knepp_df_S)

betaknepp2022_clean_S <- readRDS("clean_data/betaknepp2022_clean_S.RDS")

species_in_community <- colnames(betaknepp2022_clean_S)

common_species <- intersect(species_in_traits, species_in_community)
common_species
betaknepp2022_clean_traits_S <- betaknepp2022_clean_S[, common_species, drop = FALSE]

S.k.trait.comm2022 <- as.matrix(betaknepp2022_clean_traits_S)
species_abundance <- colSums(S.k.trait.comm2022)
zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

species_traits <- rownames(wide_refined_traits_knepp_df_S)
species_communities <- colnames(S.k.trait.comm2022)

common_species <- intersect(species_traits, species_communities)

common_species

wide_refined_traits_knepp_df_S <- wide_refined_traits_knepp_df_S[common_species, ]

S.k.trait.comm2022 <- S.k.trait.comm2022[, common_species]

dim(wide_refined_traits_knepp_df_S)
dim(S.k.trait.comm2022)

fd_results_knepp_S<- dbFD(x = wide_refined_traits_knepp_df_S, a = S.k.trait.comm2022)
fd_results_knepp_S <-as.data.frame(fd_results_knepp_S)
saveRDS(fd_results_knepp_S, "functional_data_final/fd_results_knepp_S.RDS")
write.csv(wide_refined_traits_knepp_df_S, "functional_data_final/wide_refined_traits_knepp_S.csv")


## 2023 KNEPP
wide_refined_traits_knepp2023 <- refined_traits_knepp2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp2023)
wide_refined_traits_knepp2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp2023$scrubbed_species_binomial)

wide_refined_traits_knepp2023 <- wide_refined_traits_knepp2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp2023 <- as.data.frame(wide_refined_traits_knepp2023)
rownames(wide_refined_traits_knepp2023) <- wide_refined_traits_knepp2023$scrubbed_species_binomial
wide_refined_traits_knepp2023$scrubbed_species_binomial <- NULL

species_in_traits <- rownames(wide_refined_traits_knepp2023)
species_in_community <- colnames(betaknepp2023_clean)
common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community # all good
betaknepp2023_clean_traits <- betaknepp2023_clean[, common_species, drop = FALSE]

k.trait.comm2023 <- as.matrix(betaknepp2023_clean_traits)
species_abundance <- colSums(k.trait.comm2023)
zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species
wide_refined_traits_knepp2023 <- wide_refined_traits_knepp2023[!rownames(wide_refined_traits_knepp2023) %in% zero_abundance_species, ]
head(wide_refined_traits_knepp2023)
species_traits <- rownames(wide_refined_traits_knepp2023)
species_communities <- colnames(k.trait.comm2023)
common_species <- intersect(species_traits, species_communities)
common_species

wide_refined_traits_knepp2023 <- wide_refined_traits_knepp2023[common_species, ]

k.trait.comm2023 <- k.trait.comm2023[, common_species]

dim(wide_refined_traits_knepp2023)
dim(k.trait.comm2023)

fd_results_knepp2023 <- dbFD(x = wide_refined_traits_knepp2023, a = k.trait.comm2023)
fd_results_knepp2023 <-as.data.frame(fd_results_knepp2023)
saveRDS(fd_results_knepp2023, "functional_data_final/fd_results_knepp2023.RDS")
write.csv(wide_refined_traits_knepp2023, "functional_data_final/wide_refined_traits_knepp2023.csv")

## M BLOCK 
wide_refined_traits_knepp_M2023 <- refined_traits_knepp_M2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_M2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_M2023$scrubbed_species_binomial)

wide_refined_traits_knepp_M2023 <- wide_refined_traits_knepp_M2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_M2023 <- as.data.frame(wide_refined_traits_knepp_M2023)
rownames(wide_refined_traits_knepp_df_M2023) <- wide_refined_traits_knepp_df_M2023$scrubbed_species_binomial
wide_refined_traits_knepp_df_M2023$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_M2023)

species_in_traits <- rownames(wide_refined_traits_knepp_df_M2023)

betaknepp2023_clean_M <- readRDS("clean_data/betaknepp2023_clean_M.RDS")

species_in_community <- colnames(betaknepp2023_clean_M)
common_species <- intersect(species_in_traits, species_in_community)
betaknepp2023_clean_traits_M <- betaknepp2023_clean_M[, common_species, drop = FALSE]

M.k.trait.comm2023 <- as.matrix(betaknepp2023_clean_traits_M)

species_abundance <- colSums(M.k.trait.comm2023)
zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_knepp_df_M2023 <- wide_refined_traits_knepp_df_M2023[!rownames(wide_refined_traits_knepp_df_M2023) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_M2023))
na_counts

wide_refined_traits_knepp_df_M2023 <- na.omit(wide_refined_traits_knepp_df_M2023)

dim(wide_refined_traits_knepp_df_M2023)
dim(M.k.trait.comm2023)

M.k.trait.comm2023 <- M.k.trait.comm2023[, colnames(M.k.trait.comm2023) %in% rownames(wide_refined_traits_knepp_df_M2023)]

dim(wide_refined_traits_knepp_df_M2023)
dim(M.k.trait.comm2023)

identical(rownames(wide_refined_traits_knepp_df_M2023), colnames(M.k.trait.comm2023))

community_abundance_sums <- rowSums(M.k.trait.comm2023)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
zero_abundance_communities
M.k.trait.comm2023 <- M.k.trait.comm2023[!rownames(M.k.trait.comm2023) %in% zero_abundance_communities, ]

fd_results_knepp_M2023 <- dbFD(x = wide_refined_traits_knepp_df_M2023, a = M.k.trait.comm2023)
fd_results_knepp_M2023 <-as.data.frame(fd_results_knepp_M2023)
saveRDS(fd_results_knepp_M2023, "functional_data_final/fd_results_knepp_M2023.RDS")
write.csv(wide_refined_traits_knepp_df_M2023, "functional_data_final/wide_refined_traits_knepp_M2023.csv")

## N BLOCK 
wide_refined_traits_knepp_N2023 <- refined_traits_knepp_N2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_N2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_N2023$scrubbed_species_binomial)

wide_refined_traits_knepp_N2023 <- wide_refined_traits_knepp_N2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_N2023 <- as.data.frame(wide_refined_traits_knepp_N2023)
rownames(wide_refined_traits_knepp_df_N2023) <- wide_refined_traits_knepp_df_N2023$scrubbed_species_binomial
wide_refined_traits_knepp_df_N2023$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_N2023)

species_in_traits <- rownames(wide_refined_traits_knepp_df_N2023)

betaknepp2023_clean_N <- readRDS("clean_data/betaknepp2023_clean_N.RDS")

species_in_community <- colnames(betaknepp2023_clean_N)

common_species <- intersect(species_in_traits, species_in_community)

betaknepp2023_clean_traits_N<- betaknepp2023_clean_N[, common_species, drop = FALSE]

N.k.trait.comm2023 <- as.matrix(betaknepp2023_clean_traits_N)

species_abundance <- colSums(N.k.trait.comm2023)
zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_knepp_df_N2023 <- wide_refined_traits_knepp_df_N2023[!rownames(wide_refined_traits_knepp_df_N2023) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_N2023))
na_counts

wide_refined_traits_knepp_df_N2023 <- na.omit(wide_refined_traits_knepp_df_N2023)

dim(wide_refined_traits_knepp_df_N2023)
dim(N.k.trait.comm2023)

N.k.trait.comm2023 <- N.k.trait.comm2023[, colnames(N.k.trait.comm2023) %in% rownames(wide_refined_traits_knepp_df_N2023)]

dim(wide_refined_traits_knepp_df_N2023)
dim(N.k.trait.comm2023)

community_abundance_sums <- rowSums(N.k.trait.comm2023)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
zero_abundance_communities

fd_results_knepp_N2023 <- dbFD(x = wide_refined_traits_knepp_df_N2023, a = N.k.trait.comm2023)
fd_results_knepp_N2023 <-as.data.frame(fd_results_knepp_N2023)
saveRDS(fd_results_knepp_N2023, "functional_data_final/fd_results_knepp_N2023.RDS")
write.csv(wide_refined_traits_knepp_df_N2023, "functional_data_final/wide_refined_traits_knepp_N2023.csv")

## S BLOCK 
wide_refined_traits_knepp_S2023 <- refined_traits_knepp_S2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_S2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_S2023$scrubbed_species_binomial)

wide_refined_traits_knepp_S2023 <- wide_refined_traits_knepp_S2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_S2023 <- as.data.frame(wide_refined_traits_knepp_S2023)
rownames(wide_refined_traits_knepp_df_S2023) <- wide_refined_traits_knepp_df_S2023$scrubbed_species_binomial
wide_refined_traits_knepp_df_S2023$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_S2023)

species_in_traits <- rownames(wide_refined_traits_knepp_df_S2023)

betaknepp2023_clean_S <- readRDS("clean_data/betaknepp2023_clean_S.RDS")
species_in_community <- colnames(betaknepp2023_clean_S)
common_species <- intersect(species_in_traits, species_in_community)

betaknepp2023_clean_traits_S<- betaknepp2023_clean_S[, common_species, drop = FALSE]

S.k.trait.comm2023 <- as.matrix(betaknepp2023_clean_traits_S)

species_abundance <- colSums(S.k.trait.comm2023)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_knepp_df_S2023 <- wide_refined_traits_knepp_df_S2023[!rownames(wide_refined_traits_knepp_df_S2023) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_S2023))
na_counts

wide_refined_traits_knepp_df_S2023 <- na.omit(wide_refined_traits_knepp_df_S2023)

dim(wide_refined_traits_knepp_df_S2023)
dim(S.k.trait.comm2023)

S.k.trait.comm2023 <- S.k.trait.comm2023[, colnames(S.k.trait.comm2023) %in% rownames(wide_refined_traits_knepp_df_S2023)]

dim(wide_refined_traits_knepp_df_S2023)
dim(S.k.trait.comm2023)

community_abundance_sums <- rowSums(S.k.trait.comm2023)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
zero_abundance_communities
S.k.trait.comm2023 <- S.k.trait.comm2023[!rownames(S.k.trait.comm2023) %in% zero_abundance_communities, ]

fd_results_knepp_S2023 <- dbFD(x = wide_refined_traits_knepp_df_S2023, a = S.k.trait.comm2023)
fd_results_knepp_S2023 <-as.data.frame(fd_results_knepp_S2023)
saveRDS(fd_results_knepp_S2023, "functional_data_final/fd_results_knepp_S2023.RDS")
write.csv(wide_refined_traits_knepp_df_S2023, "functional_data_final/wide_refined_traits_knepp_S2023.csv")


# 2024
wide_refined_traits_knepp2024 <- refined_traits_knepp2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_knepp2024)
wide_refined_traits_knepp2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp2024$scrubbed_species_binomial)

wide_refined_traits_knepp2024 <- wide_refined_traits_knepp2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp2024 <- as.data.frame(wide_refined_traits_knepp2024)
rownames(wide_refined_traits_knepp2024) <- wide_refined_traits_knepp2024$scrubbed_species_binomial
wide_refined_traits_knepp2024$scrubbed_species_binomial <- NULL

species_in_traits <- rownames(wide_refined_traits_knepp2024)
species_in_community <- colnames(betaknepp2024_clean)
common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
betaknepp2024_clean_traits <- betaknepp2024_clean[, common_species, drop = FALSE]
k.trait.comm2024 <- as.matrix(betaknepp2024_clean_traits)

species_abundance <- colSums(k.trait.comm2024)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_knepp2024 <- wide_refined_traits_knepp2024[!rownames(wide_refined_traits_knepp2024) %in% zero_abundance_species, ]

head(wide_refined_traits_knepp2024)

species_traits <- rownames(wide_refined_traits_knepp2024)
species_communities <- colnames(k.trait.comm2024)

common_species <- intersect(species_traits, species_communities)
common_species

wide_refined_traits_knepp2024 <- wide_refined_traits_knepp2024[common_species, ]
k.trait.comm2024 <- k.trait.comm2024[, common_species]

dim(wide_refined_traits_knepp2024)
dim(k.trait.comm2024)

na_counts <- colSums(is.na(wide_refined_traits_knepp2024))
na_counts

wide_refined_traits_knepp2024 <- na.omit(wide_refined_traits_knepp2024)

dim(wide_refined_traits_knepp2024)
dim(k.trait.comm2024)

k.trait.comm2024 <- k.trait.comm2024[, colnames(k.trait.comm2024) %in% rownames(wide_refined_traits_knepp2024)]

dim(wide_refined_traits_knepp2024)
dim(k.trait.comm2024)

identical(rownames(wide_refined_traits_knepp2024), colnames(k.trait.comm2024))

fd_results_knepp2024 <- dbFD(x = wide_refined_traits_knepp2024, a = k.trait.comm2024)
fd_results_knepp2024 <-as.data.frame(fd_results_knepp2024)
saveRDS(fd_results_knepp2024, "functional_data_final/fd_results_knepp2024.RDS")
write.csv(wide_refined_traits_knepp2024, "functional_data_final/wide_refined_traits_knepp2024.csv")

## M BLOCK 
wide_refined_traits_knepp_M2024 <- refined_traits_knepp_M2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_M2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_M2024$scrubbed_species_binomial)

wide_refined_traits_knepp_M2024 <- wide_refined_traits_knepp_M2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_M2024 <- as.data.frame(wide_refined_traits_knepp_M2024)
rownames(wide_refined_traits_knepp_df_M2024) <- wide_refined_traits_knepp_df_M2024$scrubbed_species_binomial
wide_refined_traits_knepp_df_M2024$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_M2024)

species_in_traits <- rownames(wide_refined_traits_knepp_df_M2024)

betaknepp2024_clean_M <- readRDS("clean_data/betaknepp2024_clean_M.RDS")

species_in_community <- colnames(betaknepp2024_clean_M)

common_species <- intersect(species_in_traits, species_in_community)
betaknepp2024_clean_traits_M <- betaknepp2024_clean_M[, common_species, drop = FALSE]

M.k.trait.comm2024 <- as.matrix(betaknepp2024_clean_traits_M)

species_abundance <- colSums(M.k.trait.comm2024)

zero_abundance_species <- names(species_abundance[species_abundance == 0])

zero_abundance_species

wide_refined_traits_knepp_df_M2024 <- wide_refined_traits_knepp_df_M2024[!rownames(wide_refined_traits_knepp_df_M2024) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_M2024))
na_counts

wide_refined_traits_knepp_df_M2024 <- na.omit(wide_refined_traits_knepp_df_M2024)

dim(wide_refined_traits_knepp_df_M2024)
dim(M.k.trait.comm2024)

M.k.trait.comm2024 <- M.k.trait.comm2024[, colnames(M.k.trait.comm2024) %in% rownames(wide_refined_traits_knepp_df_M2024)]

dim(wide_refined_traits_knepp_df_M2024)
dim(M.k.trait.comm2024)

identical(rownames(wide_refined_traits_knepp_df_M2024), colnames(M.k.trait.comm2024))

community_abundance_sums <- rowSums(M.k.trait.comm2024)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
zero_abundance_communities

M.k.trait.comm2024 <- M.k.trait.comm2024[!rownames(M.k.trait.comm2024) %in% zero_abundance_communities, ]

fd_results_knepp_M2024 <- dbFD(x = wide_refined_traits_knepp_df_M2024, a = M.k.trait.comm2024)
fd_results_knepp_M2024 <-as.data.frame(fd_results_knepp_M2024)
saveRDS(fd_results_knepp_M2024, "functional_data_final/fd_results_knepp_M2024.RDS")
write.csv(wide_refined_traits_knepp_df_M2024, "functional_data_final/wide_refined_traits_knepp_M2024.csv")


## N BLOCK 
wide_refined_traits_knepp_N2024 <- refined_traits_knepp_N2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_N2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_N2024$scrubbed_species_binomial)

wide_refined_traits_knepp_N2024 <- wide_refined_traits_knepp_N2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_N2024 <- as.data.frame(wide_refined_traits_knepp_N2024)
rownames(wide_refined_traits_knepp_df_N2024) <- wide_refined_traits_knepp_df_N2024$scrubbed_species_binomial
wide_refined_traits_knepp_df_N2024$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_N2024)

species_in_traits <- rownames(wide_refined_traits_knepp_df_N2024)

betaknepp2024_clean_N <- readRDS("clean_data/betaknepp2024_clean_N.RDS")

species_in_community <- colnames(betaknepp2024_clean_N)

common_species <- intersect(species_in_traits, species_in_community)

betaknepp2024_clean_traits_N<- betaknepp2024_clean_N[, common_species, drop = FALSE]

N.k.trait.comm2024 <- as.matrix(betaknepp2024_clean_traits_N)

species_abundance <- colSums(N.k.trait.comm2024)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_knepp_df_N2024 <- wide_refined_traits_knepp_df_N2024[!rownames(wide_refined_traits_knepp_df_N2024) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_N2024))
na_counts

wide_refined_traits_knepp_df_N2024 <- na.omit(wide_refined_traits_knepp_df_N2024)

dim(wide_refined_traits_knepp_df_N2024)
dim(N.k.trait.comm2024)

N.k.trait.comm2024 <- N.k.trait.comm2024[, colnames(N.k.trait.comm2024) %in% rownames(wide_refined_traits_knepp_df_N2024)]

dim(wide_refined_traits_knepp_df_N2024)
dim(N.k.trait.comm2024)

community_abundance_sums <- rowSums(N.k.trait.comm2024)

zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])

zero_abundance_communities

fd_results_knepp_N2024 <- dbFD(x = wide_refined_traits_knepp_df_N2024, a = N.k.trait.comm2024)
fd_results_knepp_N2024 <-as.data.frame(fd_results_knepp_N2024)
saveRDS(fd_results_knepp_N2024, "functional_data_final/fd_results_knepp_N2024.RDS")
write.csv(wide_refined_traits_knepp_df_N2024, "functional_data_final/wide_refined_traits_knepp_N2024.csv")

## S BLOCK 
wide_refined_traits_knepp_S2024 <- refined_traits_knepp_S2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_knepp_S2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_knepp_S2024$scrubbed_species_binomial)

wide_refined_traits_knepp_S2024 <- wide_refined_traits_knepp_S2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_knepp_df_S2024 <- as.data.frame(wide_refined_traits_knepp_S2024)
rownames(wide_refined_traits_knepp_df_S2024) <- wide_refined_traits_knepp_df_S2024$scrubbed_species_binomial
wide_refined_traits_knepp_df_S2024$scrubbed_species_binomial <- NULL

head(wide_refined_traits_knepp_df_S2024)

species_in_traits <- rownames(wide_refined_traits_knepp_df_S2024)

betaknepp2024_clean_S <- readRDS("clean_data/betaknepp2024_clean_S.RDS")

species_in_community <- colnames(betaknepp2024_clean_S)

common_species <- intersect(species_in_traits, species_in_community)

betaknepp2024_clean_traits_S<- betaknepp2024_clean_S[, common_species, drop = FALSE]

S.k.trait.comm2024 <- as.matrix(betaknepp2024_clean_traits_S)

species_abundance <- colSums(S.k.trait.comm2024)

zero_abundance_species <- names(species_abundance[species_abundance == 0])

zero_abundance_species
wide_refined_traits_knepp_df_S2024 <- wide_refined_traits_knepp_df_S2024[!rownames(wide_refined_traits_knepp_df_S2024) %in% zero_abundance_species, ]

na_counts <- colSums(is.na(wide_refined_traits_knepp_df_S2024))
na_counts

wide_refined_traits_knepp_df_S2024 <- na.omit(wide_refined_traits_knepp_df_S2024)

dim(wide_refined_traits_knepp_df_S2024)
dim(S.k.trait.comm2024)
S.k.trait.comm2024 <- S.k.trait.comm2024[, colnames(S.k.trait.comm2024) %in% rownames(wide_refined_traits_knepp_df_S2024)]

dim(wide_refined_traits_knepp_df_S2024)
dim(S.k.trait.comm2024)

community_abundance_sums <- rowSums(S.k.trait.comm2024)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
zero_abundance_communities
S.k.trait.comm2024 <- S.k.trait.comm2024[!rownames(S.k.trait.comm2024) %in% zero_abundance_communities, ]

fd_results_knepp_S2024 <- dbFD(x = wide_refined_traits_knepp_df_S2024, a = S.k.trait.comm2024)
fd_results_knepp_S2024 <-as.data.frame(fd_results_knepp_S2024)
saveRDS(fd_results_knepp_S2024, "functional_data_final/fd_results_knepp_S2024.RDS")
write.csv(wide_refined_traits_knepp_df_S2024, "functional_data_final/wide_refined_traits_knepp_S2024.csv")


```

```{r Boothby traits and functional metrics, 2022, 2023, 2024}

species_names_boothby <- colnames(b.comm2022)

formatted_species_list_boothby <- gsub("_", " ", species_names_boothby)

trait_data_boothby <- BIEN_trait_species(formatted_species_list_boothby)
head(trait_data_boothby)

concise_trait_data_boothby <- subset(trait_data_boothby, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_boothby <- concise_trait_data_boothby[order(concise_trait_data_boothby$scrubbed_species_binomial), ]
head(concise_trait_data_boothby)

concise_trait_data_boothby <- concise_trait_data_boothby %>% drop_na(trait_name)
concise_trait_data_boothby <- concise_trait_data_boothby %>% drop_na(trait_value)

unique(concise_trait_data_boothby$trait_name) 

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_boothby %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_boothby %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_boothby <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_boothby)

unique(summarized_traits_boothby$trait_name)

total_nas <- sum(is.na(summarized_traits_boothby))
print(total_nas)

trait_counts <- summarized_traits_boothby %>%
  group_by(trait_name) %>%
  summarize(count = n())

refined_traits_boothby <- summarized_traits_boothby %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_boothby, refined_traits_boothby$scrubbed_species_binomial)
missing_species

boothby2022missing <- c("Avena", "Calamagrostis", "Deschampsia", "Fraxinus", "Lactuca", "Lysimachia", "Rosa", "Rubus", "Rumex", "Vicia", "Viola")

present <- boothby2022missing %in% subset_diaz$Genus

results <- data.frame(
  species = boothby2022missing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% boothby2022missing)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_boothby <- rbind(refined_traits_boothby, average_traits_long)

refined_traits_boothby <- refined_traits_boothby %>%
  mutate(trait_value = str_replace_all(trait_value, ",", ""))
refined_traits_boothby$trait_value <- as.numeric(refined_traits_boothby$trait_value)

duplicates <- refined_traits_boothby %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

refined_traits_boothby <- refined_traits_boothby %>%
  mutate(trait_value = if_else(scrubbed_species_binomial == "Vicia faba" & trait_name == "seed mass",
                               mean(trait_value, na.rm = TRUE),
                               trait_value))

refined_traits_boothby <- refined_traits_boothby %>%
  slice(-184)

wide_data <- refined_traits_boothby %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

boothby2022leaf <- c("Phleum bertolonii", "Tripleurospermum inodorum")

boothby2022plant <- c("Acer campestre", "Aethusa cynapium", "Carpinus betulus", "Chaerophyllum temulum", "Cirsium dissectum", "Geranium dissectum", "Geranium lucidum", "Hordeum vulgare", "Lotus tenuis", "Myosotis laxa", "Phleum bertolonii", "Picris echioides", "Rumex conglomeratus", "Rumex sanguineus", "Senecio sylvaticus", "Triticum aestivum", "Vicia faba", "Vicia tetrasperma", "Viola arvensis"
)

present <- boothby2022leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- boothby2022plant %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = boothby2022plant,
  present2 = present2
) 
present2 # P. echiodes missing

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% boothby2022leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2022plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# Picris echioides missing plant data - not in dias so get from try
pe_height <- subset_try %>%
  filter(
    SpeciesName == "Picris echioides" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(pe_height)
pe_height <- 0.6

new_valuesb <- data.frame(
  scrubbed_species_binomial = c("Picris echioides"),
  trait_name = c("maximum whole plant height"),
  trait_value = c(pe_height)
)

refined_traits_boothby <- rbind(refined_traits_boothby, average_traits_long)
refined_traits_boothby <- rbind(refined_traits_boothby, average_traits_long2)
refined_traits_boothby <- rbind(refined_traits_boothby, new_valuesb)

data_summary <- refined_traits_boothby %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

refined_traits_boothby<-as.data.frame(refined_traits_boothby)

refined_traits_boothby <- refined_traits_boothby %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))
write.csv(refined_traits_boothby, file = "functional_data_final/refined_traits_boothby.csv", row.names = F)

# pivot wider
wide_refined_traits_boothby <- refined_traits_boothby %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_boothby)
wide_refined_traits_boothby$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_boothby$scrubbed_species_binomial)

wide_refined_traits_boothby <- wide_refined_traits_boothby %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_boothby_df <- as.data.frame(wide_refined_traits_boothby)
rownames(wide_refined_traits_boothby_df) <- wide_refined_traits_boothby_df$scrubbed_species_binomial
wide_refined_traits_boothby_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_boothby_df)

na_counts <- colSums(is.na(wide_refined_traits_boothby_df))
na_counts

wide_refined_traits_boothby_df <- na.omit(wide_refined_traits_boothby_df)

b.trait.comm2022 <- as.matrix(betaboothby2022_clean)

dim(wide_refined_traits_boothby_df)
dim(b.trait.comm2022)

species_in_traits <- rownames(wide_refined_traits_boothby_df)
species_in_community <- colnames(betaboothby2022_clean)
species_abundance <- colSums(b.trait.comm2022)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_boothby_df <- wide_refined_traits_boothby_df[!rownames(wide_refined_traits_boothby_df) %in% zero_abundance_species, ]

head(wide_refined_traits_boothby_df)

species_traits <- rownames(wide_refined_traits_boothby_df)
species_communities <- colnames(b.trait.comm2022)
common_species <- intersect(species_traits, species_communities)
common_species

wide_refined_traits_boothby_df <- wide_refined_traits_boothby_df[common_species, ]
b.trait.comm2022 <- b.trait.comm2022[, common_species]
dim(wide_refined_traits_boothby_df)
dim(b.trait.comm2022)

fd_results_boothby <- dbFD(x = wide_refined_traits_boothby_df, a = b.trait.comm2022)
fd_results_boothby<-as.data.frame(fd_results_boothby)
saveRDS(fd_results_boothby,"functional_data_final/fd_results_boothby.RDS")
write.csv(wide_refined_traits_boothby_df, file = "functional_data_final/wide_refined_traits_boothby.csv")

# 2023
species_names_boothby <- colnames(b.comm2023)
formatted_species_list_boothby <- gsub("_", " ", species_names_boothby)

trait_data_boothby2023 <- BIEN_trait_species(formatted_species_list_boothby)
concise_trait_data_boothby2023 <- subset(trait_data_boothby2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_boothby2023 <- concise_trait_data_boothby2023[order(concise_trait_data_boothby2023$scrubbed_species_binomial), ]
head(concise_trait_data_boothby2023)

concise_trait_data_boothby2023 <- concise_trait_data_boothby2023 %>% drop_na(trait_name)
concise_trait_data_boothby2023 <- concise_trait_data_boothby2023 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_boothby2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_boothby2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_boothby2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_boothby2023)

unique(summarized_traits_boothby2023$trait_name)

total_nas <- sum(is.na(summarized_traits_boothby2023))
print(total_nas)

trait_counts <- summarized_traits_boothby2023 %>%
  group_by(trait_name) %>%
  summarize(count = n())

refined_traits_boothby2023 <- summarized_traits_boothby2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_boothby, refined_traits_boothby2023$scrubbed_species_binomial)
missing_species

boothby2023missing <- c("Hieracium")

present <- boothby2023missing %in% subset_diaz$Genus

results <- data.frame(
  species = boothby2023missing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% boothby2023missing)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_boothby2023 <- rbind(refined_traits_boothby2023, average_traits_long)

refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  mutate(trait_value = str_replace_all(trait_value, ",", ""))
refined_traits_boothby2023$trait_value <- as.numeric(refined_traits_boothby2023$trait_value)

duplicates <- refined_traits_boothby2023 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

# take average of seed mass for V. faba
refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  mutate(trait_value = if_else(scrubbed_species_binomial == "Vicia faba" & trait_name == "seed mass",
                               mean(trait_value, na.rm = TRUE),
                               trait_value))

# remove one of these entries so only one remains
refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  slice(-218)

wide_data <- refined_traits_boothby2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

boothby2023leaf <- c("Brassica napus",   "Geranium rotundifolium" ,"Myosotis secunda")

boothby2023plant <- c("Brassica napus", "Crepis vesicaria", "Geranium columbinum", "Geranium dissectum", "Geranium rotundifolium", "Heracleum mantegazzianum", "Hordeum vulgare", "Lolium multiflorum", "Matricaria chamomilla", "Matricaria discoidea", "Myosotis secunda", "Picris echioides", "Prunus padus", "Pulicaria dysenterica", "Triticum aestivum", "Veronica filiformis", "Vicia faba", "Vicia sativa", "Vicia tetrasperma", "Viola arvensis"
)

boothby2023seed <- c("Heracleum mantegazzianum", "Matricaria chamomilla"   , "Matricaria discoidea"   ,  "Pulicaria dysenterica","Salix aurita",           "Veronica filiformis" )

present <- boothby2023leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- boothby2023plant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- boothby2023seed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = boothby2023seed,
  present3= present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% boothby2023leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2023plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2023seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# replace missing S. aurita with mean of genus
mean_seed_mass_salix <- subset_diaz %>%
  filter(Genus == "Salix") %>%
  pull(Diaspore.mass..mg.) %>%
  mean(na.rm = TRUE)

print(mean_seed_mass_salix)

average_traits_long3<- average_traits_long3 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Salix aurita" & is.nan(trait_value) ~ mean_seed_mass_salix,
      TRUE ~ trait_value
    )
  )

# leaf area data for B. napus from try
b_n_a <- subset_try %>%
  filter(
    AccSpeciesName == "Brassica napus" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

b_n_a <- 16943.77

average_traits_long<- average_traits_long %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Brassica napus" & is.nan(trait_value) ~ b_n_a,
      TRUE ~ trait_value
    )
  )

refined_traits_boothby2023 <- rbind(refined_traits_boothby2023, average_traits_long)
refined_traits_boothby2023 <- rbind(refined_traits_boothby2023, average_traits_long2)
refined_traits_boothby2023 <- rbind(refined_traits_boothby2023, average_traits_long3)
refined_traits_boothby2023 <- rbind(refined_traits_boothby2023, new_valuesb)

data_summary <- refined_traits_boothby2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
 dplyr:: select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good
print(refined_traits_boothby2023)

refined_traits_boothby2023<-as.data.frame(refined_traits_boothby2023)
refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  mutate(trait_value = gsub(",", "", trait_value))

refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  mutate(trait_value = as.numeric(trait_value))

refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp"),
    scrubbed_species_binomial
  ))

write.csv(refined_traits_boothby2023, file = "functional_data_final/refined_traits_boothby2023.csv", row.names = F)

# pivot wider
wide_refined_traits_boothby2023 <- refined_traits_boothby2023 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(trait_value = mean(trait_value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_boothby2023)
wide_refined_traits_boothby_df2023 <- as.data.frame(wide_refined_traits_boothby2023)
wide_refined_traits_boothby2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_boothby2023$scrubbed_species_binomial)

wide_refined_traits_boothby2023 <- wide_refined_traits_boothby2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))


rownames(wide_refined_traits_boothby_df2023) <- wide_refined_traits_boothby_df2023$scrubbed_species_binomial
wide_refined_traits_boothby_df2023$scrubbed_species_binomial <- NULL

head(wide_refined_traits_boothby_df2023)

na_counts <- colSums(is.na(wide_refined_traits_boothby_df2023))
na_counts

wide_refined_traits_boothby_df2023 <- na.omit(wide_refined_traits_boothby_df2023)

b.trait.comm2023 <- as.matrix(betaboothby2023_clean)
rownames(wide_refined_traits_boothby_df2023) <- gsub(" ", "_", rownames(wide_refined_traits_boothby_df2023))

dim(wide_refined_traits_boothby_df2023)
dim(b.trait.comm2023)

species_in_traits <- rownames(wide_refined_traits_boothby_df2023)

species_in_community <- colnames(betaboothby2023_clean)

species_abundance <- colSums(b.trait.comm2023)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_boothby_df2023 <- wide_refined_traits_boothby_df2023[!rownames(wide_refined_traits_boothby_df2023) %in% zero_abundance_species, ]

head(wide_refined_traits_boothby_df2023)

species_traits <- rownames(wide_refined_traits_boothby_df2023)
species_communities <- colnames(b.trait.comm2023)

common_species <- intersect(species_traits, species_communities)

common_species
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community

dim(wide_refined_traits_boothby_df2023)
dim(b.trait.comm2023)

fd_results_boothby2023 <- dbFD(x = wide_refined_traits_boothby_df2023, a = b.trait.comm2023)
fd_results_boothby2023<-as.data.frame(fd_results_boothby2023)
saveRDS(fd_results_boothby2023,"functional_data_final/fd_results_boothby2023.RDS")
write.csv(wide_refined_traits_boothby_df2023, file = "functional_data_final/wide_refined_traits_boothby2023.csv")

# 2024
species_names_boothby <- colnames(b.comm2024)

formatted_species_list_boothby <- gsub("_", " ", species_names_boothby)

trait_data_boothby2024 <- BIEN_trait_species(formatted_species_list_boothby)

concise_trait_data_boothby2024 <- subset(trait_data_boothby2024, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_boothby2024 <- concise_trait_data_boothby2024[order(concise_trait_data_boothby2024$scrubbed_species_binomial), ]
head(concise_trait_data_boothby2024)

concise_trait_data_boothby2024 <- concise_trait_data_boothby2024 %>% drop_na(trait_name)
concise_trait_data_boothby2024 <- concise_trait_data_boothby2024 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_boothby2024 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_boothby2024 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_boothby2024 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_boothby2024)

refined_traits_boothby2024 <- summarized_traits_boothby2024 %>%
 dplyr:: select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_boothby, refined_traits_boothby2024$scrubbed_species_binomial)
missing_species

boothby2024missing <- c("Borago pygmaea"  ,    "Bowlesia incana" ,    "Cirsium discolor",    "Crepis mollis"  ,     "Epilobium coloratum", "Festuca subuliflora", "Hedera hibernica"  ,         "Rubus pruinosus"  , "Senecio doria"     ,  "Thymus pulegioides")

boothby2024missing2 <- c("Pinus")

present <- boothby2024missing %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- boothby2024missing2 %in% subset_diaz$Genus

results <- data.frame(
  species = boothby2024missing2,
  present2 = present2
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2024missing)
filtered_diaz2 <- subset_diaz %>% filter(Genus %in% boothby2024missing2)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Genus)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, average_traits_long)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, average_traits_long2)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(trait_value = str_replace_all(trait_value, ",", ""))
refined_traits_boothby2024$trait_value <- as.numeric(refined_traits_boothby2024$trait_value)

duplicates <- refined_traits_boothby2024 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

# take average of seed mass for V. faba
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(trait_value = if_else(scrubbed_species_binomial == "Vicia faba" & trait_name == "seed mass",
                               mean(trait_value, na.rm = TRUE),
                               trait_value))

# remove one of these entries so only one remains
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  slice(-379)

wide_data <- refined_traits_boothby2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

boothby2024leaf <- c(
  "Brassica napus", "Calystegia macrostegia", "Camelina sativa", "Centaurea nigrescens", 
  "Crataegus rhipidophylla", "Epilobium tetragonum", "Fagopyrum esculentum", "Fagopyrum tataricum", 
  "Geranium purpureum", "Geum aleppicum", "Geum macrophyllum", "Helianthemum apenninum", 
  "Hordeum brachyantherum", "Lolium pratense", "Packera werneriifolia", "Persicaria lapathifolia", 
  "Petroselinum crispum", "Picea abies", "Rhamnus saxatilis", "Senecio aureus", 
  "Taraxacum campylodes", "Trifolium alexandrinum", "Tripleurospermum inodorum", "Urospermum picroides", 
  "Rubus pruinosus", "Senecio doria"
)

boothby2024plant <- c(
  "Acer campestre", "Acer saccharum", "Achillea ptarmica", "Aesculus hippocastanum", 
  "Ajuga reptans", "Alopecurus myosuroides", "Anthriscus caucalis", "Athyrium filix-femina", 
  "Atriplex hortensis", "Avena fatua", "Brassica napus", "Brassica nigra", 
  "Brassica rapa", "Calamagrostis epigejos", "Calystegia macrostegia", "Camelina sativa", 
  "Carum carvi", "Centaurea nigrescens", "Cirsium dissectum", "Cirsium tuberosum", 
  "Crataegus rhipidophylla", "Dipsacus fullonum", "Dryopteris carthusiana", "Epilobium tetragonum", 
  "Fagopyrum esculentum", "Fagopyrum tataricum", "Festuca arundinacea", "Filago pyramidata", 
  "Fraxinus pennsylvanica", "Geranium dissectum", "Geranium lucidum", "Geranium palustre", 
  "Geranium purpureum", "Geranium pusillum", "Geum aleppicum", "Geum macrophyllum", 
  "Helianthemum apenninum", "Hieracium vulgatum", "Hirschfeldia incana", "Hordeum brachyantherum", 
  "Hypericum humifusum", "Jacobaea vulgaris", "Juncus conglomeratus", "Lamiastrum galeobdolon", 
  "Lolium pratense", "Matricaria chamomilla", "Myosotis sylvatica", "Packera werneriifolia", 
  "Persicaria lapathifolia", "Petroselinum crispum", "Phacelia tanacetifolia", "Phleum alpinum", 
  "Picea abies", "Picris echioides", "Pilosella officinarum", "Populus alba", 
  "Pyrola minor", "Quercus petraea", "Raphanus raphanistrum", "Rapistrum rugosum", 
  "Rhamnus saxatilis", "Rosa agrestis", "Rosa multiflora", "Rubus caesius", 
  "Rubus saxatilis", "Rumex conglomeratus", "Scandix pecten-veneris", "Senecio erucifolius", 
  "Senecio sylvaticus", "Taraxacum campylodes", "Trifolium alexandrinum", "Trifolium fragiferum", 
  "Trifolium incarnatum", "Triticum aestivum", "Urospermum picroides", "Veronica agrestis", 
  "Veronica serpyllifolia", "Vicia faba", "Vicia sativa", "Vicia tetrasperma", 
  "Viola arvensis", "Viola odorata"
)

boothby2024seed <- c(
  "Athyrium filix-femina", "Dryopteris carthusiana", "Geranium palustre", "Geranium pusillum", 
  "Matricaria chamomilla", "Rubus pruinosus"
)


present <- boothby2024leaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- boothby2024plant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- boothby2024seed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = boothby2024seed,
  present3 = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% boothby2024leaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2024plant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% boothby2024seed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))


average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# get lolium pratense data
lolium_pratense_height <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))


lolium_pratense_leaf <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

print(lolium_pratense_leaf)

lolium_pratense_height <- 0.7833333 
lolium_pratense_leaf <- 3490.177

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Lolium pratense", "Lolium pratense"),
  trait_name = c("maximum whole plant height", "leaf area"),
  trait_value = c(lolium_pratense_height, lolium_pratense_leaf)
)

# Picris echioides missing plant data - not in dias so get from try
pe_height <- subset_try %>%
  filter(
    SpeciesName == "Picris echioides" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(pe_height)
pe_height <- 0.6

new_valuesb <- data.frame(
  scrubbed_species_binomial = c("Picris echioides"),
  trait_name = c("maximum whole plant height"),
  trait_value = c(pe_height)
)

# H vulgatum height
hv_height <- subset_try %>%
  filter(
    SpeciesName == "Hieracium vulgatum" &
    TraitName == "Plant height vegetative"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(hv_height)
hv_height <- 0.4857143

new_valuesc <- data.frame(
  scrubbed_species_binomial = c("Hieracium vulgatum"),
  trait_name = c("maximum whole plant height"),
  trait_value = c(hv_height)
)

# L. galeobdolon height
lg_height <- subset_try %>%
  filter(
    SpeciesName == "Lamiastrum galeobdolon" &
    TraitName == "Plant height vegetative" & ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(lg_height)
lg_height <- 0.6166667

new_valuesd <- data.frame(
  scrubbed_species_binomial = c("Lamiastrum galeobdolon"),
  trait_name = c("maximum whole plant height"),
  trait_value = c(lg_height)
)


refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, average_traits_long)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, average_traits_long2)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, average_traits_long3)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_valuesb)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_valuesc)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_valuesd)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values2)

data_summary <- refined_traits_boothby2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary)

b_n_a <- 16943.77
# B.  napus
refined_traits_boothby2024<- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Brassica napus" & is.nan(trait_value) ~ b_n_a,
      TRUE ~ trait_value
    )
  )

# C. macro
mean_leaf_caly <- subset_diaz %>%
  filter(Genus == "Calystegia") %>%
  pull(Leaf.area..mm2.) %>%
  mean(na.rm = TRUE)

print(mean_leaf_caly)

mean_height_caly <- subset_diaz %>%
  filter(Genus == "Calystegia") %>%
  pull(Plant.height..m.) %>%
  mean(na.rm = TRUE)

print(mean_height_caly)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Calystegia macrostegia" & is.na(trait_value) & trait_name == "leaf area" ~ mean_leaf_caly,
      TRUE ~ trait_value
    )
  )

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Calystegia macrostegia" & is.na(trait_value) & trait_name == "maximum whole plant height" ~ mean_height_caly,
      TRUE ~ trait_value
    )
  )

# C. sativa
cs_leaf <- subset_try %>%
  filter(
    SpeciesName == "Camelina sativa" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

print(cs_leaf)
cs_leaf <- 1005.488

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Camelina sativa" & is.na(trait_value) & trait_name == "leaf area" ~ cs_leaf,
      TRUE ~ trait_value
    )
  )

# F. esc
fagopyrum_leaf_data <- subset_try %>%
  filter(grepl("^Fagopyrum", AccSpeciesName) & TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)")

# mean of the trait_value for the filtered data
mean_leaf_fagopyrum <- fagopyrum_leaf_data %>%
  summarize(mean_value = mean(StdValue, na.rm = TRUE)) %>%
  pull(mean_value)
mean_leaf_fagopyrum

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Fagopyrum esculentum" & is.na(trait_value) & trait_name == "leaf area" ~ mean_leaf_fagopyrum,
      TRUE ~ trait_value
    )
  )

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Fagopyrum tataricum" & is.na(trait_value) & trait_name == "leaf area" ~ mean_leaf_fagopyrum,
      TRUE ~ trait_value
    )
  )

# geum - average of genus
geum_leaf <- subset_diaz %>%
  filter(Genus == "Geum") %>%
  pull(Leaf.area..mm2.) %>%
  mean(na.rm = TRUE)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Geum aleppicum" & is.na(trait_value) & trait_name == "leaf area" ~ geum_leaf,
      TRUE ~ trait_value
    )
  )

# packera height
packera_height <- subset_diaz %>%
  filter(Genus == "Packera") %>%
  pull(Plant.height..m.) %>%
  mean(na.rm = TRUE)
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Packera werneriifolia" & is.na(trait_value) & trait_name == "maximum whole plant height" ~ packera_height,
      TRUE ~ trait_value
    )
  )

# R. pruinosus from genus level diaz
rp_leaf <- subset_diaz %>%
  filter(Genus == "Rubus") %>%
  pull(Leaf.area..mm2.) %>%
  mean(na.rm = TRUE)

rp_seed <- subset_diaz %>%
  filter(Genus == "Rubus") %>%
  pull(Diaspore.mass..mg.) %>%
  mean(na.rm = TRUE)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Rubus pruinosus" & is.na(trait_value) & trait_name == "leaf area" ~ rp_leaf,
      TRUE ~ trait_value
    )
  )

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Rubus pruinosus" & is.na(trait_value) & trait_name == "seed mass" ~ rp_seed,
      TRUE ~ trait_value
    )
  )

# remove dupes
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  slice(-c(508, 388))

# S. aureus
sa_leaf <- subset_diaz %>%
  filter(Genus == "Senecio") %>%
  pull(Leaf.area..mm2.) %>%
  mean(na.rm = TRUE)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Senecio aureus" & is.na(trait_value) & trait_name == "leaf area" ~ sa_leaf,
      TRUE ~ trait_value
    )
  )

# same for doria
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Senecio doria" & is.na(trait_value) & trait_name == "leaf area" ~ sa_leaf,
      TRUE ~ trait_value
    )
  )

# remove dupes
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  slice(-c(390))

# T. ax
t_ax_leaf <- subset_try %>%
  filter(
    SpeciesName == "Trifolium alexandrinum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

t_ax_leaf <- 1389.797
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Trifolium alexandrinum" & is.na(trait_value) & trait_name == "leaf area" ~ t_ax_leaf,
      TRUE ~ trait_value
    )
  )

# recheck
data_summary <- refined_traits_boothby2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary)
# these cant get data for
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  filter(!scrubbed_species_binomial %in% c("Petroselinum crispum", "Urospermum picroides"))

print(refined_traits_boothby2024)

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " spp."),
    scrubbed_species_binomial
  ))

refined_traits_boothby2024<-as.data.frame(refined_traits_boothby2024)
refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(trait_value = gsub(",", "", trait_value))

refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  mutate(trait_value = as.numeric(trait_value))

# b. pygmaea
bp_height <- subset_try %>%
  filter(
    str_starts(AccSpeciesName, "Borago") &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(bp_height)

# leaf and seed
bp_seed <- subset_diaz %>%
  filter(Genus == "Borago") %>%
  mutate(Diaspore.mass..mg. = as.numeric(Diaspore.mass..mg.)) %>%
  summarise(average_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

print(bp_seed)

bp_leaf <- subset_diaz %>%
  filter(Genus == "Borago") %>%
  mutate(Leaf.area..mm2. = as.numeric(Leaf.area..mm2.)) %>%
  summarise(avg_leaf = mean(Leaf.area..mm2., na.rm = TRUE))

print(bp_leaf)

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("maximum whole plant height"),
  trait_value = 0.525
)

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("leaf area"),
  trait_value = 3857.29
)

new_values4 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("seed mass"),
  trait_value = 16.304
)

# festuca
fs_height <- subset_try %>%
  filter(
    str_starts(AccSpeciesName, "Festuca") &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(fs_height)

# leaf and seed
fs_seed <- subset_diaz %>%
  filter(Genus == "Festuca") %>%
  mutate(Diaspore.mass..mg. = as.numeric(Diaspore.mass..mg.)) %>%
  summarise(average_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

print(fs_seed)

fs_leaf <- subset_diaz %>%
  filter(Genus == "Festuca") %>%
  mutate(Leaf.area..mm2. = as.numeric(Leaf.area..mm2.)) %>%
  summarise(avg_leaf = mean(Leaf.area..mm2., na.rm = TRUE))

print(fs_leaf)

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Festuca subuliflora"),
  trait_name = c("maximum whole plant height"),
  trait_value = 0.450909
)

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Festuca subuliflora"),
  trait_name = c("leaf area"),
  trait_value = 449.8132
)

new_values4 <- data.frame(
  scrubbed_species_binomial = c("Festuca subuliflora"),
  trait_name = c("seed mass"),
  trait_value = 1.116909
)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values2)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values3)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values4)

# h hibernica
hh_plant <- subset_diaz %>%
  filter(Genus == "Hedera") %>%
  mutate(Plant.height..m. = as.numeric(Plant.height..m.)) %>%
  summarise(average_height = mean(Plant.height..m., na.rm = TRUE))

print(hh_plant)

hh_seed <- subset_diaz %>%
  filter(Genus == "Hedera") %>%
  mutate(Diaspore.mass..mg. = as.numeric(Diaspore.mass..mg.)) %>%
  summarise(average_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

print(hh_seed)

hh_leaf <- subset_diaz %>%
  filter(Genus == "Hedera") %>%
  mutate(Leaf.area..mm2. = as.numeric(Leaf.area..mm2.)) %>%
  summarise(avg_leaf = mean(Leaf.area..mm2., na.rm = TRUE))

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Hedera hibernica"),
  trait_name = c("maximum whole plant height"),
  trait_value = 13.34675
)

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Hedera hibernica"),
  trait_name = c("leaf area"),
  trait_value = 2585.21
)

new_values4 <- data.frame(
  scrubbed_species_binomial = c("Hedera hibernica"),
  trait_name = c("seed mass"),
  trait_value = 37.184
)


refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values2)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values3)
refined_traits_boothby2024 <- rbind(refined_traits_boothby2024, new_values4)



write.csv(refined_traits_boothby2024, file = "functional_data_final/refined_traits_boothby2024.csv", row.names = F)

# pivot wider
wide_refined_traits_boothby2024 <- refined_traits_boothby2024 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(trait_value = mean(trait_value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

head(wide_refined_traits_boothby2024)
wide_refined_traits_boothby_df2024 <- as.data.frame(wide_refined_traits_boothby2024)
wide_refined_traits_boothby2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_boothby2024$scrubbed_species_binomial)

wide_refined_traits_boothby2024 <- wide_refined_traits_boothby2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

rownames(wide_refined_traits_boothby_df2024) <- wide_refined_traits_boothby_df2024$scrubbed_species_binomial
wide_refined_traits_boothby_df2024$scrubbed_species_binomial <- NULL

head(wide_refined_traits_boothby_df2024)

na_counts <- colSums(is.na(wide_refined_traits_boothby_df2024))
na_counts

wide_refined_traits_boothby_df2024 <- na.omit(wide_refined_traits_boothby_df2024)

b.trait.comm2024 <- as.matrix(betaboothby2024_clean)
rownames(wide_refined_traits_boothby_df2024) <- gsub(" ", "_", rownames(wide_refined_traits_boothby_df2024))

dim(wide_refined_traits_boothby_df2024)
dim(b.trait.comm2024)

species_in_traits <- rownames(wide_refined_traits_boothby_df2024)

species_in_community <- colnames(betaboothby2024_clean)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
species_abundance <- colSums(b.trait.comm2024)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_boothby_df2024 <- wide_refined_traits_boothby_df2024[!rownames(wide_refined_traits_boothby_df2024) %in% zero_abundance_species, ]

head(wide_refined_traits_boothby_df2024)

species_traits <- rownames(wide_refined_traits_boothby_df2024)
species_communities <- colnames(b.trait.comm2024)

common_species <- intersect(species_traits, species_communities)
common_species

wide_refined_traits_boothby_df2024 <- wide_refined_traits_boothby_df2024[common_species, ]
b.trait.comm2024 <- b.trait.comm2024[, common_species]
dim(wide_refined_traits_boothby_df2024)
dim(b.trait.comm2024)

boothby_fd_results2024 <- dbFD(x = wide_refined_traits_boothby_df2024, a = b.trait.comm2024)
fd_results_boothby2024<-as.data.frame(boothby_fd_results2024)
saveRDS(fd_results_boothby2024,"functional_data_final/fd_results_boothby2024.RDS")
write.csv(wide_refined_traits_boothby_df2024, file = "functional_data_final/wide_refined_traits_boothby2024.csv")
```

```{r Budworth traits and functional metrics}

br.comm2021 <- as.matrix(betabr2021_clean)
species_names_br <- colnames(br.comm2021)
formatted_species_list_br <- gsub("_", " ", species_names_br)

trait_data_br <- BIEN_trait_species(formatted_species_list_br)
head(trait_data_br)

concise_trait_data_br <- subset(trait_data_br, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_br <- concise_trait_data_br[order(concise_trait_data_br$scrubbed_species_binomial), ]
head(concise_trait_data_br)

concise_trait_data_br <- concise_trait_data_br %>% drop_na(trait_name)
concise_trait_data_br <- concise_trait_data_br %>% drop_na(trait_value)

unique(concise_trait_data_br$trait_name)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_br %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_br %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_br <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_br)

trait_counts <- summarized_traits_br %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

total_nas <- sum(is.na(summarized_traits_br))
print(total_nas)

refined_traits_br <- summarized_traits_br %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

print(refined_traits_br)
missing_species <- setdiff(formatted_species_list_br, refined_traits_br$scrubbed_species_binomial)
missing_species

missing_species

budworthmissing <- c("Betula","Quercus","Salix")
budworthmissing2 <- c("Pteridium aquilinum")

present <- budworthmissing %in% subset_diaz$Genus
present2 <- budworthmissing2 %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = budworthmissing2,
  present2 = present2
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% budworthmissing)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% budworthmissing2)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits2)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

p_aq <- subset_try %>%
  filter(
    AccSpeciesName == "Pteridium aquilinum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

p_aq <- 2044.367

average_traits_long2<- average_traits_long2 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Pteridium aquilinum" & is.nan(trait_value) ~ p_aq,
      TRUE ~ trait_value
    )
  )

refined_traits_br <- rbind(refined_traits_br, average_traits_long)
refined_traits_br <- rbind(refined_traits_br, average_traits_long2)

wide_data <- refined_traits_br %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

budworthplant <- c("Ilex aquifolium")

present <- budworthplant %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = budworthplant,
  present= present
) 
present

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% budworthplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_br <- rbind(refined_traits_br, average_traits_long2)

data_summary <- refined_traits_br %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

refined_traits_br <- refined_traits_br %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " sp."),
    scrubbed_species_binomial
  ))

refined_traits_br<-as.data.frame(refined_traits_br)
write.csv(refined_traits_br, "functional_data_final/refined_traits_br.csv")

# pivot wider
wide_refined_traits_br <- refined_traits_br %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_br$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_br$scrubbed_species_binomial)

wide_refined_traits_br <- wide_refined_traits_br %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_br_df <- as.data.frame(wide_refined_traits_br)
rownames(wide_refined_traits_br_df) <- wide_refined_traits_br_df$scrubbed_species_binomial
wide_refined_traits_br_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_br_df)

na_counts <- colSums(is.na(wide_refined_traits_br_df))
na_counts

wide_refined_traits_br_df <- na.omit(wide_refined_traits_br_df)

species_in_traits <- rownames(wide_refined_traits_br_df)
species_in_community <- colnames(betabr2021_clean)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
common_species <- intersect(species_in_traits, species_in_community)
betabr2021_clean_traits <- betabr2021_clean[, common_species, drop = FALSE]

br.trait.comm2021 <- as.matrix(betabr2021_clean_traits)

dim(wide_refined_traits_br_df)
dim(br.trait.comm2021)

species_in_traits <- rownames(wide_refined_traits_br_df)

species_in_community <- colnames(br.trait.comm2021)

species_abundance <- colSums(br.trait.comm2021)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_br_df <- wide_refined_traits_br_df[!rownames(wide_refined_traits_br_df) %in% zero_abundance_species, ]

head(wide_refined_traits_br_df)

fd_results_br <- dbFD(x = wide_refined_traits_br_df, a = br.trait.comm2021)
fd_results_br <- as.data.frame(fd_results_br)
saveRDS(fd_results_br, "functional_data_final/fd_results_br.RDS")
write.csv(wide_refined_traits_br_df, "functional_data_final/wide_refined_traits_br.csv")
```

```{r Silwood traits and functional metrics}

s.comm2021 <- as.matrix(betasilwood2021_clean)
species_names_silwood <- colnames(s.comm2021)

formatted_species_list_silwood <- gsub("_", " ", species_names_silwood)

trait_data_silwood <- BIEN_trait_species(formatted_species_list_silwood)
head(trait_data_silwood)

concise_trait_data_silwood <- subset(trait_data_silwood, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_silwood <- concise_trait_data_silwood[order(concise_trait_data_silwood$scrubbed_species_binomial), ]
head(concise_trait_data_silwood)

concise_trait_data_silwood <- concise_trait_data_silwood %>% drop_na(trait_name)
concise_trait_data_silwood <- concise_trait_data_silwood %>% drop_na(trait_value)

unique(concise_trait_data_silwood$trait_name)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_silwood %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_silwood %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_silwood <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_silwood)

trait_counts <- summarized_traits_silwood %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

total_nas <- sum(is.na(summarized_traits_silwood))
print(total_nas)

refined_traits_silwood <- summarized_traits_silwood %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

print(refined_traits_silwood)

missing_species <- setdiff(formatted_species_list_silwood, refined_traits_silwood$scrubbed_species_binomial)
missing_species

wide_data <- refined_traits_silwood %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

silwoodplant <- c("Hyacinthoides hispanica", "Lathryus latifolius", "Stellaria graminea")
silwoodseed <- c("Hyacinthoides hispanica")

present <- silwoodplant %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- silwoodseed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = silwoodseed,
  present2= present2
) 
present2

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwoodplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwoodseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  # Clean up trait names by removing the 'avg_' prefix
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))


refined_traits_silwood <- rbind(refined_traits_silwood, average_traits_long2)
refined_traits_silwood <- rbind(refined_traits_silwood, average_traits_long3)

# fill in L. latifolius from try
lati_height <- subset_try %>%
  filter(SpeciesName == "Lathyrus latifolius" &
         TraitName == "Plant height vegetative" & ValueKindName == "Maximum") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE)

lati_height <- 2.5

new_row <- tibble(
  scrubbed_species_binomial = "Lathyrus latifolius",
  trait_name = "maximum whole plant height",
  trait_value = "2.5"
)

refined_traits_silwood <- bind_rows(refined_traits_silwood, new_row)

data_summary <- refined_traits_silwood %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary)

refined_traits_silwood<-as.data.frame(refined_traits_silwood)
write.csv(refined_traits_silwood, "functional_data_final/refined_traits_silwood.csv")

# pivot wider
# remove commas and change to numeric 
refined_traits_silwood <- refined_traits_silwood %>%
  mutate(trait_value = str_replace_all(trait_value, ",", ""))
refined_traits_silwood$trait_value <- as.numeric(refined_traits_silwood$trait_value)

duplicates <- refined_traits_silwood %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

refined_traits_silwood <- refined_traits_silwood %>%
  mutate(trait_value = if_else(scrubbed_species_binomial == "Hyacinthoides hispanica" & trait_name == "seed mass",
                               mean(trait_value, na.rm = TRUE),
                               trait_value))

wide_refined_traits_silwood <- refined_traits_silwood %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_silwood$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_silwood$scrubbed_species_binomial)

wide_refined_traits_silwood <- wide_refined_traits_silwood %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_silwood_df <- as.data.frame(wide_refined_traits_silwood)
rownames(wide_refined_traits_silwood_df) <- wide_refined_traits_silwood_df$scrubbed_species_binomial
wide_refined_traits_silwood_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_silwood_df)

na_counts <- colSums(is.na(wide_refined_traits_silwood_df))
na_counts

wide_refined_traits_silwood_df <- na.omit(wide_refined_traits_silwood_df)
species_in_traits <- rownames(wide_refined_traits_silwood_df)
species_in_community <- colnames(betasilwood2021_clean)

common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
betasilwood2021_clean_traits <- betasilwood2021_clean[, common_species, drop = FALSE]

s.trait.comm2021 <- as.matrix(betasilwood2021_clean_traits)
dim(wide_refined_traits_silwood_df)
dim(s.trait.comm2021)

species_in_traits <- rownames(wide_refined_traits_silwood_df)
species_in_community <- colnames(s.trait.comm2021)
species_abundance <- colSums(s.trait.comm2021)
zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

wide_refined_traits_silwood_df <- wide_refined_traits_silwood_df[!rownames(wide_refined_traits_silwood_df) %in% zero_abundance_species, ]
head(wide_refined_traits_silwood_df)

species_traits <- rownames(wide_refined_traits_silwood_df)
species_communities <- colnames(s.trait.comm2021)
common_species <- intersect(species_traits, species_communities)
common_species

wide_refined_traits_silwood_df <- wide_refined_traits_silwood_df[common_species, ]
s.trait.comm2021 <- s.trait.comm2021[, common_species]

dim(wide_refined_traits_silwood_df)
dim(s.trait.comm2021)

# Run dbFD with the cleaned data frame
fd_results_silwood_2021 <- dbFD(x = wide_refined_traits_silwood_df, a = s.trait.comm2021)
fd_results_silwood_2021 <- as.data.frame(fd_results_silwood_2021)
saveRDS(fd_results_silwood_2021, "functional_data_final/fd_results_silwood_2021.RDS")
write.csv(wide_refined_traits_silwood_df, "functional_data_final/wide_refined_traits_silwood_2021.csv")

## 2022
s.comm2022 <- as.matrix(betasilwood2022_clean)
species_names_silwood <- colnames(s.comm2022)
formatted_species_list_silwood <- gsub("_", " ", species_names_silwood)

trait_data_silwood <- BIEN_trait_species(formatted_species_list_silwood)
trait_data_silwood2022 <- trait_data_silwood
head(trait_data_silwood2022)

concise_trait_data_silwood2022 <- subset(trait_data_silwood2022, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_silwood2022 <- concise_trait_data_silwood2022 %>% drop_na(trait_name)
concise_trait_data_silwood2022 <- concise_trait_data_silwood2022 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_silwood2022 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_silwood2022 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_silwood2022 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_silwood2022)

trait_counts <- summarized_traits_silwood2022 %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

total_nas <- sum(is.na(summarized_traits_silwood2022))
print(total_nas)

refined_traits_silwood2022 <- summarized_traits_silwood2022 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_silwood, refined_traits_silwood2022$scrubbed_species_binomial)
missing_species

silwood2022missing <- c("Pteridium aquilinum")

present <- silwood2022missing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = silwood2022missing,
  present = present
) 

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwood2022missing)

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits2)

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

p_aq <- 2044.367

average_traits_long2<- average_traits_long2 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Pteridium aquilinum" & is.nan(trait_value) ~ p_aq,
      TRUE ~ trait_value
    )
  )

refined_traits_silwood2022 <- rbind(refined_traits_silwood2022, average_traits_long2)

wide_data <- refined_traits_silwood2022 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

silwoodplant <- c("Carex hirta"    ,       "Carex muricata",        "Carex remota"    ,      "Carex riparia",       
 "Dryopteris filix-mas" , "Hypericum tetrapterum", "Ilex aquifolium"     ,  "Juncus conglomeratus" ,
 "Myosotis sylvatica" ,   "Pilosella officinarum" ,"Prunus padus"   ,       "Stellaria graminea",   
"Veronica officinalis"  ,"Vicia sativa")

silwoodseed <- c("Carex riparia", "Dryopteris filix-mas", "Equisetum arvense"   , "Holcus mollis")

present <- silwoodplant %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- silwoodseed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = silwoodseed,
  present2= present2
) 
present2

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwoodplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwoodseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))


average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))


refined_traits_silwood2022 <- rbind(refined_traits_silwood2022, average_traits_long2)
refined_traits_silwood2022 <- rbind(refined_traits_silwood2022, average_traits_long3)

data_summary <- refined_traits_silwood2022 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary)

refined_traits_silwood2022 <- as.data.frame(refined_traits_silwood2022)
write.csv(refined_traits_silwood2022, "functional_data_final/refined_traits_silwood2022.csv")

# pivot wider
wide_refined_traits_silwood2022 <- refined_traits_silwood2022 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_silwood2022$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_silwood2022$scrubbed_species_binomial)

wide_refined_traits_silwood2022 <- wide_refined_traits_silwood2022 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_silwood_df2022 <- as.data.frame(wide_refined_traits_silwood2022)
rownames(wide_refined_traits_silwood_df2022) <- wide_refined_traits_silwood_df2022$scrubbed_species_binomial
wide_refined_traits_silwood_df2022$scrubbed_species_binomial <- NULL

head(wide_refined_traits_silwood_df2022)

na_counts <- colSums(is.na(wide_refined_traits_silwood_df2022))
na_counts

wide_refined_traits_silwood_df2022 <- na.omit(wide_refined_traits_silwood_df2022)
species_in_traits <- rownames(wide_refined_traits_silwood_df2022)
species_in_community <- colnames(betasilwood2022_clean)

common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community

betasilwood2022_clean_traits <- betasilwood2022_clean[, common_species, drop = FALSE]
s.trait.comm2022 <- as.matrix(betasilwood2022_clean_traits)

dim(wide_refined_traits_silwood_df2022)
dim(s.trait.comm2022)
species_in_traits <- rownames(wide_refined_traits_silwood_df2022)
species_in_community <- colnames(s.trait.comm2022)
species_abundance <- colSums(s.trait.comm2022)

zero_abundance_species <- names(species_abundance[species_abundance == 0])
zero_abundance_species

fd_results_silwood_2022 <- dbFD(x = wide_refined_traits_silwood_df2022, a = s.trait.comm2022)
fd_results_silwood_2022 <- as.data.frame(fd_results_silwood_2022)
saveRDS(fd_results_silwood_2022, "functional_data_final/fd_results_silwood_2022.RDS")
write.csv(wide_refined_traits_silwood_df2022, "functional_data_final/wide_refined_traits_silwood_2022.csv")

## 2023
s.comm2023 <- as.matrix(betasilwood2023_clean)
species_names_silwood <- colnames(s.comm2023)
formatted_species_list_silwood <- gsub("_", " ", species_names_silwood)

trait_data_silwood2023 <- BIEN_trait_species(formatted_species_list_silwood)
head(trait_data_silwood2023)

concise_trait_data_silwood2023 <- subset(trait_data_silwood2023, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_silwood2023 <- concise_trait_data_silwood2023 %>% drop_na(trait_name)
concise_trait_data_silwood2023 <- concise_trait_data_silwood2023 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_silwood2023 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_silwood2023 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarized_traits_silwood2023 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarized_traits_silwood2023)

trait_counts <- summarized_traits_silwood2023 %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

total_nas <- sum(is.na(summarized_traits_silwood2023))
print(total_nas)

refined_traits_silwood2023 <- summarized_traits_silwood2023 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_silwood, refined_traits_silwood2023$scrubbed_species_binomial)
missing_species

silwood2023missing <- c("Crataegus marshallii"   ,          "Hydrocotyle sibthorpioides")
silwood2023missing2 <- c("Crepis")

present <- silwood2023missing %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- silwood2023missing2%in% subset_diaz$Genus

results <- data.frame(
  species = silwood2023missing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Genus %in% silwood2023missing2)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% silwood2023missing)

average_traits <- filtered_diaz %>%
  group_by(Genus) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Genus)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

# fill in missing
crataegus_data <- subset_diaz %>%
  filter(Genus == "Crataegus")

c_m_leaf <- crataegus_data %>%
  summarise(avg_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE)) %>%
  pull(avg_leaf_area)

print(c_m_leaf)

c_m_leaf <- 1951.77

average_traits_long2 <- average_traits_long2 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Crataegus marshallii" & trait_name == "leaf area" ~ c_m_leaf,
      TRUE ~ trait_value
    )
  )

h_data <- subset_diaz %>%
  filter(Genus == "Hydrocotyle")

h_seed <- h_data %>%
  summarise(avg_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE)) %>%
  pull(avg_seed_mass)

print(h_seed)

h_seed <- 0.3186

average_traits_long2 <- average_traits_long2 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Hydrocotyle sibthorpioides" & trait_name == "seed mass" ~ h_seed,
      TRUE ~ trait_value
    )
  )

refined_traits_silwood2023 <- rbind(refined_traits_silwood2023, average_traits_long)
refined_traits_silwood2023 <- rbind(refined_traits_silwood2023, average_traits_long2)

data_summary <- refined_traits_silwood2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_leaf_area = !leaf_area,
    missing_max_height = !max_height,
    missing_seed_mass = !seed_mass,
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_leaf_area, missing_max_height, missing_seed_mass, missing_traits)

print(missing_data_summary)

print(refined_traits_silwood2023)

# A. tataricum
a_tat_leaf <- subset_try %>%
  filter(AccSpeciesName == "Acer tataricum" &
         TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 
a_tat_leaf <- 3000

a_tat_plant <- subset_try %>%
  filter(AccSpeciesName == "Acer tataricum" &
         TraitName == "Plant height vegetative") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 
a_tat_plant <- 6.490167

# A. filix
a_f_plant <- subset_try %>%
  filter(AccSpeciesName == "Athyrium filix-femina" &
         TraitName == "Plant height vegetative" & ValueKindName == "Maximum") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 
a_f_plant <- 1.025

a_f_seed <- 0 # from diaz

# carex hirta
c_h_height <- 0.269

# c spicata
c_s_height <- 0.352

# Festuca arundinacea
f_a_height <- 0.724

# impatiens capensis
i_c_leaf <- 1858.38
i_c_seed <- 5.834

# i parviflora
i_p_height <- 0.608

# j vulgaris
j_v_height <- 0.543

# l. caerula
l_c_seed <- subset_diaz %>%
  filter(Genus == "Lonicera") %>%
  summarize(average_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

# Lysimachia nummularia
l_n_plant <- 0.304

# Myosotis discolor
m_d_height <- 0.153

# pilosella officinarum 
p_o_height <- 0.111

# r. sardous
r_s_plant <- 0.162
r_s_seed <- 1.244

# s. alsine leaf
s_al_leaf <- subset_try %>%
  filter(AccSpeciesName == "Stellaria alsine" &
         TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  pull(StdValue) %>%
  as.numeric() %>% 
  mean(na.rm = TRUE) 
s_al_leaf <- 316

# Stellaria graminea 
s_g_height <- 0.334

# Veronica agrestis
v_a_height <- 0.206

# v. parviflora
v_p_height <- 0.23
v_p_leaf <- subset_diaz %>%
  filter(Genus == "Vicia") %>%
  summarize(average_leaf = mean(Leaf.area..mm2., na.rm = TRUE))
v_p_leaf <- 198.1591

# v sativa
v_s_height <- 0.45

# c remota height 0.433

# join back
mean_values <- tibble(
  scrubbed_species_binomial = c("Acer tataricum", "Athyrium filix-femina", "Carex hirta", "Carex spicata", "Carex remota",       "Festuca arundinacea", "Impatiens capensis", "Impatiens parviflora", 
                                "Jacobaea vulgaris", "Lonicera caerulea", "Lysimachia nummularia", 
                                "Myosotis discolor", "Pilosella officinarum", "Ranunculus sardous", 
                                "Stellaria alsine", "Stellaria graminea", "Veronica agrestis", 
                                "Vicia parviflora", "Vicia sativa"),
  leaf_area = c(3000, NA, NA, NA, NA, NA, 1858.38, NA, NA, NA, NA, NA, NA, NA, 316, NA, NA, 198.1591, NA),
  max_height = c(6.490167, 1.025, 0.269, 0.352, 0.433, 0.724, NA, 0.608, 0.543, NA, 0.304, 0.153, 0.111, 0.162, NA, 0.334, 0.206, 0.23, 0.45),
  seed_mass = c(NA, 0, NA, NA,NA, NA, 5.834, NA, NA, 11.82162, NA, NA, NA, 1.244, NA, NA, NA, NA, NA)
)

mean_values_long <- mean_values %>%
  pivot_longer(cols = c(leaf_area, max_height, seed_mass), 
               names_to = "trait_name", 
               values_to = "trait_value") %>%
  filter(!is.na(trait_value)) %>%
  mutate(trait_name = case_when(
    trait_name == "leaf_area" ~ "leaf area",
    trait_name == "max_height" ~ "maximum whole plant height",
    trait_name == "seed_mass" ~ "seed mass",
    TRUE ~ trait_name
  ))

mean_values_long <- mean_values_long %>%
  mutate(trait_value = as.character(trait_value))

refined_traits_silwood2023 <- refined_traits_silwood2023 %>%
  bind_rows(mean_values_long)

print(refined_traits_silwood2023)

data_summary <- refined_traits_silwood2023 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_leaf_area = !leaf_area,
    missing_max_height = !max_height,
    missing_seed_mass = !seed_mass,
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_leaf_area, missing_max_height, missing_seed_mass, missing_traits)

print(missing_data_summary)

refined_traits_silwood2023 <- refined_traits_silwood2023 %>%
  mutate(scrubbed_species_binomial = if_else(
    str_count(scrubbed_species_binomial, " ") == 0,
    paste0(scrubbed_species_binomial, " spp."),
    scrubbed_species_binomial
  ))

refined_traits_silwood2023 <- as.data.frame(refined_traits_silwood2023)
write.csv(refined_traits_silwood2023, "functional_data_final/refined_traits_silwood2023.csv")

# pivot wider
wide_refined_traits_silwood2023 <- refined_traits_silwood2023 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_silwood2023$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_silwood2023$scrubbed_species_binomial)

wide_refined_traits_silwood2023 <- wide_refined_traits_silwood2023 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_silwood_df2023 <- as.data.frame(wide_refined_traits_silwood2023)
rownames(wide_refined_traits_silwood_df2023) <- wide_refined_traits_silwood_df2023$scrubbed_species_binomial
wide_refined_traits_silwood_df2023$scrubbed_species_binomial <- NULL

head(wide_refined_traits_silwood_df2023)

na_counts <- colSums(is.na(wide_refined_traits_silwood_df2023))
na_counts

wide_refined_traits_silwood_df2023<- na.omit(wide_refined_traits_silwood_df2023)
betasilwood2023_clean <- betasilwood2023_clean %>%
  rename(Luzula_campestris = `Luzula campestris`)
species_in_traits <- rownames(wide_refined_traits_silwood_df2023)
species_in_community <- colnames(betasilwood2023_clean)

common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
betasilwood2023_clean_traits <- betasilwood2023_clean[, common_species, drop = FALSE]

s.trait.comm2023 <- as.matrix(betasilwood2023_clean_traits)

dim(wide_refined_traits_silwood_df2023)
dim(s.trait.comm2023)
species_in_traits <- rownames(wide_refined_traits_silwood_df2023)

species_in_community <- colnames(s.trait.comm2023)

species_abundance <- colSums(s.trait.comm2023)

zero_abundance_species <- names(species_abundance[species_abundance == 0])

zero_abundance_species

fd_results_silwood_2023 <- dbFD(x = wide_refined_traits_silwood_df2023, a = s.trait.comm2023)
fd_results_silwood_2023 <- as.data.frame(fd_results_silwood_2023)
saveRDS(fd_results_silwood_2023, "functional_data_final/fd_results_silwood_2023.RDS")
write.csv(wide_refined_traits_silwood_df2023, "functional_data_final/wide_refined_traits_silwood_2023.csv")
```

```{r Harold's Park traits and functional metrics}

hpf2024.comm <- as.matrix(betahpf2024_clean)
species_names_hpf <- colnames(hpf2024.comm)

formatted_species_list_hpf <- gsub("_", " ", species_names_hpf)

trait_data_hpf2024 <- BIEN_trait_species(formatted_species_list_hpf)
head(trait_data_hpf2024)

concise_trait_data_hpf2024 <- subset(trait_data_hpf2024, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_hpf2024 <- concise_trait_data_hpf2024[order(concise_trait_data_hpf2024$scrubbed_species_binomial), ]
head(concise_trait_data_hpf2024)

concise_trait_data_hpf2024 <- concise_trait_data_hpf2024 %>% drop_na(trait_name)
concise_trait_data_hpf2024 <- concise_trait_data_hpf2024 %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_hpf2024 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_hpf2024 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarised_traits_hpf2024 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarised_traits_hpf2024)

trait_counts <- summarised_traits_hpf2024 %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

refined_traits_hpf2024 <- summarised_traits_hpf2024 %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_hpf, refined_traits_hpf2024$scrubbed_species_binomial)
missing_species

hpfmissing <- c("Lepidium didymum"  ,  "Lysimachia arvensis", "Potentilla indica"  , "Rumex obstusifolius", "Symphytum asperum")

present <- hpfmissing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = hpfmissing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hpfmissing)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_hpf2024 <- rbind(refined_traits_hpf2024, average_traits_long)
refined_traits_hpf2024<-as.data.frame(refined_traits_hpf2024)

wide_data <- refined_traits_hpf2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

hpfleaf <- c("Cirsium palustre", "Crataegus rhipidophylla", "Epilobium alsinifolium", "Epilobium tetragonum", 
             "Lathyrus aphaca", "Persicaria lapathifolia", "Picea rubens")

hpfplant <- c("Ajuga genevensis", "Alopecurus myosuroides", "Anthriscus caucalis", "Avena sativa", 
              "Crataegus rhipidophylla", "Digitaria sanguinalis", "Epilobium alsinifolium", "Epilobium tetragonum", 
              "Galium verrucosum", "Geranium dissectum", "Geranium palustre", "Hypericum humifusum", 
              "Lathyrus aphaca", "Lathyrus nissolia", "Lolium multiflorum", "Matricaria chamomilla", 
              "Persicaria lapathifolia", "Picea rubens", "Polygala serpyllifolia", "Rumex conglomeratus", 
              "Senecio sylvaticus", "Trifolium fragiferum", "Triticum aestivum", "Veronica serpyllifolia", 
              "Vicia lathyroides", "Vicia tetrasperma")

hpfseed <- c("Ajuga genevensis", "Galium verrucosum", "Geranium palustre", "Matricaria chamomilla", "Polygala serpyllifolia")


present <- hpfleaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- hpfplant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- hpfseed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = hpfleaf,
  present = present
)
present

results <- data.frame(
  species = hpfplant,
  present = present2
) 
present2

results <- data.frame(
  species = hpfseed,
  present = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% hpfleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)
filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hpfplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)
filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hpfseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))


refined_traits_hpf2024 <- rbind(refined_traits_hpf2024, average_traits_long)
refined_traits_hpf2024 <- rbind(refined_traits_hpf2024, average_traits_long2)
refined_traits_hpf2024 <- rbind(refined_traits_hpf2024, average_traits_long3)

# P. indica from try
p_i_leaf <- subset_try %>%
  filter(
    AccSpeciesName == "Potentilla indica" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE)) %>%
  pull(average_leaf)

p_i_seed <- subset_diaz %>%
  filter(grepl("Potentilla", Genus)) %>%
  summarise(mean_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE)) %>%
  pull(mean_seed_mass)

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  mutate(trait_value = as.numeric(trait_value))

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Potentilla indica" & trait_name == "leaf area" & is.na(trait_value) ~ 634.1638,
      scrubbed_species_binomial == "Potentilla indica" & trait_name == "seed mass" & is.na(trait_value) ~ 0.3487895,
      TRUE ~ trait_value
    )
  )

#Symphytum asperum
average_leaf_area_symphytum <- subset_diaz %>%
  filter(Genus == "Symphytum") %>%
  summarise(mean_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE)) %>%
  pull(mean_leaf_area)

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Symphytum asperum" & trait_name == "leaf area" & is.na(trait_value) ~ average_leaf_area_symphytum,
      TRUE ~ trait_value
    )
  )

average_leaf_area_lathyrus <- subset_diaz %>%
  filter(Genus == "Lathyrus") %>%
  summarise(mean_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE)) %>%
  pull(mean_leaf_area)

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Lathyrus aphaca" & trait_name == "leaf area" & is.na(trait_value) ~ average_leaf_area_lathyrus,
      TRUE ~ trait_value
    )
  )

average_diaspore_mass_galium <- subset_diaz %>%
  filter(Genus == "Galium") %>%
  summarise(mean_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE)) %>%
  pull(mean_diaspore_mass)

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Galium verrucosum" & trait_name == "seed mass" & is.na(trait_value) ~ average_diaspore_mass_galium,
      TRUE ~ trait_value
    )
  )

data_summary <- refined_traits_hpf2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_traits)

print(missing_data_summary) # all good

print(refined_traits_hpf2024)

lysimachia_genus_data <- subset_diaz %>%
  filter(Genus == "Lysimachia")

mean_traits_lysimachia_genus <- lysimachia_genus_data %>%
  summarise(
    avg_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE),
    avg_plant_height = mean(Plant.height..m., na.rm = TRUE),
    avg_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE)
  )

new_row_genus <- tibble(
  scrubbed_species_binomial = "Lysimachia arvensis",
  trait_name = c("leaf area", "maximum whole plant height", "seed mass"),
  trait_value = c(
    mean_traits_lysimachia_genus$avg_leaf_area,
    mean_traits_lysimachia_genus$avg_plant_height,
    mean_traits_lysimachia_genus$avg_seed_mass
  )
)

new_row_genus <- new_row_genus %>%
  mutate(trait_value = as.numeric(trait_value))

refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  bind_rows(new_row_genus)

refined_traits_hpf2024 <- as.data.frame(refined_traits_hpf2024)

write.csv(refined_traits_hpf2024, "functional_data_final/refined_traits_hpf2024.csv")

# Pivot wider
wide_refined_traits_hpf2024 <- refined_traits_hpf2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_hpf2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_hpf2024$scrubbed_species_binomial)

wide_refined_traits_hpf2024 <- wide_refined_traits_hpf2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_hpf2024_df <- as.data.frame(wide_refined_traits_hpf2024)
rownames(wide_refined_traits_hpf2024_df) <- wide_refined_traits_hpf2024_df$scrubbed_species_binomial
wide_refined_traits_hpf2024_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_hpf2024_df)

na_counts <- colSums(is.na(wide_refined_traits_hpf2024_df))
na_counts

wide_refined_traits_hpf2024_df <- na.omit(wide_refined_traits_hpf2024_df)
species_in_traits <- rownames(wide_refined_traits_hpf2024_df)
species_in_community <- colnames(betahpf2024_clean)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community 
common_species <- intersect(species_in_traits, species_in_community)

betahpf2024_clean_traits <- betahpf2024_clean[, common_species, drop = FALSE]

hpf.trait.comm.2024 <- as.matrix(betahpf2024_clean_traits)

dim(wide_refined_traits_hpf2024_df)
dim(hpf.trait.comm.2024)

species_in_traits <- rownames(wide_refined_traits_hpf2024_df)
species_in_community <- colnames(hpf.trait.comm.2024)
common_species <- intersect(species_in_traits, species_in_community)
wide_refined_traits_hpf2024_df <- wide_refined_traits_hpf2024_df[common_species, ]

hpf.trait.comm.2024 <- hpf.trait.comm.2024[, common_species]

dim(wide_refined_traits_hpf2024_df)
dim(hpf.trait.comm.2024)
community_abundance_sums <- rowSums(hpf.trait.comm.2024)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
hpf.trait.comm.2024 <- hpf.trait.comm.2024[!rownames(hpf.trait.comm.2024) %in% zero_abundance_communities, ]
wide_refined_traits_hpf2024_df <- wide_refined_traits_hpf2024_df[!rownames(wide_refined_traits_hpf2024_df) %in% missing_species, ]

trait_species <- rownames(wide_refined_traits_hpf2024_df)
community_species <- colnames(hpf.trait.comm.2024)

missing_species <- setdiff(trait_species, community_species)

zero_abundance_species <- community_species[colSums(hpf.trait.comm.2024) == 0]

missing_species
zero_abundance_species

wide_refined_traits_hpf2024_df <- wide_refined_traits_hpf2024_df[!rownames(wide_refined_traits_hpf2024_df) %in% zero_abundance_species, ]

wide_refined_traits_hpf2024_df <- wide_refined_traits_hpf2024_df[!rownames(wide_refined_traits_hpf2024_df) %in% zero_abundance_species, ]

hpf.trait.comm.2024 <- hpf.trait.comm.2024[, colSums(hpf.trait.comm.2024) > 0]

fd_results_hpf_2024<-dbFD(x = wide_refined_traits_hpf2024_df, a = hpf.trait.comm.2024)
fd_results_hpf_2024 <- as.data.frame(fd_results_hpf_2024)
saveRDS(fd_results_hpf_2024, "functional_data_final/fd_results_hpf_2024.RDS")
write.csv(wide_refined_traits_hpf2024_df, "functional_data_final/wide_refined_traits_hpf_2024.csv")

```

```{r Hepple traits and functional metrics}

hep2024.comm <- as.matrix(betahep2024_clean)
species_names_hep <- colnames(hep2024.comm)

formatted_species_list_hep <- gsub("_", " ", species_names_hep)

trait_data_hep2024 <- BIEN_trait_species(formatted_species_list_hep)
head(trait_data_hep2024)

concise_trait_data_hep2024 <- subset(trait_data_hep2024, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_hep2024 <- concise_trait_data_hep2024[order(concise_trait_data_hep2024$scrubbed_species_binomial), ]
head(concise_trait_data_hep2024)

concise_trait_data_hep2024 <- concise_trait_data_hep2024 %>% drop_na(trait_name)
concise_trait_data_hep2024 <- concise_trait_data_hep2024 %>% drop_na(trait_value)


get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_hep2024 %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_hep2024 %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarised_traits_hep2024 <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarised_traits_hep2024)

trait_counts <- summarised_traits_hep2024 %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

refined_traits_hep2024 <- summarised_traits_hep2024 %>%
 dplyr:: select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_hep, refined_traits_hep2024$scrubbed_species_binomial)
missing_species

hepmissing <- c("Crepis mollis"   ,
"Oxalis montana"   ,      "Persicaria amphibia" ,   "Pteridium aquilinum"   , "Rubus pruinosus"   ,    "Rumex thyrsoides Desf.")

present <- hepmissing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = hepmissing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hepmissing)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_hep2024 <- rbind(refined_traits_hep2024, average_traits_long)
refined_traits_hep2024<-as.data.frame(refined_traits_hep2024)

wide_data <- refined_traits_hep2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

hepleaf <- c(
  "Carex binervis",
  "Carex leporina",
  "Cirsium palustre",
  "Crataegus rhipidophylla",
  "Lolium pratense",
  "Phleum bertolonii",
  "Trifolium subterraneum"
)

hepplant <- c(
  "Achillea ptarmica",
  "Aira caryophyllea",
  "Carex binervis",
  "Carex hirta",
  "Carex hostiana",
  "Carex lepidocarpa",
  "Carex leporina",
  "Carex pulicaris",
  "Crataegus rhipidophylla",
  "Erica tetralix",
  "Geranium palustre",
  "Juncus acutiflorus",
  "Juncus conglomeratus",
  "Lolium pratense",
  "Luzula multiflora",
  "Phleum bertolonii",
  "Picea sitchensis",
  "Potentilla anglica",
  "Quercus petraea",
  "Ranunculus lanuginosus",
  "Ranunculus sardous",
  "Stellaria graminea",
  "Trifolium fragiferum"
)

hepseed <- c(
  "Carex hostiana",
  "Carex lepidocarpa",
  "Geranium palustre",
  "Holcus mollis",
  "Ranunculus lanuginosus",
  "Ranunculus sardous"
)


present <- hepleaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- hepplant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- hepseed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = hepleaf,
  present = present
)
present

results <- data.frame(
  species = hepplant,
  present2 = present2
)
present2

results <- data.frame(
  species = hepseed,
  present3 = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% hepleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hepplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)

filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% hepseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))


refined_traits_hep2024 <- rbind(refined_traits_hep2024, average_traits_long)
refined_traits_hep2024 <- rbind(refined_traits_hep2024, average_traits_long2)
refined_traits_hep2024 <- rbind(refined_traits_hep2024, average_traits_long3)

lolium_pratense_height <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(lolium_pratense_height)

lolium_pratense_leaf <- subset_try %>%
  filter(
    AccSpeciesName == "Lolium pratense" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

print(lolium_pratense_leaf)

lolium_pratense_height <- 0.7833333 
lolium_pratense_leaf <- 3490.177
  
refined_traits_hep2024 <- refined_traits_hep2024 %>%
  mutate(trait_value = as.numeric(trait_value))

carex_lepidocarpa_height <- subset_try %>%
  filter(
    AccSpeciesName == "Carex lepidocarpa" &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(carex_lepidocarpa_height)

carex_diaspore_mass <- subset_diaz %>%
  filter(Genus == "Carex") %>%
  mutate(Diaspore.mass..mg. = as.numeric(Diaspore.mass..mg.)) %>%
  summarise(average_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

print(carex_diaspore_mass)

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Lolium pratense"),
  trait_name = c("maximum whole plant height"),
  trait_value = 0.7833333
)

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Lolium pratense"),
  trait_name = c("leaf area"),
  trait_value = 3490.177
)

new_values4 <- data.frame(
  scrubbed_species_binomial = c("Carex lepidocarpa"),
  trait_name = c("maximum whole plant height"),
  trait_value = 0.58
)

new_values5 <- data.frame(
  scrubbed_species_binomial = c("Carex lepidocarpa"),
  trait_name = c("seed mass"),
  trait_value = 1.328293
)

refined_traits_hep2024 <- rbind(refined_traits_hep2024, new_values2)
refined_traits_hep2024 <- rbind(refined_traits_hep2024, new_values3)
refined_traits_hep2024 <- rbind(refined_traits_hep2024, new_values5)
refined_traits_hep2024 <- rbind(refined_traits_hep2024, new_values4)

data_summary <- refined_traits_hep2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_leaf_area = !leaf_area,
    missing_max_height = !max_height,
    missing_seed_mass = !seed_mass,
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_leaf_area, missing_max_height, missing_seed_mass, missing_traits)

print(missing_data_summary)

p_aq <- subset_try %>%
  filter(
    AccSpeciesName == "Pteridium aquilinum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Pteridium aquilinum" & trait_name == "leaf area" & is.na(trait_value) ~ 2044.367,
      TRUE ~ trait_value
    )
  )

rp_leaf <- subset_diaz %>%
  filter(Genus == "Rubus") %>%
  pull(Leaf.area..mm2.) %>%
  mean(na.rm = TRUE)

rp_seed <- subset_diaz %>%
  filter(Genus == "Rubus") %>%
  pull(Diaspore.mass..mg.) %>%
  mean(na.rm = TRUE)

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Rubus pruinosus" & is.na(trait_value) & trait_name == "leaf area" ~ rp_leaf,
      TRUE ~ trait_value
    )
  )

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Rubus pruinosus" & is.na(trait_value) & trait_name == "seed mass" ~ rp_seed,
      TRUE ~ trait_value
    )
  )

t_s_leaf <- subset_try %>%
  filter(
    AccSpeciesName == "Trifolium subterraneum" &
    TraitName == "Leaf area (in case of compound leaves undefined if leaf or leaflet, undefined if petiole is in- or excluded)") %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_leaf = mean(StdValue, na.rm = TRUE))

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  mutate(
    trait_value = case_when(
      scrubbed_species_binomial == "Trifolium subterraneum" & trait_name == "leaf area" & is.na(trait_value) ~ 316,
      TRUE ~ trait_value
    )
  )

# fill in all for O. montana and Rumex spp

plant_height_data <- subset_try %>%
  filter(SpeciesName == "Oxalis montana" & TraitName == "Plant height vegetative") %>%
  group_by(SpeciesName) %>%
  summarize(
    plant_height = mean(as.numeric(StdValue), na.rm = TRUE)
  ) %>%
  rename(scrubbed_species_binomial = SpeciesName) %>%
  mutate(trait_name = "maximum whole plant height") %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value = plant_height)

print(plant_height_data)

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  bind_rows(plant_height_data)

oxalis_leaf_area_avg <- subset_diaz %>%
  filter(Genus == "Oxalis") %>%
  summarize(
    average_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE)
  ) %>%
  mutate(scrubbed_species_binomial = "Oxalis montana", trait_name = "leaf area", trait_value = average_leaf_area) %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value)

oxalis_seed_mass_avg <- subset_diaz %>%
  filter(Genus == "Oxalis") %>%
  summarize(
    average_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE)
  ) %>%
  mutate(scrubbed_species_binomial = "Oxalis montana", trait_name = "seed mass", trait_value = average_seed_mass) %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value)

refined_traits_hep2024 <- refined_traits_hep2024 %>%
  bind_rows(oxalis_leaf_area_avg, oxalis_seed_mass_avg) %>%
  distinct(scrubbed_species_binomial, trait_name, .keep_all = TRUE)

# R. thyroides 
rumex_averages <- subset_diaz %>%
  filter(Genus == "Rumex") %>%
  summarize(
    average_leaf_area = mean(Leaf.area..mm2., na.rm = TRUE),
    average_plant_height = mean(Plant.height..m., na.rm = TRUE),
    average_seed_mass = mean(Diaspore.mass..mg., na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = starts_with("average"),
    names_to = "trait_name",
    values_to = "trait_value"
  ) %>%
  mutate(
    scrubbed_species_binomial = "Rumex thyrsoides Desf.",
    trait_name = case_when(
      trait_name == "average_leaf_area" ~ "leaf area",
      trait_name == "average_plant_height" ~ "maximum whole plant height",
      trait_name == "average_seed_mass" ~ "seed mass"
    )
  ) %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value)


refined_traits_hep2024 <- refined_traits_hep2024 %>%
  bind_rows(rumex_averages) %>%
  distinct(scrubbed_species_binomial, trait_name, .keep_all = TRUE)

data_summary <- refined_traits_hep2024 %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_leaf_area = !leaf_area,
    missing_max_height = !max_height,
    missing_seed_mass = !seed_mass,
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_leaf_area, missing_max_height, missing_seed_mass, missing_traits)

print(missing_data_summary)

refined_traits_hep2024 <- as.data.frame(refined_traits_hep2024)

duplicates <- refined_traits_hep2024 %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

write.csv(refined_traits_hep2024, "functional_data_final/refined_traits_hep2024.csv")

# Pivot wider
wide_refined_traits_hep2024 <- refined_traits_hep2024 %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_hep2024$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_hep2024$scrubbed_species_binomial)

wide_refined_traits_hep2024 <- wide_refined_traits_hep2024 %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_hep2024_df <- as.data.frame(wide_refined_traits_hep2024)
rownames(wide_refined_traits_hep2024_df) <- wide_refined_traits_hep2024_df$scrubbed_species_binomial
wide_refined_traits_hep2024_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_hep2024_df)

na_counts <- colSums(is.na(wide_refined_traits_hep2024_df))
na_counts

wide_refined_traits_hep2024_df <- na.omit(wide_refined_traits_hep2024_df)
species_in_traits <- rownames(wide_refined_traits_hep2024_df)
species_in_community <- colnames(betahep2024_clean)

common_species <- intersect(species_in_traits, species_in_community)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
betahep2024_clean_traits <- betahep2024_clean[, common_species, drop = FALSE]

hep.trait.comm.2024 <- as.matrix(betahep2024_clean_traits)

dim(wide_refined_traits_hep2024_df)
dim(hep.trait.comm.2024)

species_in_traits <- rownames(wide_refined_traits_hep2024_df)
species_in_community <- colnames(hep.trait.comm.2024)
common_species <- intersect(species_in_traits, species_in_community)

wide_refined_traits_hep2024_df <- wide_refined_traits_hep2024_df[common_species, ]

hep.trait.comm.2024 <- hep.trait.comm.2024[, common_species]

dim(wide_refined_traits_hep2024_df)
dim(hep.trait.comm.2024)

community_abundance_sums <- rowSums(hep.trait.comm.2024)
zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])
hep.trait.comm.2024 <- hep.trait.comm.2024[!rownames(hep.trait.comm.2024) %in% zero_abundance_communities, ]

trait_species <- rownames(wide_refined_traits_hep2024_df)
community_species <- colnames(hep.trait.comm.2024)

missing_species <- setdiff(trait_species, community_species)
zero_abundance_species <- community_species[colSums(hep.trait.comm.2024) == 0]

missing_species
zero_abundance_species

fd_results_hep_2024<-dbFD(x = wide_refined_traits_hep2024_df, a = hep.trait.comm.2024)
fd_results_hep_2024 <- as.data.frame(fd_results_hep_2024)
saveRDS(fd_results_hep_2024, "functional_data_final/fd_results_hep_2024.RDS")
write.csv(wide_refined_traits_hep2024_df, "functional_data_final/wide_refined_traits_hep_2024.csv")
```

```{r High fen traits and functional metrics}

high_fen.comm <- as.matrix(betahighfen2024_clean)
species_names_high_fen <- colnames(high_fen.comm)

formatted_species_list_high_fen <- gsub("_", " ", species_names_high_fen)

trait_data_high_fen <- BIEN_trait_species(formatted_species_list_high_fen)
head(trait_data_high_fen)

concise_trait_data_high_fen <- subset(trait_data_high_fen, select = c(scrubbed_species_binomial, trait_name, trait_value, unit, method, latitude, longitude, elevation_m))

concise_trait_data_high_fen <- concise_trait_data_high_fen[order(concise_trait_data_high_fen$scrubbed_species_binomial), ]
head(concise_trait_data_high_fen)

concise_trait_data_high_fen <- concise_trait_data_high_fen %>% drop_na(trait_name)
concise_trait_data_high_fen <- concise_trait_data_high_fen %>% drop_na(trait_value)

get_mode <- function(v) {
  uniq_v <- unique(v)
  uniq_v[which.max(tabulate(match(v, uniq_v)))]
}

numeric_traits <- concise_trait_data_high_fen %>%
  filter(!is.na(as.numeric(trait_value)))

character_traits <- concise_trait_data_high_fen %>%
  filter(is.na(as.numeric(trait_value)))

numeric_traits <- numeric_traits %>%
  mutate(trait_value = as.numeric(trait_value))

summarized_numeric_traits <- numeric_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mean_trait_value = mean(trait_value, na.rm = TRUE), .groups = 'drop')

summarized_character_traits <- character_traits %>%
  group_by(scrubbed_species_binomial, trait_name, unit) %>%
  summarize(mode_trait_value = get_mode(trait_value), .groups = 'drop')

summarized_numeric_traits <- summarized_numeric_traits %>%
  mutate(mean_trait_value = as.character(mean_trait_value))

summarised_traits_high_fen <- bind_rows(
  summarized_numeric_traits %>%
    rename(trait_value = mean_trait_value),
  summarized_character_traits %>%
    rename(trait_value = mode_trait_value)
)

head(summarised_traits_high_fen)

trait_counts <- summarised_traits_high_fen %>%
  group_by(trait_name) %>%
  summarize(count = n())

print(trait_counts)

refined_traits_high_fen <- summarised_traits_high_fen %>%
  dplyr::select(scrubbed_species_binomial, trait_name, trait_value) %>%
  filter(trait_name %in% c("seed mass", "leaf area", "maximum whole plant height"))

missing_species <- setdiff(formatted_species_list_high_fen, refined_traits_high_fen$scrubbed_species_binomial)
missing_species

# exclude ones that are or / uncertainties and change to genus level to match diaz
fenmissing <- c("Borago pygmaea"  , "Persicaria minor")

present <- fenmissing %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = fenmissing,
  present = present
) 

filtered_diaz <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% fenmissing)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

print(average_traits)

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

refined_traits_high_fen <- rbind(refined_traits_high_fen, average_traits_long)
refined_traits_high_fen<-as.data.frame(refined_traits_high_fen)

wide_data <- refined_traits_high_fen %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

missing_data <- wide_data %>%
  mutate(across(-scrubbed_species_binomial, ~ is.na(.x))) %>%
  pivot_longer(-scrubbed_species_binomial, names_to = "trait_name", values_to = "is_missing") %>%
  filter(is_missing) %>%
  group_by(trait_name) %>%
  summarise(missing_species = list(scrubbed_species_binomial), .groups = 'drop')

for (trait in unique(missing_data$trait_name)) {
  cat("\nTrait:", trait, "\n")
  missing_species <- missing_data %>%
    filter(trait_name == trait) %>%
    pull(missing_species) %>%
    unlist()
  
  cat("Missing species:\n")
  print(missing_species)
}

fenleaf <- c("Taraxacum campylodes")

fenplant <- c("Bromus secalinus"     ,  "Calamagrostis epigejos" ,"Geranium pusillum"   ,   "Juncus inflexus" ,       "Potentilla reptans"  ,   "Taraxacum campylodes"  )

fenseed <- c("Geranium pusillum")

present <- fenleaf %in% subset_diaz$Species.name.standardized.against.TPL
present2 <- fenplant %in% subset_diaz$Species.name.standardized.against.TPL
present3 <- fenseed %in% subset_diaz$Species.name.standardized.against.TPL

results <- data.frame(
  species = fenleaf,
  present = present
) 
present

results <- data.frame(
  species = fenplant,
  present2 = present2
) 
present2

results <- data.frame(
  species = fenseed,
  present3 = present3
) 
present3

filtered_diaz <- subset_diaz %>%
  filter(Species.name.standardized.against.TPL %in% fenleaf) %>%
  dplyr::select(Species.name.standardized.against.TPL, Leaf.area..mm2.)

filtered_diaz2 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% fenplant)%>%
  dplyr::select(Species.name.standardized.against.TPL, Plant.height..m.)

filtered_diaz3 <- subset_diaz %>% filter(Species.name.standardized.against.TPL %in% fenseed)%>%
  dplyr::select(Species.name.standardized.against.TPL, Diaspore.mass..mg.)

average_traits <- filtered_diaz %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits2 <- filtered_diaz2 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits3 <- filtered_diaz3 %>%
  group_by(Species.name.standardized.against.TPL) %>%
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}"))

average_traits <- average_traits %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits2 <- average_traits2 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)
average_traits3 <- average_traits3 %>%
  rename(scrubbed_species_binomial = Species.name.standardized.against.TPL)

average_traits_long <- average_traits %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long2 <- average_traits2 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long3 <- average_traits3 %>%
  pivot_longer(cols = starts_with("avg_"),
               names_to = "trait_name",
               values_to = "trait_value") %>%
  mutate(trait_name = str_replace(trait_name, "avg_", ""))

average_traits_long <- average_traits_long %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long2 <- average_traits_long2 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))

average_traits_long3 <- average_traits_long3 %>%
  mutate(trait_name = case_when(
    trait_name %in% c("Leaf.area..mm2.") ~ "leaf area",
    trait_name %in% c("Plant.height..m.") ~ "maximum whole plant height",
    trait_name %in% c("Diaspore.mass..mg.") ~ "seed mass",
    TRUE ~ trait_name
  ))


refined_traits_high_fen <- rbind(refined_traits_high_fen, average_traits_long)
refined_traits_high_fen <- rbind(refined_traits_high_fen, average_traits_long2)
refined_traits_high_fen <- rbind(refined_traits_high_fen, average_traits_long3)

# b. pygmaea
bp_height <- subset_try %>%
  filter(
    str_starts(AccSpeciesName, "Borago") &
    TraitName == "Plant height vegetative" &
    ValueKindName == "Maximum"
  ) %>%
  mutate(StdValue = as.numeric(StdValue)) %>%
  summarise(average_height = mean(StdValue, na.rm = TRUE))

print(bp_height)

# leaf and seed
bp_seed <- subset_diaz %>%
  filter(Genus == "Borago") %>%
  mutate(Diaspore.mass..mg. = as.numeric(Diaspore.mass..mg.)) %>%
  summarise(average_diaspore_mass = mean(Diaspore.mass..mg., na.rm = TRUE))

print(bp_seed)

bp_leaf <- subset_diaz %>%
  filter(Genus == "Borago") %>%
  mutate(Leaf.area..mm2. = as.numeric(Leaf.area..mm2.)) %>%
  summarise(avg_leaf = mean(Leaf.area..mm2., na.rm = TRUE))

print(bp_leaf)

refined_traits_high_fen <- refined_traits_high_fen %>%
  mutate(trait_value = as.numeric(trait_value))

new_values2 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("maximum whole plant height"),
  trait_value = 0.525
)

new_values3 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("leaf area"),
  trait_value = 3857.29
)

new_values4 <- data.frame(
  scrubbed_species_binomial = c("Borago pygmaea"),
  trait_name = c("seed mass"),
  trait_value = 16.304
)


refined_traits_high_fen <- rbind(refined_traits_high_fen, new_values2)
refined_traits_high_fen <- rbind(refined_traits_high_fen, new_values3)
refined_traits_high_fen <- rbind(refined_traits_high_fen, new_values4)


data_summary <- refined_traits_high_fen %>%
  group_by(scrubbed_species_binomial) %>%
  summarize(
    leaf_area = any(trait_name == "leaf area" & !is.na(trait_value)),
    max_height = any(trait_name == "maximum whole plant height" & !is.na(trait_value)),
    seed_mass = any(trait_name == "seed mass" & !is.na(trait_value)),
    .groups = 'drop'
  )

missing_data_summary <- data_summary %>%
  mutate(
    missing_leaf_area = !leaf_area,
    missing_max_height = !max_height,
    missing_seed_mass = !seed_mass,
    missing_traits = 3 - (leaf_area + max_height + seed_mass),
    missing = missing_traits > 0
  ) %>%
  filter(missing) %>%
  dplyr::select(scrubbed_species_binomial, missing_leaf_area, missing_max_height, missing_seed_mass, missing_traits)

print(missing_data_summary)

refined_traits_high_fen <- as.data.frame(refined_traits_high_fen)

duplicates <- refined_traits_high_fen %>%
  group_by(scrubbed_species_binomial, trait_name) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1)

print(duplicates)

write.csv(refined_traits_high_fen, "functional_data_final/refined_traits_high_fen.csv")

wide_refined_traits_high_fen <- refined_traits_high_fen %>%
  pivot_wider(names_from = trait_name, values_from = trait_value)

wide_refined_traits_high_fen$scrubbed_species_binomial <- gsub(" ", "_", wide_refined_traits_high_fen$scrubbed_species_binomial)

wide_refined_traits_high_fen <- wide_refined_traits_high_fen %>%
  mutate(across(-scrubbed_species_binomial, as.numeric))

wide_refined_traits_high_fen_df <- as.data.frame(wide_refined_traits_high_fen)
rownames(wide_refined_traits_high_fen_df) <- wide_refined_traits_high_fen_df$scrubbed_species_binomial
wide_refined_traits_high_fen_df$scrubbed_species_binomial <- NULL

head(wide_refined_traits_high_fen_df)

na_counts <- colSums(is.na(wide_refined_traits_high_fen_df))
na_counts

wide_refined_traits_high_fen_df <- na.omit(wide_refined_traits_high_fen_df)
species_in_traits <- rownames(wide_refined_traits_high_fen_df)
species_in_community <- colnames(betahighfen2024_clean)
uncommon_species_traits <- setdiff(species_in_traits, species_in_community)
uncommon_species_traits
uncommon_species_community <- setdiff(species_in_community, species_in_traits)
uncommon_species_community
common_species <- intersect(species_in_traits, species_in_community)
betahigh_fen_clean_traits <- betahighfen2024_clean[, common_species, drop = FALSE]

high_fen.trait.comm <- as.matrix(betahigh_fen_clean_traits)

dim(wide_refined_traits_high_fen_df)
dim(high_fen.trait.comm)

community_abundance_sums <- rowSums(high_fen.trait.comm)

zero_abundance_communities <- names(community_abundance_sums[community_abundance_sums == 0])

high_fen.trait.comm <- high_fen.trait.comm[!rownames(high_fen.trait.comm) %in% zero_abundance_communities, ]

trait_species <- rownames(wide_refined_traits_high_fen_df)
community_species <- colnames(high_fen.trait.comm)

missing_species <- setdiff(trait_species, community_species)
zero_abundance_species <- community_species[colSums(high_fen.trait.comm) == 0]

missing_species
zero_abundance_species

fd_results_high_fen <- dbFD(x = wide_refined_traits_high_fen_df, a = high_fen.trait.comm)
fd_results_high_fen <- as.data.frame(fd_results_high_fen)
saveRDS(fd_results_high_fen, "functional_data_final/fd_results_high_fen.RDS")
write.csv(wide_refined_traits_high_fen_df, "functional_data_final/wide_refined_traits_high_fen.csv")
```

```{r Load functional metric data}

fd_results_knepp <- readRDS("functional_data_final/fd_results_knepp.RDS")
wide_refined_traits_knepp <- read.csv("functional_data_final/wide_refined_traits_knepp_df.csv", row.names = 1)
refined_traits_knepp <- read.csv("functional_data_final/refined_traits_knepp.csv")

refined_traits_knepp_M <- read.csv("functional_data_final/refined_traits_knepp_M.csv")
fd_results_knepp_M <- readRDS("functional_data_final/fd_results_knepp_M.RDS")
wide_refined_traits_knepp_M <- read.csv("functional_data_final/wide_refined_traits_knepp_M.csv",row.names=1)

refined_traits_knepp_N <- read.csv("functional_data_final/refined_traits_knepp_N.csv")
fd_results_knepp_N <- readRDS("functional_data_final/fd_results_knepp_N.RDS")
wide_refined_traits_knepp_N <- read.csv("functional_data_final/wide_refined_traits_knepp_N.csv",row.names=1)

refined_traits_knepp_S <- read.csv("functional_data_final/refined_traits_knepp_S.csv")
fd_results_knepp_S <- readRDS("functional_data_final/fd_results_knepp_S.RDS")
wide_refined_traits_knepp_S <- read.csv("functional_data_final/wide_refined_traits_knepp_S.csv",row.names=1)

# 2023
fd_results_knepp2023 <- readRDS("functional_data_final/fd_results_knepp2023.RDS")
wide_refined_traits_knepp2023 <- read.csv("functional_data_final/wide_refined_traits_knepp2023.csv", row.names = 1)
refined_traits_knepp2023 <- read.csv("functional_data_final/refined_traits_knepp2023.csv")

refined_traits_knepp_M2023 <- read.csv("functional_data_final/refined_traits_knepp_M2023.csv")
fd_results_knepp_M2023 <- readRDS("functional_data_final/fd_results_knepp_M2023.RDS")
wide_refined_traits_knepp_M2023 <- read.csv("functional_data_final/wide_refined_traits_knepp_M2023.csv",row.names=1)

refined_traits_knepp_N2023 <- read.csv("functional_data_final/refined_traits_knepp_N2023.csv")
fd_results_knepp_N2023 <- readRDS("functional_data_final/fd_results_knepp_N2023.RDS")
wide_refined_traits_knepp_N2023 <- read.csv("functional_data_final/wide_refined_traits_knepp_N2023.csv",row.names=1)

refined_traits_knepp_S2023 <- read.csv("functional_data_final/refined_traits_knepp_S2023.csv")
fd_results_knepp_S2023 <- readRDS("functional_data_final/fd_results_knepp_S2023.RDS")
wide_refined_traits_knepp_S2023 <- read.csv("functional_data_final/wide_refined_traits_knepp_S2023.csv",row.names=1)


# 2024
fd_results_knepp2024 <- readRDS("functional_data_final/fd_results_knepp2024.RDS")
wide_refined_traits_knepp2024 <- read.csv("functional_data_final/wide_refined_traits_knepp2024.csv", row.names = 1)
refined_traits_knepp2024 <- read.csv("functional_data_final/refined_traits_knepp2024.csv")

refined_traits_knepp_M2024 <- read.csv("functional_data_final/refined_traits_knepp_M2024.csv")
fd_results_knepp_M2024 <- readRDS("functional_data_final/fd_results_knepp_M2024.RDS")
wide_refined_traits_knepp_M2024 <- read.csv("functional_data_final/wide_refined_traits_knepp_M2024.csv",row.names=1)

refined_traits_knepp_N2024 <- read.csv("functional_data_final/refined_traits_knepp_N2024.csv")
fd_results_knepp_N2024 <- readRDS("functional_data_final/fd_results_knepp_N2024.RDS")
wide_refined_traits_knepp_N2024 <- read.csv("functional_data_final/wide_refined_traits_knepp_N2024.csv",row.names=1)

refined_traits_knepp_S2024 <- read.csv("functional_data_final/refined_traits_knepp_S2024.csv")
fd_results_knepp_S2024 <- readRDS("functional_data_final/fd_results_knepp_S2024.RDS")
wide_refined_traits_knepp_S2024 <- read.csv("functional_data_final/wide_refined_traits_knepp_S2024.csv",row.names=1)

refined_traits_boothby <- read.csv("functional_data_final/refined_traits_boothby.csv")
fd_results_boothby <- readRDS("functional_data_final/fd_results_boothby.RDS")
wide_refined_traits_boothby <- read.csv("functional_data_final/wide_refined_traits_boothby.csv", row.names = 1)

refined_traits_boothby2023 <- read.csv("functional_data_final/refined_traits_boothby2023.csv")
fd_results_boothby2023 <- readRDS("functional_data_final/fd_results_boothby2023.RDS")
wide_refined_traits_boothby2023 <- read.csv("functional_data_final/wide_refined_traits_boothby2023.csv", row.names = 1)

refined_traits_boothby2024 <- read.csv("functional_data_final/refined_traits_boothby2024.csv")
fd_results_boothby2024 <- readRDS("functional_data_final/fd_results_boothby2024.RDS")
wide_refined_traits_boothby2024 <- read.csv("functional_data_final/wide_refined_traits_boothby2024.csv", row.names = 1)

refined_traits_br <- read.csv("functional_data_final/refined_traits_br.csv")
fd_results_br <- readRDS("functional_data_final/fd_results_br.RDS")
wide_refined_traits_br <- read.csv("functional_data_final/wide_refined_traits_br.csv", row.names = 1)

refined_traits_silwood2021 <- read.csv("functional_data_final/refined_traits_silwood.csv")
fd_results_silwood_2021 <- readRDS("functional_data_final/fd_results_silwood_2021.RDS")
wide_refined_traits_silwood_2021 <- read.csv("functional_data_final/wide_refined_traits_silwood_2021.csv", row.names = 1)

refined_traits_silwood2022 <- read.csv("functional_data_final/refined_traits_silwood2022.csv")
fd_results_silwood_2022 <- readRDS("functional_data_final/fd_results_silwood_2022.RDS")
wide_refined_traits_silwood_2022 <- read.csv("functional_data_final/wide_refined_traits_silwood_2022.csv", row.names = 1)

refined_traits_silwood2023 <- read.csv("functional_data_final/refined_traits_silwood2023.csv")
fd_results_silwood_2023 <- readRDS("functional_data_final/fd_results_silwood_2023.RDS")
wide_refined_traits_silwood_2023 <- read.csv("functional_data_final/wide_refined_traits_silwood_2023.csv", row.names = 1)

refined_traits_hpf2024 <- read.csv("functional_data_final/refined_traits_hpf2024.csv")
fd_results_hpf2024 <- readRDS("functional_data_final/fd_results_hpf_2024.RDS")
wide_refined_traits_hpf_2024 <- read.csv("functional_data_final/wide_refined_traits_hpf_2024.csv", row.names = 1)

refined_traits_hep2024 <- read.csv("functional_data_final/refined_traits_hep2024.csv")
fd_results_hep_2024 <- readRDS("functional_data_final/fd_results_hep_2024.RDS")
wide_refined_traits_hep_2024 <- read.csv("functional_data_final/wide_refined_traits_hep_2024.csv", row.names = 1)

refined_traits_high_fen <- read.csv("functional_data_final/refined_traits_high_fen.csv")
fd_results_high_fen <- readRDS("functional_data_final/fd_results_high_fen.RDS")
wide_refined_traits_high_fen <- read.csv("functional_data_final/wide_refined_traits_high_fen.csv", row.names = 1)
```

```{r Functional diversity of Knepp and Boothby}

# create the data frame
fd_knepp <- data.frame(
  Community = rownames(fd_results_knepp),
  FRic = fd_results_knepp$FRic,
  FEve = fd_results_knepp$FEve,
  FDiv = fd_results_knepp$FDiv,
  FDis = fd_results_knepp$FDis, 
  RaoQ = fd_results_knepp$RaoQ,
  CWM.leaf.area=fd_results_knepp$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_knepp$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_knepp$CWM.seed.mass,
  Source = "Knepp 2022"
)

fd_knepp2023 <- data.frame(
  Community = rownames(fd_results_knepp2023),
  FRic = fd_results_knepp2023$FRic,
  FEve = fd_results_knepp2023$FEve,
  FDiv = fd_results_knepp2023$FDiv,
  FDis = fd_results_knepp2023$FDis, 
  RaoQ = fd_results_knepp2023$RaoQ,
  CWM.leaf.area=fd_results_knepp2023$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_knepp2023$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_knepp2023$CWM.seed.mass,
  Source = "Knepp 2023"
)

fd_knepp2024 <- data.frame(
  Community = rownames(fd_results_knepp2024),
  FRic = fd_results_knepp2024$FRic,
  FEve = fd_results_knepp2024$FEve,
  FDiv = fd_results_knepp2024$FDiv,
  FDis = fd_results_knepp2024$FDis, 
  RaoQ = fd_results_knepp2024$RaoQ,
  CWM.leaf.area=fd_results_knepp2024$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_knepp2024$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_knepp2024$CWM.seed.mass,
  Source = "Knepp 2024"
)

fd_boothby<- data.frame(
  Community = rownames(fd_results_boothby),
  FRic = fd_results_boothby$FRic,
  FEve = fd_results_boothby$FEve,
  FDiv = fd_results_boothby$FDiv,
  FDis = fd_results_boothby$FDis, 
  RaoQ = fd_results_boothby$RaoQ,
  CWM.leaf.area=fd_results_boothby$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_boothby$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_boothby$CWM.seed.mass,
  Source = "Boothby 2022"
)

fd_boothby2023<- data.frame(
  Community = rownames(fd_results_boothby2023),
  FRic = fd_results_boothby2023$FRic,
  FEve = fd_results_boothby2023$FEve,
  FDiv = fd_results_boothby2023$FDiv,
  FDis = fd_results_boothby2023$FDis, 
  RaoQ = fd_results_boothby2023$RaoQ,
  CWM.leaf.area=fd_results_boothby2023$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_boothby2023$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_boothby2023$CWM.seed.mass,
  Source = "Boothby 2023"
)

fd_boothby2024<- data.frame(
  Community = rownames(fd_results_boothby2024),
  FRic = fd_results_boothby2024$FRic,
  FEve = fd_results_boothby2024$FEve,
  FDiv = fd_results_boothby2024$FDiv,
  FDis = fd_results_boothby2024$FDis, 
  RaoQ = fd_results_boothby2024$RaoQ,
  CWM.leaf.area=fd_results_boothby2024$CWM.leaf.area,
  CWM.maximum.whole.plant.height=fd_results_boothby2024$CWM.maximum.whole.plant.height,
  CWM.seed.mass=fd_results_boothby2024$CWM.seed.mass,
  Source = "Boothby 2024"
)

# combine the data frames
fd_combined <- rbind(fd_knepp,fd_knepp2023, fd_knepp2024, fd_boothby, fd_boothby2023, fd_boothby2024)

# with sites as row names
fd_knepp_boothby <- rbind(fd_knepp,fd_knepp2023, fd_knepp2024, fd_boothby, fd_boothby2023, fd_boothby2024)

## BARPLOTS OF COMPARISONS 

# Plot FRic comparison
p1 <- ggplot(fd_combined, aes(x = Community, y = FRic, fill = Source)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Functional Richness (FRic) Comparison", x = "Community", y = "FRic") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Plot FEve comparison
p2 <- ggplot(fd_combined, aes(x = Community, y = FEve, fill = Source)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Functional Evenness (FEve) Comparison", x = "Community", y = "FEve") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Plot FDiv comparison
p3 <- ggplot(fd_combined, aes(x = Community, y = FDiv, fill = Source)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Functional Divergence (FDiv) Comparison", x = "Community", y = "FDiv") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Print the plots
print(p1)
print(p2)
print(p3)

wide_refined_traits_boothby$site <- "Boothby 2022"
wide_refined_traits_boothby2023$site <- "Boothby 2023"
wide_refined_traits_boothby2024$site <- "Boothby 2024"

wide_refined_traits_knepp$site <- "Knepp 2022"
wide_refined_traits_knepp2023$site <- "Knepp 2023"
wide_refined_traits_knepp2024$site <- "Knepp 2024"

combined_trait_data <- bind_rows(wide_refined_traits_boothby,wide_refined_traits_boothby2023,wide_refined_traits_boothby2024,wide_refined_traits_knepp, wide_refined_traits_knepp2023, wide_refined_traits_knepp2024)
combined_trait_data_std<-as.data.frame(combined_trait_data)


# knepp and boothby, knepp by block
wide_refined_traits_knepp_M <- wide_refined_traits_knepp_M %>%
  mutate(site = "Knepp 2022")
wide_refined_traits_knepp_M <- wide_refined_traits_knepp_M %>%
  mutate(block = "M 2022")
wide_refined_traits_knepp_N <- wide_refined_traits_knepp_N %>%
  mutate(site = "Knepp 2022")
wide_refined_traits_knepp_N <- wide_refined_traits_knepp_N %>%
  mutate(block = "N 2022")
wide_refined_traits_knepp_S <- wide_refined_traits_knepp_S %>%
  mutate(site = "Knepp 2022")
wide_refined_traits_knepp_S <- wide_refined_traits_knepp_S %>%
  mutate(block = "S 2022")

wide_refined_traits_knepp_M2023 <- wide_refined_traits_knepp_M2023 %>%
  mutate(site = "Knepp 2023")
wide_refined_traits_knepp_M2023 <- wide_refined_traits_knepp_M2023 %>%
  mutate(block = "M 2023")
wide_refined_traits_knepp_N2023 <- wide_refined_traits_knepp_N2023 %>%
  mutate(site = "Knepp 2023")
wide_refined_traits_knepp_N2023 <- wide_refined_traits_knepp_N2023 %>%
  mutate(block = "N 2023")
wide_refined_traits_knepp_S2023 <- wide_refined_traits_knepp_S2023 %>%
  mutate(site = "Knepp 2023")
wide_refined_traits_knepp_S2023 <- wide_refined_traits_knepp_S2023 %>%
  mutate(block = "S 2023")

wide_refined_traits_knepp_M2024 <- wide_refined_traits_knepp_M2024 %>%
  mutate(site = "Knepp 2024")
wide_refined_traits_knepp_M2024 <- wide_refined_traits_knepp_M2024 %>%
  mutate(block = "M 2024")
wide_refined_traits_knepp_N2024 <- wide_refined_traits_knepp_N2024 %>%
  mutate(site = "Knepp 2024")
wide_refined_traits_knepp_N2024 <- wide_refined_traits_knepp_N2024 %>%
  mutate(block = "N 2024")
wide_refined_traits_knepp_S2024 <- wide_refined_traits_knepp_S2024 %>%
  mutate(site = "Knepp 2024")
wide_refined_traits_knepp_S2024 <- wide_refined_traits_knepp_S2024 %>%
  mutate(block = "S 2024")

# Add site column to Boothby
wide_refined_traits_boothby <- wide_refined_traits_boothby %>%
  mutate(site = "Boothby 2022")
wide_refined_traits_boothby <- wide_refined_traits_boothby %>%
  mutate(block = NA)

wide_refined_traits_boothby2023 <- wide_refined_traits_boothby2023 %>%
  mutate(site = "Boothby 2023")
wide_refined_traits_boothby2023 <- wide_refined_traits_boothby2023 %>%
  mutate(block = NA)

wide_refined_traits_boothby2024 <- wide_refined_traits_boothby2024 %>%
  mutate(site = "Boothby 2024")
wide_refined_traits_boothby2024 <- wide_refined_traits_boothby2024 %>%
  mutate(block = NA)

# merge all datasets into one
b_k_block_trait <- bind_rows(wide_refined_traits_knepp_M, wide_refined_traits_knepp_M2023, wide_refined_traits_knepp_M2024,
                                 wide_refined_traits_knepp_N,wide_refined_traits_knepp_N2023,wide_refined_traits_knepp_N2024,
                                 wide_refined_traits_knepp_S, wide_refined_traits_knepp_S2023,wide_refined_traits_knepp_S2024,
                                 wide_refined_traits_boothby,wide_refined_traits_boothby2023,wide_refined_traits_boothby2024)

b_k_block_trait <- b_k_block_trait %>%
  mutate(age = case_when(
    site == "Boothby 2022" ~ 0,site == "Boothby 2023" ~ 1,site == "Boothby 2024" ~ 2,
    block %in% c("M 2022", "N 2022") ~ 18,
    block == "S 2022" ~ 21,
    block %in% c("M 2023", "N 2023") ~ 19,
    block == "S 2023" ~ 22,
    block %in% c("M 2024", "N 2024") ~ 20,
    block == "S 2024" ~ 23,
    TRUE ~ NA_real_  
  ))

b_k_block_trait$age <- as.character(b_k_block_trait$age)

head(b_k_block_trait)

## knepp alone by block
combined_knepp_traits <- bind_rows(
  wide_refined_traits_knepp_M,
  wide_refined_traits_knepp_S,
  wide_refined_traits_knepp_N
)

combined_knepp_traits <- combined_knepp_traits %>%
  mutate(age = case_when(
    block %in% c("M", "N") ~ 18,
    block == "S" ~ 21,
    TRUE ~ NA_real_  
  ))

combined_knepp_traits$age <- as.character(combined_knepp_traits$age)
```

```{r Functional traits of Knepp and Boothby}

fd_results_knepp_M <- as.data.frame(fd_results_knepp_M)
fd_results_knepp_N <- as.data.frame(fd_results_knepp_N)
fd_results_knepp_S <- as.data.frame(fd_results_knepp_S)

# combine M, S, N
combined_fd_knepp_block <- bind_rows(
  fd_results_knepp_M %>% mutate(Block = "M"),
  fd_results_knepp_N %>% mutate(Block = "N"),
  fd_results_knepp_S %>% mutate(Block = "S")
)


combined_fd_knepp_block <- combined_fd_knepp_block %>%
  mutate(age = case_when(
    Block %in% c("M", "N") ~ 18,
    Block == "S" ~ 21,
    TRUE ~ NA_real_  
  ))

combined_fd_knepp_block$age <- as.character(combined_fd_knepp_block$age)
combined_fd_knepp_block$site <- "Knepp"

# split the data by block
blocks <- unique(combined_fd_knepp_block$Block)

## ADD BOOTHBY

str(fd_results_boothby)

# Prepare the Boothby dataset
fd_results_boothby <- fd_results_boothby %>%
  mutate(
    site = "Boothby",
    age = 0,
    Block = NA_character_
  )

fd_results_boothby$age <- as.character(fd_results_boothby$age)

# combine Knepp and Boothby datasets
kneppblock_boothby_fd <- bind_rows(combined_fd_knepp_block, fd_results_boothby)

#  block as a factor and handle NA values in block for Boothby
kneppblock_boothby_fd$Block <- factor(kneppblock_boothby_fd$Block, exclude = NULL)
levels(kneppblock_boothby_fd$Block)[is.na(levels(kneppblock_boothby_fd$Block))] <- "Boothby"


# TRAITS
wide_refined_traits_knepp_M$site <- "Knepp"
wide_refined_traits_knepp_N$site <- "Knepp"
wide_refined_traits_knepp_S$site <- "Knepp"
wide_refined_traits_knepp_M$block <- "M"
wide_refined_traits_knepp_N$block <- "N"
wide_refined_traits_knepp_S$block <- "S"
wide_refined_traits_boothby$block <- "NA"

combined_trait_data_block <- bind_rows(wide_refined_traits_boothby, wide_refined_traits_knepp_M, wide_refined_traits_knepp_N, wide_refined_traits_knepp_S)

combined_trait_data_block<-as.data.frame(combined_trait_data_block)
```

```{r Functional, taxonomic and phylogenetic dataframes}

# format so all the same
fd_results_br$site <- "Budworth"
fd_results_br$block <-"NA"
fd_results_br$year <- "2021"
fd_results_br$plot <- rownames(fd_results_br)
rownames(fd_results_br) <- NULL

fd_results_silwood_2021$site <- "Silwood"
fd_results_silwood_2021$year <- "2021"
fd_results_silwood_2021$block <-"NA"
fd_results_silwood_2021$plot <- rownames(fd_results_silwood_2021)
rownames(fd_results_silwood_2021) <- NULL

row.names(fd_results_silwood_2022)[row.names(fd_results_silwood_2022) == ""] <- "0"
fd_results_silwood_2022$site <- "Silwood"
fd_results_silwood_2022$year <- "2022"
fd_results_silwood_2022$block <-"NA"
fd_results_silwood_2022$plot <- rownames(fd_results_silwood_2022)
rownames(fd_results_silwood_2022) <- NULL

fd_results_silwood_2023$site <- "Silwood"
fd_results_silwood_2023$year <- "2023"
fd_results_silwood_2023$block <-"NA"
fd_results_silwood_2023$plot <- rownames(fd_results_silwood_2023)
rownames(fd_results_silwood_2023) <- NULL

fd_results_hep_2024$site <- "Hepple"
fd_results_hep_2024$year <- "2024"
blocks <- gsub("[0-9]", "", rownames(fd_results_hep_2024))
plots <- gsub("[^0-9]", "", rownames(fd_results_hep_2024))
fd_results_hep_2024$block <- blocks
fd_results_hep_2024$plot <- plots
rownames(fd_results_hep_2024) <- NULL

fd_results_hpf2024$site <- "HPF"
fd_results_hpf2024$year <- "2024"
blocks <- character(length(rownames(fd_results_hpf2024)))
plots <- character(length(rownames(fd_results_hpf2024)))

for (i in seq_along(rownames(fd_results_hpf2024))) {
  if (grepl("^South", rownames(fd_results_hpf2024)[i])) {
    blocks[i] <- "South"
    plots[i] <- gsub("^South", "", rownames(fd_results_hpf2024)[i])
  } else if (grepl("^2020F", rownames(fd_results_hpf2024)[i])) {
    blocks[i] <- "2020F"
    plots[i] <- gsub("^2020F", "", rownames(fd_results_hpf2024)[i])
  }
}

fd_results_hpf2024$block <- blocks
fd_results_hpf2024$plot <- plots
rownames(fd_results_hpf2024) <- NULL

fd_results_boothby$site <-"Boothby"
fd_results_boothby$year <-"2022"
blocks <- gsub("[0-9]", "", rownames(fd_results_boothby))
plots <- gsub("[^0-9]", "", rownames(fd_results_boothby))
fd_results_boothby$block <- blocks
fd_results_boothby$plot <- plots
rownames(fd_results_boothby) <- NULL

fd_results_boothby2023$site <-"Boothby"
fd_results_boothby2023$year <-"2023"
blocks <- gsub("[0-9]", "", rownames(fd_results_boothby2023))
plots <- gsub("[^0-9]", "", rownames(fd_results_boothby2023))
fd_results_boothby2023$block <- blocks
fd_results_boothby2023$plot <- plots
rownames(fd_results_boothby2023) <- NULL

fd_results_boothby2024$site <-"Boothby"
fd_results_boothby2024$year <-"2024"
blocks <- gsub("[0-9]", "", rownames(fd_results_boothby2024))
plots <- gsub("[^0-9]", "", rownames(fd_results_boothby2024))
fd_results_boothby2024$block <- blocks
fd_results_boothby2024$plot <- plots
rownames(fd_results_boothby2024) <- NULL

fd_results_knepp_M$site <-"Knepp"
fd_results_knepp_M$year <-"2022"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_M))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_M))
fd_results_knepp_M$block <- blocks
fd_results_knepp_M$plot <- plots
rownames(fd_results_knepp_M) <- NULL

fd_results_knepp_N$site <-"Knepp"
fd_results_knepp_N$block <-"N"
fd_results_knepp_N$year <-"2022"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_N))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_N))
fd_results_knepp_N$block <- blocks
fd_results_knepp_N$plot <- plots
rownames(fd_results_knepp_N) <- NULL

fd_results_knepp_S$site <-"Knepp"
fd_results_knepp_S$year <-"2022"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_S))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_S))
fd_results_knepp_S$block <- blocks
fd_results_knepp_S$plot <- plots
rownames(fd_results_knepp_S) <- NULL


fd_results_knepp_M2023$site <-"Knepp"
fd_results_knepp_M2023$year <-"2023"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_M2023))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_M2023))
fd_results_knepp_M2023$block <- blocks
fd_results_knepp_M2023$plot <- plots
rownames(fd_results_knepp_M2023) <- NULL

fd_results_knepp_N2023$site <-"Knepp"
fd_results_knepp_N2023$year <-"2023"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_N2023))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_N2023))
fd_results_knepp_N2023$block <- blocks
fd_results_knepp_N2023$plot <- plots
rownames(fd_results_knepp_N2023) <- NULL

fd_results_knepp_S2023$site <-"Knepp"
fd_results_knepp_S2023$year <-"2023"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_S2023))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_S2023))
fd_results_knepp_S2023$block <- blocks
fd_results_knepp_S2023$plot <- plots
rownames(fd_results_knepp_S2023) <- NULL


fd_results_knepp_M2024$site <-"Knepp"
fd_results_knepp_M2024$year <-"2024"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_M2024))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_M2024))
fd_results_knepp_M2024$block <- blocks
fd_results_knepp_M2024$plot <- plots
rownames(fd_results_knepp_M2024) <- NULL

fd_results_knepp_N2024$site <-"Knepp"
fd_results_knepp_N2024$year <-"2024"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_N2024))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_N2024))
fd_results_knepp_N2024$block <- blocks
fd_results_knepp_N2024$plot <- plots
rownames(fd_results_knepp_N2024) <- NULL

fd_results_knepp_S2024$site <-"Knepp"
fd_results_knepp_S2024$year <-"2024"
blocks <- gsub("[0-9]", "", rownames(fd_results_knepp_S2024))
plots <- gsub("[^0-9]", "", rownames(fd_results_knepp_S2024))
fd_results_knepp_S2024$block <- blocks
fd_results_knepp_S2024$plot <- plots
rownames(fd_results_knepp_S2024) <- NULL

fd_results_high_fen$site <- "High_fen"
fd_results_high_fen$year <- "2024"
fd_results_high_fen$block <-"NA"
fd_results_high_fen$plot <- rownames(fd_results_high_fen)
rownames(fd_results_high_fen) <- NULL


combined_fd_all <- bind_rows(fd_results_boothby,fd_results_boothby2023, fd_results_boothby2024, fd_results_br,  fd_results_silwood_2021, fd_results_silwood_2022, fd_results_silwood_2023, fd_results_hep_2024, fd_results_hpf2024, fd_results_knepp_M, fd_results_knepp_N, fd_results_knepp_S,fd_results_knepp_M2023, fd_results_knepp_N2023, fd_results_knepp_S2023, fd_results_knepp_M2024, fd_results_knepp_N2024, fd_results_knepp_S2024, fd_results_high_fen)

combined_fd_all <- combined_fd_all %>%
  mutate(age = case_when(
    site == "Knepp" & (block == "SX" | block == "SY" | block == "SZ") & year == 2022 ~ "21",
    site == "Knepp" & (block == "SX" | block == "SY" | block == "SZ") & year == 2023 ~ "22",
    site == "Knepp" & (block == "SX" | block == "SY" | block == "SZ") & year == 2024 ~ "23",
    
    site == "Knepp" & (block == "M" | block == "N") & year == 2022 ~ "18",
    site == "Knepp" & (block == "M" | block == "N") & year == 2023 ~ "19",
    site == "Knepp" & (block == "M" | block == "N") & year == 2024 ~ "20",
    
    site == "Boothby" & year == 2022 ~ "0",
    site == "Boothby" & year == 2023 ~ "1",
    site == "Boothby" & year == 2024 ~ "2",
    
    
    site == "HPF" ~ "0",
    site == "Hepple" ~ "3", site == "High_fen" ~"1",
    
    TRUE ~ "natural"  # All other cases
  ))

combined_fd_all <- combined_fd_all %>%
  mutate(state = case_when(
    (site == "Knepp" & (block %in% c("SX", "SY", "SZ")) & year == 2022) ~ "late",
    (site == "Knepp" & (block %in% c("SX", "SY", "SZ")) & year == 2023) ~ "late",
    (site == "Knepp" & (block %in% c("SX", "SY", "SZ")) & year == 2024) ~ "late",
    
    (site == "Knepp" & (block %in% c("M", "N")) & year == 2022) ~ "late",
    (site == "Knepp" & (block %in% c("M", "N")) & year == 2023) ~ "late",
    (site == "Knepp" & (block %in% c("M", "N")) & year == 2024) ~ "late",
    
    (site == "Boothby" & year == 2022) ~ "early",
    (site == "Boothby" & year == 2023) ~ "early",
    (site == "Boothby" & year == 2024) ~ "early",
    
    (site == "HPF") ~ "early",
    (site == "Hepple") ~ "early", (site=="High_fen")~"early",
    
    TRUE ~ "natural"  # All other cases
  ))

# separate into fd and cwm
common_cols <- c("site", "year", "block", "plot", "age", "state")

combined_cwm_filtered <- combined_fd_all[, grepl("^CWM", colnames(combined_fd_all)) | colnames(combined_fd_all) %in% common_cols]

combined_fd_all_filtered <- combined_fd_all[, !grepl("^CWM", colnames(combined_fd_all))]

write.csv(combined_fd_all_filtered, 'functional_data_final/combined_fd_all_filtered.csv', row.names = FALSE)
write.csv(combined_cwm_filtered, 'functional_data_final/combined_cwm_filtered.csv', row.names = FALSE)

# same for combined tax phylo

# split into tax and phylo
phylo_columns <- c("pd", "ses.mpd", "ses.mntd")
tax_columns <- c("richness", "simpsons","invsimpsons")

# tax_metrics data frame
tax_metrics <- combined_tax_phylo[, !names(combined_tax_phylo) %in% phylo_columns]

# phylo data frame
phylo_metrics <- combined_tax_phylo[, !names(combined_tax_phylo) %in% tax_columns]

# first few rows of each data frame
head(tax_metrics)
head(phylo_metrics)

write.csv(tax_metrics, 'metric_calcs_final/tax_metrics.csv', row.names = FALSE)
write.csv(phylo_metrics, 'metric_calcs_final/phylo_metrics.csv', row.names = FALSE)

```

```{r Loading metric dataframes}

# Read the CSV file into a data frame
combined_fd_all_filtered <- read.csv("functional_data_final/combined_fd_all_filtered.csv")
combined_cwm_filtered <- read.csv("functional_data_final/combined_cwm_filtered.csv")
tax_metrics <- read.csv("metric_calcs_final/tax_metrics.csv")
phylo_metrics <- read.csv("metric_calcs_final/phylo_metrics.csv")


```

```{r Dataframes for stats}
head(combined_fd_all_filtered)
head(combined_cwm_filtered)
head(tax_metrics)
head(phylo_metrics)
```

```{r Correlation matrices of functional diversity metrics and model selection}

combined_fd_all_filtered$FRic[is.na(combined_fd_all_filtered$FRic) & combined_fd_all_filtered$nbsp <= 2] <- combined_fd_all_filtered$FDiv[is.na(combined_fd_all_filtered$FDiv) & combined_fd_all_filtered$nbsp <= 2] <- 0

# correlation matrices
numeric_cols <- sapply(combined_fd_all_filtered, is.numeric)
combined_fd_numeric <- combined_fd_all_filtered[, numeric_cols]
combined_fd_numeric[is.na(combined_fd_numeric)] <- 0
# remove evenness as not good for low spp richness, and remove RaoQ and FDis as per literature
combined_fd_numeric <- combined_fd_numeric[, !colnames(combined_fd_numeric) %in% c("nbsp", "sing.sp", "year","plot","qual.FRic", "FEve","RaoQ","FDis")]

cor_matrix <- cor(combined_fd_numeric)
print(cor_matrix)
highly_correlated <- findCorrelation(cor_matrix, cutoff = 0.7)
highly_correlated # all good

# run models 

# change na blocks to missing
combined_fd_all_filtered$block[is.na(combined_fd_all_filtered$block)] <- "Missing"

# format all variables so correct
combined_fd_all_filtered$state <- as.factor(combined_fd_all_filtered$state)
combined_fd_all_filtered$plot <- as.factor(combined_fd_all_filtered$plot)
combined_fd_all_filtered$site <- as.factor(combined_fd_all_filtered$site)
combined_fd_all_filtered$block <- as.factor(combined_fd_all_filtered$block)
combined_fd_all_filtered$year <- as.factor(combined_fd_all_filtered$year)

combined_fd_all_filtered$log_fdiv <- log(combined_fd_all_filtered$FDiv + 1)
#combined_fd_all_filtered <- combined_fd_all_filtered[!is.na(combined_fd_all_filtered$log_fdiv) & 
 #                                                      !is.nan(combined_fd_all_filtered$log_fdiv) & 
  #                                                     !is.infinite(combined_fd_all_filtered$log_fdiv), ]


fdiv1 <- lm(FDiv ~ state, data = combined_fd_all_filtered, REML = T) # just fixed 

fdiv2 <- lmer(FDiv ~ state + (1|site), data = combined_fd_all_filtered, REML = T)

lrtest(fdiv1,fdiv2) # p < 0.05 so model 2 better  

fdiv3 <- lmer(FDiv ~ state + (1|year), data = combined_fd_all_filtered, REML = T)

lrtest(fdiv2,fdiv3) # model 3 better  

fdiv4 <- lmer(FDiv ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = T)

lrtest(fdiv3,fdiv4) # model 4 better , marginal 

fdiv5 <- lmer(FDiv ~ state + (1|site/block), data = combined_fd_all_filtered, REML = T)

lrtest(fdiv4,fdiv5) # model 4

fdiv6 <- lmer(FDiv ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=T) 

lrtest(fdiv4,fdiv6) # model 4, very marginal - check summaries   


lrtest(fdiv4, fdiv1) # model 4 
lrtest(fdiv6,fdiv2) # 6
lrtest(fdiv6,fdiv3) # v marginal
lrtest(fdiv6,fdiv4) # v marginal 
lrtest(fdiv1,fdiv3) # 3 better 

fdiv3 <- lmer(FDiv ~ state + (1|year), data = combined_fd_all_filtered, REML = F)
null_fdiv <- lmer(FDiv ~ (1 | year), data=combined_fd_all_filtered, REML = F)
lrtest(fdiv3, null_fdiv) # final model better

fdiv4 <- lmer(FDiv ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = F) # sfit
null_fdiv <- lmer(FDiv ~ (1 | year) + (1|site/block), data=combined_fd_all_filtered, REML = F)
lrtest(fdiv4, null_fdiv) # final model better

fdiv6 <- lmer(FDiv ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=F) 
null_fdiv <- lmer(FDiv ~ (1 | year) + (1|site), data=combined_fd_all_filtered, REML = F)
lrtest(fdiv6, null_fdiv) # final model better - this is final model

# diagnostics
residuals <- resid(fdiv6)
fitted_values <- fitted(fdiv6)

hist(fitted_values, breaks = 20, main = "Distribution of Fitted Values", xlab = "Fitted Values")

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(fdiv6))
qqline(residuals(fdiv6))

sum(cooks.distance(fdiv6)>1)
cooksd <- cooks.distance(fdiv6)
plot(cooksd, type = "h", ylab = "Cook's Distance", main = "Cook's Distance Plot")
abline(h = 4 / nrow(combined_fd_all_filtered), col = "red")
# all good

# FRic

fric1 <- lm(FRic ~ state, data = combined_fd_all_filtered, REML = T) # just fixed 

fric2 <- lmer(FRic ~ state + (1|site), data = combined_fd_all_filtered, REML = T)

lrtest(fric1,fric2) # p > 0.05 so model 1 better 

fric3 <- lmer(FRic ~ state + (1|year), data = combined_fd_all_filtered, REML = T)

lrtest(fric1,fric3) # again no better than model 1 

fric4 <- lmer(FRic ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = T)
summary(fric4) # year explains no variation

lrtest(fric1,fric4) # no difference so simpler model, model 1, is better

fric5 <- lmer(FRic ~ state + (1|site/block), data = combined_fd_all_filtered, REML = T)
summary(fric5) # site explains no variation 

lrtest(fric1,fric5) # model 1

fric6 <- lmer(FRic ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=T) 
summary(fric6) # site no variation 

lrtest(fric1,fric6) # 1 better 

fric1 <- lm(FRic ~ state, data = combined_fd_all_filtered) # just fixed is final 
null_fric <- lm(FRic ~ 1, data=combined_fd_all_filtered)
lrtest(fric1, null_fric) # final model is better 


# diagnostics
residuals <- resid(fric1)
fitted_values <- fitted(fric1)

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(fric1))
qqline(residuals(fric1))

sum(cooks.distance(fric1)>1)

# Cook's Distance
cooks_d <- cooks.distance(fric1)

plot(cooks_d, type = "h", main = "Cook's Distance", ylab = "Cook's Distance")
abline(h = 4 / length(cooks_d), col = "red", lty = 2)  # Threshold line
# not great
# try log fric

# log fric
combined_fd_all_filtered$log_fric <- log(combined_fd_all_filtered$FRic + 1)

fric1l <- lm(log_fric ~ state, data = combined_fd_all_filtered, REML = T) # just fixed 

fric2l <- lmer(log_fric ~ state + (1|site), data = combined_fd_all_filtered, REML = T)

lrtest(fric1l,fric2l) # p > 0.05 so model 1 better 

fric3l <- lmer(log_fric ~ state + (1|year), data = combined_fd_all_filtered, REML = T)

lrtest(fric1l,fric3l) # again no better than model 1 

fric4l <- lmer(log_fric ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = T)
summary(fric4l) 

lrtest(fric1l,fric4l) # model 4 better, p <0.05 
lrtest(fric4l,fric3l) # 4

fric5l <- lmer(log_fric ~ state + (1|site/block), data = combined_fd_all_filtered, REML = T)

lrtest(fric4l,fric5l) # model 4 better 

fric6l <- lmer(log_fric ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=T) 

lrtest(fric4l,fric6l) # 4 better  

fric4l <- lmer(log_fric ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = F)
null_fricl <- lmer(FRic ~ (1 | year) + (1|site/block), data=combined_fd_all_filtered, REML = F)
lrtest(fric4l, null_fricl) # final model is better 

# diagnostics
residuals <- resid(fric4l)
fitted_values <- fitted(fric4l)

# diags
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(fric4l))
qqline(residuals(fric4l))

sum(cooks.distance(fric4l)>1)

# Cook's Distance
cooks_d <- cooks.distance(fric4l)

plot(cooks_d, type = "h", main = "Cook's Distance", ylab = "Cook's Distance")
abline(h = 4 / length(cooks_d), col = "red", lty = 2)  # Threshold line

# better - fric4l is final model
```

```{r Correlation matrices of taxonomic diversity metrics and model selection (simpsons)}

# clean state
unique(tax_metrics$state)
tax_metrics$state <- trimws(tax_metrics$state)

# correlation matrices
numeric_cols3 <- sapply(tax_metrics, is.numeric)
tax_numeric <- tax_metrics[, numeric_cols3]
tax_numeric[is.na(tax_numeric)] <- 0
tax_numeric <- tax_numeric[, !colnames(tax_numeric) %in% c("year", "rewilding_age", "invsimpsons")]

cor_matrix <- cor(tax_numeric)
print(cor_matrix)
highly_correlated <- findCorrelation(cor_matrix, cutoff = 0.7)
highly_correlated

# choose simpsons

# simpsons models 
# format variables correctly
tax_metrics$state <- as.factor(tax_metrics$state)
tax_metrics$site <- as.factor(tax_metrics$site)
tax_metrics$year <- as.factor(tax_metrics$year)
tax_metrics$block[is.na(tax_metrics$block)] <- "Missing"
tax_metrics$block <- as.factor(tax_metrics$block)
tax_metrics$plot <- as.factor(tax_metrics$plot)

model1 <- lm(simpsons ~ state, data = tax_metrics)
summary(model1) # just fixed effects  

model1b <- lmer(simpsons ~ state + (1 | site), data = tax_metrics, REML=TRUE) # s fit 
summary(model1b) # site explains no variation  

lrtest(model1,model1b) # 1b better

model4 <- lmer(simpsons ~ state + (1 | year), data = tax_metrics, REML = T)
summary(model4)

lrtest(model1b,model4) # 4 better

model5c <- lmer(simpsons ~ state + (1 | year) + (1|site/block), data = tax_metrics, REML = T)
summary(model5c)

model5d <- lmer(simpsons ~ state + (1|site/block), data = tax_metrics,REML=T)
summary(model5d) # s fit

model7 <- lmer(simpsons ~ state + (1 | year) + (1 | site), data = tax_metrics, REML=T) # best model 
summary(model7)

lrtest(model4, model5c) # 5c
lrtest(model5c,model5d) # 5c
lrtest(model5c,model7) # 5c

# final model 
model5c <- lmer(simpsons ~ state + (1 | year) + (1|site/block), data = tax_metrics, REML = F)
summary(model5c)
null <- lmer(simpsons ~ 1+(1 | year) + (1|site/block), data = tax_metrics,REML=F)
lrtest(model5c,null) # final model better than null 

# diagnostics
residuals <- resid(model5c)
fitted_values <- fitted(model5c)

par(mfrow=c(1,1))
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(model5c))
qqline(residuals(model5c))

# cooks
sum(cooks.distance(model5c)>1)
# diags ok
```

```{r Correlation matrices of phylogenetic metrics and model selection}

# correlation matrices
numeric_cols4 <- sapply(phylo_metrics, is.numeric)
phylo_numeric <- phylo_metrics[, numeric_cols4]
phylo_numeric[is.na(phylo_numeric)] <- 0
phylo_numeric <- phylo_numeric[, !colnames(phylo_numeric) %in% c("year", "rewilding_age")]

cor_matrix <- cor(phylo_numeric)
print(cor_matrix)
highly_correlated <- findCorrelation(cor_matrix, cutoff = 0.7)
highly_correlated

# choose mpd 
phylo_numeric <- phylo_numeric[, !colnames(phylo_numeric) %in% c("ses.mntd")]
cor_matrix <- cor(phylo_numeric)
print(cor_matrix)
highly_correlated <- findCorrelation(cor_matrix, cutoff = 0.7)
highly_correlated

# format variables
phylo_metrics$block[is.na(phylo_metrics$block)] <- "Missing"
phylo_metrics$state <- as.factor(phylo_metrics$state)
phylo_metrics$block <- as.factor(phylo_metrics$block)
phylo_metrics$site <- as.factor(phylo_metrics$site)
phylo_metrics$year <- as.factor(phylo_metrics$year)
phylo_metrics$plot <- as.factor(phylo_metrics$plot)

# models
mpd1 <- lm(ses.mpd ~ state, data = phylo_metrics, REML = T) # just fixed 

mpd2 <- lmer(ses.mpd ~ state + (1|site), data = phylo_metrics, REML = T)

lrtest(mpd1,mpd2) # p <0.05 so model 2 better

mpd3 <- lmer(ses.mpd ~ state + (1|year), data = phylo_metrics, REML = T)

lrtest(mpd2,mpd3) # significant difference and loglik for model 2 better, so choose model 2

mpd4 <- lmer(ses.mpd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = T)
summary(mpd4)

lrtest(mpd2,mpd4) # model 4

mpd5 <- lmer(ses.mpd ~ state + (1|site/block), data = phylo_metrics, REML = T)
summary(mpd5) 

lrtest(mpd4,mpd5) # model 4 slightly 

mpd6 <- lmer(ses.mpd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=T) 
summary(mpd6) 

lrtest(mpd4,mpd6) # 4 

# final model
mpd4 <- lmer(ses.mpd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = F)
null_mpd <- lmer(ses.mpd ~ (1 | year) + (1|site/block), data=phylo_metrics, REML = F)
lrtest(mpd4, null_mpd) # says null is better 
summary(null_mpd)
summary(mpd4)

# diagnostics
residuals <- resid(mpd4)
fitted_values <- fitted(mpd4)

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(mpd5))
qqline(residuals(mpd5))

sum(cooks.distance(mpd5)>1)
# diags ok


# PD models 

pd1 <- lm(pd ~ state, data = phylo_metrics, REML = T) # just fixed 

pd2 <- lmer(pd ~ state + (1|site), data = phylo_metrics, REML = T)

lrtest(pd1,pd2) # significant difference, more complex model better, model 2

pd3 <- lmer(pd ~ state + (1|year), data = phylo_metrics, REML = T)

lrtest(pd2,pd3) # significant difference and loglik for model 3 better, so choose model 3

pd4 <- lmer(pd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = T)

lrtest(pd3,pd4) # significant, pd4 better

pd5 <- lmer(pd ~ state + (1|site/block), data = phylo_metrics, REML = T)

lrtest(pd4,pd5) # significant, pd4 better

pd6 <- lmer(pd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=T) 

lrtest(pd4,pd6) # 4 better 

pd7 <- lmer(pd ~ state + (1|site:block), data = phylo_metrics, REML = T)

lrtest(pd4,pd7) # 4 better
lrtest(pd4,pd2) # 4

pd4 <- lmer(pd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = F) # s fit 
null_pd <- lmer(pd ~ (1 | year) + (1|site/block), data=phylo_metrics, REML = F)
lrtest(pd4, null_pd) # final model better 

summary(pd4)

# diagnostics
residuals <- resid(pd4)
fitted_values <- fitted(pd4)

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 100, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(pd4))
qqline(residuals(pd4))

sum(cooks.distance(pd4)>1)
# ok 

# log PD
phylo_metrics$log_pd <- log(phylo_metrics$pd +1)

pd1l <- lm(log_pd ~ state, data = phylo_metrics, REML = T) # just fixed 

pd2l <- lmer(log_pd ~ state + (1|site), data = phylo_metrics, REML = T)

lrtest(pd1l,pd2l) # significant difference, more complex model better, model 2, slightly 

pd3l <- lmer(log_pd ~ state + (1|year), data = phylo_metrics, REML = T)

lrtest(pd2l,pd3l) # significant difference and loglik for model 3 better, so choose model 3

pd4l <- lmer(log_pd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = T) # sfit 

lrtest(pd3l,pd4l) # pd 4  

pd5l <- lmer(log_pd ~ state + (1|site/block), data = phylo_metrics, REML = T)

lrtest(pd4l,pd5l) # 4 better 

pd6l <- lmer(log_pd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=T) 

lrtest(pd4l,pd6l) # 4 better 

lrtest(pd6l,pd3l) # 6 better 
lrtest(pd6l,pd1l) # 6

# look at model 4 and 6
pd4l <- lmer(log_pd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = F) # sfit 
summary(pd4l)

pd6l <- lmer(log_pd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=F) 
null_pdl <- lmer(log_pd ~ (1 | year) + (1 | site), data=phylo_metrics, REML = F)
lrtest(pd6l, null_pdl) # final model better 
summary(pd6l)

# model 6 final as model 4 singular fit error

# diagnostics
residuals <- resid(pd6l)
fitted_values <- fitted(pd6l)
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

qq_plot <- qqnorm(residuals(pd6l))
qqline(residuals(pd6l))

sum(cooks.distance(pd6l)>1)
# diags ok - this is final pd model

```

```{r Final models}

# ALL SITES 

tax_metrics$state <- trimws(tax_metrics$state)
tax_metrics$block[is.na(tax_metrics$block)] <- "Missing"
tax_metrics$state <- as.factor(tax_metrics$state)
tax_metrics$year <- as.factor(tax_metrics$year)
tax_metrics$block <- as.factor(tax_metrics$block)
tax_metrics$site <- as.factor(tax_metrics$site)
tax_metrics$plot <- as.factor(tax_metrics$plot)

# SIMPSONS
model5c <- lmer(simpsons ~ state + (1 | year) + (1|site/block), data = tax_metrics, REML = F) 
summary(model5c)
null <- lmer(simpsons ~ 1+(1 | year) + (1|site/block)-1, data = tax_metrics,REML=F)
lrtest(model5c,null) # final model better than null 

# r sq
r_squared <- r.squaredGLMM(model5c)
print(r_squared)

# difference between late and natural - rerun with natural as reference level
tax_metrics$state <- relevel(tax_metrics$state, ref = "natural")
model5c_nat <- lmer(simpsons ~ state + (1 | year) + (1|site/block), data = tax_metrics, REML = F)
summary(model5c_nat)


# variation explained by random
# block:site
(0.006166 / (0.006166 +0.002693+ 0.015735+ 0.061359) )*100 #7.173688
# site
(0.002693 / (0.006166 +0.002693+ 0.015735+ 0.061359) )*100 # 3.133108
# year 
(0.015735 / (0.006166 +0.002693+ 0.015735+ 0.061359) )*100 # 18.30652
# residual 
(0.061359 / (0.006166 +0.002693+ 0.015735+ 0.061359) )*100 # 71.38669

# diagnostics
residuals <- resid(model5c)
fitted_values <- fitted(model5c)

par(mfrow=c(1,1))
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

# MPD
phylo_metrics$block[is.na(phylo_metrics$block)] <- "Missing"
phylo_metrics$state <- as.factor(phylo_metrics$state)
phylo_metrics$block <- as.factor(phylo_metrics$block)
phylo_metrics$site <- as.factor(phylo_metrics$site)
phylo_metrics$plot <- as.factor(phylo_metrics$plot)
phylo_metrics$year <- as.factor(phylo_metrics$year)


mpd4 <- lmer(ses.mpd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = F)
null_mpd <- lmer(ses.mpd ~  (1 | year) + (1|site/block), data=phylo_metrics, REML = F)
lrtest(mpd4, null_mpd) # says null is better 
summary(null_mpd)
summary(mpd4)

# variance explained by random
# block:site
(0.15649      / (0.15649    +  0.05798      +0.03585     + 1.20713      ))*100 # 10.74
# site
(0.05798      / (0.15649    +  0.05798      +0.03585     + 1.20713      ))*100 # 3.98
# year
(0.03585      / (0.15649    +  0.05798      +0.03585     + 1.20713      ))*100 # 2.46
# residual 
(1.20713      / (0.15649    +  0.05798      +0.03585     + 1.20713      ))*100

r_squared <- r.squaredGLMM(mpd4)
print(r_squared)

# diff bw late and natural
phylo_metrics$state <- relevel(phylo_metrics$state, ref = "natural ") 
mpd4_nat <- lmer(ses.mpd ~ state + (1 | year) + (1|site/block), data = phylo_metrics, REML = F)
summary(mpd4_nat)

# diagnostics
residuals <- resid(mpd4)
fitted_values <- fitted(mpd4)

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")


# PD
# since reference level gets changed above need to rerun phylo_metrics
phylo_metrics <- read.csv("metric_calcs_final/phylo_metrics.csv")
phylo_metrics$state <- as.factor(phylo_metrics$state)
phylo_metrics$block[is.na(phylo_metrics$block)] <- "Missing"
phylo_metrics$block <- as.factor(phylo_metrics$block)
phylo_metrics$plot <- as.factor(phylo_metrics$plot)
phylo_metrics$site <- as.factor(phylo_metrics$site)
phylo_metrics$year <- as.factor(phylo_metrics$year)
phylo_metrics$log_pd <- log(phylo_metrics$pd +1)

pd6l <- lmer(log_pd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=F)  
null_pdl <- lmer(log_pd ~ (1 | year) + (1 | site), data=phylo_metrics, REML = F)
lrtest(pd6l, null_pdl) # final model better 
summary(pd6l)

# variance explained by random
# site
(0.02579    / (0.02579    +0.06289   +0.41399   ))*100
# year
(0.06289    / (0.02579    +0.06289   +0.41399   ))*100
# residual
(0.41399    / (0.02579    +0.06289   +0.41399   ))*100

r_squared <- r.squaredGLMM(pd6l)
print(r_squared)

# change reference level
phylo_metrics$state <- relevel(phylo_metrics$state, ref = "natural ")
pd6l_nat <- lmer(log_pd ~ state + (1 | year) + (1 | site), data = phylo_metrics, REML=F) 
summary(pd6l_nat)

# diagnostics
residuals <- resid(pd6l)
fitted_values <- fitted(pd6l)
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

# FDIV
combined_fd_all_filtered$FRic[is.na(combined_fd_all_filtered$FRic) & combined_fd_all_filtered$nbsp <= 2] <- combined_fd_all_filtered$FDiv[is.na(combined_fd_all_filtered$FDiv) & combined_fd_all_filtered$nbsp <= 2] <- 0
combined_fd_all_filtered$state <- as.factor(combined_fd_all_filtered$state)
combined_fd_all_filtered$block[is.na(combined_fd_all_filtered$block)] <- "Missing"
combined_fd_all_filtered$block <- as.factor(combined_fd_all_filtered$block)
combined_fd_all_filtered$plot <- as.factor(combined_fd_all_filtered$plot)
combined_fd_all_filtered$site <- as.factor(combined_fd_all_filtered$site)
combined_fd_all_filtered$year <- as.factor(combined_fd_all_filtered$year)

fdiv6 <- lmer(FDiv ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=F) 
null_fdiv <- lmer(FDiv ~ (1 | year) + (1 | site), data=combined_fd_all_filtered, REML = F)
lrtest(fdiv6, null_fdiv) # final model better - best
summary(fdiv6)


# variance explained by random effects 
# site 
(0.001403 /(0.001403 +0.009820 +0.086821 ))*100
# year
(0.009820  /(0.001403 +0.009820 +0.086821 ))*100

r_squared <- r.squaredGLMM(fdiv6)
print(r_squared)


# diff bw late and natural
combined_fd_all_filtered$state <- relevel(combined_fd_all_filtered$state, ref = "natural")
fdiv6_nat <- lmer(FDiv ~ state + (1 | year) + (1 | site), data = combined_fd_all_filtered, REML=F) 
summary(fdiv6_nat)

# diagnostics
residuals <- resid(fdiv6)
fitted_values <- fitted(fdiv6)

ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

# FRIC
# need to rerun as reference changed
combined_fd_all_filtered <- read.csv("functional_data_final/combined_fd_all_filtered.csv")
combined_fd_all_filtered$FRic[is.na(combined_fd_all_filtered$FRic) & combined_fd_all_filtered$nbsp <= 2] <- combined_fd_all_filtered$FDiv[is.na(combined_fd_all_filtered$FDiv) & combined_fd_all_filtered$nbsp <= 2] <- 0
combined_fd_all_filtered$log_fric <- log(combined_fd_all_filtered$FRic + 1)
combined_fd_all_filtered$state <- as.factor(combined_fd_all_filtered$state)
combined_fd_all_filtered$block[is.na(combined_fd_all_filtered$block)] <- "Missing"
combined_fd_all_filtered$block <- as.factor(combined_fd_all_filtered$block)
combined_fd_all_filtered$plot <- as.factor(combined_fd_all_filtered$plot)
combined_fd_all_filtered$site <- as.factor(combined_fd_all_filtered$site)
combined_fd_all_filtered$year <- as.factor(combined_fd_all_filtered$year)

fric4l <- lmer(log_fric ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = F)
null_fricl <- lmer(FRic ~ (1 | year) + (1|site/block), data=combined_fd_all_filtered, REML = F)
lrtest(fric4l, null_fricl) # final model is better 
summary(fric4l)

# random 
# block site
(0.020401  / (0.020401 +0.005984 +0.021462 +0.286009 ))*100
# site
(0.005984   / (0.020401 +0.005984 +0.021462 +0.286009 ))*100
# year
(0.021462 / (0.020401 +0.005984 +0.021462 +0.286009 ))*100
# residual
(0.286009  / (0.020401 +0.005984 +0.021462 +0.286009 ))*100

r_squared <- r.squaredGLMM(fric4l)
print(r_squared)

# diff bw late and natural
combined_fd_all_filtered$state <- relevel(combined_fd_all_filtered$state, ref = "natural")
fric4l_nat <- lmer(log_fric ~ state + (1 | year) + (1|site/block), data = combined_fd_all_filtered, REML = F)
summary(fric4l_nat)

# diagnostics
residuals <- resid(fric4l)
fitted_values <- fitted(fric4l)

# diags
ggplot(data.frame(fitted = fitted_values, residuals = residuals), aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted Values",
       x = "Fitted Values",
       y = "Residuals")

# Plot residuals histogram
ggplot(data.frame(residuals = residuals), aes(x = residuals)) +
  geom_histogram(binwidth = 0.1, fill = "blue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Histogram of Residuals",
       x = "Residuals",
       y = "Frequency")

```

```{r Simpsons boxplot for report}

plot.new()
# simpsons
tax_metrics <- read.csv("metric_calcs_final/tax_metrics.csv")

# set margin line parameters
par(mgp = c(3, 1.5, 0))  

# viridis colours
viridis_palette <- viridis(4, option = "viridis") 

# define factor levels and labels
tax_metrics$state <- factor(tax_metrics$state, 
                            levels = c("early ", "late ", "natural "), 
                            labels = c("Early", "Late", "Natural"))

# create vector for colors
color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

# ensure factor levels are correctly mapped
tax_metrics$state <- factor(tax_metrics$state, 
                            levels = c("Early", "Late", "Natural"))

png("report_plots/boxplot_simpsons.png", width = 800, height = 600, res = 100)

# boxplot
boxplot(simpsons ~ state, data = tax_metrics, 
        col = color_mapping[levels(tax_metrics$state)], 
        ylab = "Simpson's Diversity Index", 
        xlab = "State",
        outline = FALSE,
        cex.axis = 1,   
        cex.lab = 1.2)  

dev.off()

# saved

```

```{r MPD boxplot for report}

# above repeated for all other plots
plot.new()

phylo_metrics <- read.csv("metric_calcs_final/phylo_metrics.csv")

par(mar = c(5, 3, 4, 2))  

viridis_palette <- viridis(4, option = "viridis")

phylo_metrics$state <- factor(phylo_metrics$state, 
                              levels = c("early ", "late ", "natural "), 
                              labels = c("Early", "Late", "Natural"))

color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

phylo_metrics$state <- factor(phylo_metrics$state, 
                              levels = c("Early", "Late", "Natural"))

png("report_plots/boxplot_mpd.png", width = 800, height = 600, res = 100)

boxplot(ses.mpd ~ state, data = phylo_metrics, 
        col = color_mapping[levels(phylo_metrics$state)],  
        ylab = expression(SES[MPD]),  
        xlab = "State",
        outline = FALSE,
        cex.axis = 1.4,   
        cex.lab = 1.6) 

dev.off()
```

```{r PD boxplot for report}

plot.new()

phylo_metrics$log_pd <- log(phylo_metrics$pd +1)

par(mgp = c(3, 1.5, 0))  

viridis_palette <- viridis(4, option = "viridis") 

color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

phylo_metrics$state <- factor(phylo_metrics$state, 
                              levels = c("Early", "Late", "Natural"))

png("report_plots/boxplot_pd.png", width = 800, height = 600, res = 100)

boxplot(log_pd ~ state, data = phylo_metrics, 
        col = color_mapping[levels(phylo_metrics$state)], 
        ylab = "Log PD",  
        xlab = "State",
        outline = FALSE,
        cex.axis = 1.4,   
        cex.lab = 1.6)  

dev.off()

```

```{r FRic boxplot for report}

plot.new()

combined_fd_all_filtered <- read.csv("functional_data_final/combined_fd_all_filtered.csv")

# format functional metrics correctly as in models 
combined_fd_all_filtered$FRic[is.na(combined_fd_all_filtered$FRic) & combined_fd_all_filtered$nbsp <= 2] <- combined_fd_all_filtered$FDiv[is.na(combined_fd_all_filtered$FDiv) & combined_fd_all_filtered$nbsp <= 2] <- 0

combined_fd_all_filtered$log_fric <- log(combined_fd_all_filtered$FRic + 1)

par(mgp = c(3, 1.5, 0))  

viridis_palette <- viridis(4, option = "viridis") 

combined_fd_all_filtered$state <- factor(combined_fd_all_filtered$state, 
                              levels = c("early", "late", "natural"), 
                              labels = c("Early", "Late", "Natural"))

color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

combined_fd_all_filtered$state <- factor(combined_fd_all_filtered$state, 
                              levels = c("Early", "Late", "Natural"))

png("report_plots/boxplot_fric.png", width = 800, height = 600, res = 100)

boxplot(log_fric ~ state, data = combined_fd_all_filtered, 
        col = color_mapping[levels(combined_fd_all_filtered$state)],  # Use color mapping directly
        ylab = "Log FRic",  
        xlab = "State",
        outline = FALSE,
        cex.axis = 1.4,   
        cex.lab = 1.6)  

dev.off()

```

```{r FDiv boxplot for report}

plot.new()

combined_fd_all_filtered <- read.csv("functional_data_final/combined_fd_all_filtered.csv")

combined_fd_all_filtered$FRic[is.na(combined_fd_all_filtered$FRic) & combined_fd_all_filtered$nbsp <= 2] <- combined_fd_all_filtered$FDiv[is.na(combined_fd_all_filtered$FDiv) & combined_fd_all_filtered$nbsp <= 2] <- 0


par(mgp = c(3, 1.5, 0))  

viridis_palette <- viridis(4, option = "viridis")  

combined_fd_all_filtered$state <- factor(combined_fd_all_filtered$state, 
                              levels = c("early", "late", "natural"), 
                              labels = c("Early", "Late", "Natural"))

color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

combined_fd_all_filtered$state <- factor(combined_fd_all_filtered$state, 
                              levels = c("Early", "Late", "Natural"))

png("report_plots/boxplot_fdiv.png", width = 800, height = 600, res = 100)

boxplot(FDiv ~ state, data = combined_fd_all_filtered, 
        col = color_mapping[levels(combined_fd_all_filtered$state)], 
        ylab = "FDiv",  
        xlab = "State",
        outline = FALSE,
        cex.axis = 1.4,  
        cex.lab = 1.6) 

dev.off()

```

```{r Map}

# create dataframe of sites and their locations
site_names <- c("Knepp", "Boothby", "Hepple", "High Fen", "Harold's Park", "Silwood", "Budworth")
latitude <- c(50.9834, 52.9943, 55.286076, 52.52024, 51.72085, 51.4092, 53.2719)
longitude <- c(-0.3547, -0.5514, -2.023284, 0.47659, 0.04373, -0.6415, -2.5165)  
sites_df <- data.frame(Site = site_names, Latitude = latitude, Longitude = longitude)

# load base maps
ne_110 <- st_read('ecofrac-rawdata/ne_110m_admin_0_countries/ne_110m_admin_0_countries.shp')
ne_10 <- st_read('ecofrac-rawdata/ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp')

# subset and transform data to UK
uk <- subset(ne_10, ADMIN %in% c('United Kingdom'))
uk <- st_transform(uk, crs = 4326)  # transform to WGS84 (latitude/longitude)

# set latitude and longitude limits and custom breaks
lon_limits <- c(-9, 2)
lat_limits <- c(49, 61)
lat_breaks <- seq(49, 61, by = 1)
lon_breaks <- seq(-9, 2, by = 1)

# function for adding degrees N, S, E, W
format_longitude_labels <- function(x) {
  labels <- ifelse(x < 0, paste0(-x, "W"), paste0(x, "E"))
 return(labels)
}
format_latitude_labels <- function(x) {
 labels <- paste0(x, "N")
  return(labels)
}


# colour code based on state of site 
sites_df <- sites_df %>%
  mutate(color_group = case_when(
    Site %in% c("Silwood", "Budworth") ~ "Natural", # natural
    Site == "Knepp" ~ "Late",# late
    TRUE ~ "Early" # rest are group 3 
  ))

# viridis palette
viridis_palette <- viridis(4, option = "viridis")  # same colouring as boxplots

# define color mapping based on above sites 
color_mapping <- c("Early" = viridis_palette[2], 
                    "Late" = viridis_palette[3], 
                    "Natural" = viridis_palette[4])

# map
map2coloured <- ggplot(data = uk) +
  geom_sf(fill = "lightgrey", color = "black") + 
  geom_point(data = sites_df, aes(x = Longitude, y = Latitude, color = color_group), size = 2, shape = 16) +
  scale_color_manual(values = color_mapping, 
                     labels = c("Early", "Late", "Natural")) +  # use the specified colors
  labs(color = "State") +  # legend title
  theme_minimal() + 
  theme(
    axis.line = element_line(color = "black"),  
    axis.text = element_text(color = "black", size = 10),  
    axis.title = element_text(color = "black", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.text = element_text(size = 10), 
    legend.title = element_text(size = 12), 
    panel.grid.major = element_line(color = "darkgrey", linewidth = 0.5, linetype = "dashed"),
    panel.grid.minor = element_line(color = "darkgrey", linewidth = 0.25, linetype = "dashed"),
    panel.background = element_rect(fill = NA),  
    plot.margin = margin(1, 1, 1, 1, "cm"),
    panel.ontop = TRUE 
  ) +
  xlab("Longitude") +
  ylab("Latitude") +
  scale_x_continuous(
    breaks = lon_breaks, 
    labels = format_longitude_labels
  ) +
  scale_y_continuous(
    breaks = lat_breaks, 
    labels = format_latitude_labels
  ) +
  coord_sf(xlim = lon_limits, ylim = lat_limits, expand = FALSE)  

# print map
print(map2coloured)

#ggsave(filename = "report_plots/map2coloured_nolabs_upd.png", plot = map2coloured, width = 10, height = 8, units = #"in", dpi = 800, bg = "white")

```

```{r Random things for write up}

# how many total plots analysed
  unique_plots <- combined_fd_all_filtered %>%
  distinct(site, block, plot,year) %>%
  count()

print(unique_plots)

# mean and SD of metrics by state 
tax_metrics_stats_by_state <- tax_metrics %>%
  group_by(state) %>%
  summarise(
    mean_simpsons = mean(simpsons, na.rm = TRUE),
    sd_simpsons = sd(simpsons, na.rm = TRUE)
  )

print(tax_metrics_stats_by_state)

phylo_metrics_stats_by_state <- phylo_metrics %>%
  group_by(state) %>%
  summarise(
    mean_ses_mpd = mean(ses.mpd, na.rm = TRUE),
    sd_ses_mpd = sd(ses.mpd, na.rm = TRUE),
    mean_pd = mean(log_pd, na.rm = TRUE),
    sd_pd = sd(log_pd, na.rm = TRUE)
  ) %>%
  mutate(
    mean_ses_mpd = sprintf("%.3f", mean_ses_mpd),
    sd_ses_mpd = sprintf("%.3f", sd_ses_mpd),
    mean_pd = sprintf("%.3f", mean_pd),
    sd_pd = sprintf("%.3f", sd_pd)
  )

print(phylo_metrics_stats_by_state, digits = 6)

fd_stats_state <- combined_fd_all_filtered %>%
  group_by(state) %>%
  summarise(
    mean_FDiv = mean(FDiv, na.rm = TRUE),
    sd_FDiv = sd(FDiv, na.rm = TRUE),
    mean_FRic = mean(log_fric, na.rm = TRUE),
    sd_FRic = sd(log_fric, na.rm = TRUE)
  ) %>%
  mutate(
    mean_FDiv = sprintf("%.3f", mean_FDiv),
    sd_FDiv = sprintf("%.3f", sd_FDiv),
    mean_FRic = sprintf("%.3f", mean_FRic),
    sd_FRic = sprintf("%.3f", sd_FRic)
  )

fd_stats_state


```
